#export NAME="UPower"
#export STATUS=
#export URL=http://upower.freedesktop.org/
#export BASENAME=upower
#export DESCRIPTION="UPower is an abstraction for enumerating power devices, listening to device events and querying history and statistics. Any application or service on the system can access the org.freedesktop.UPower service via the system message bus."
#export CATEGORY=hardware
#export TYPE=library
##export VERSION=0.9.7
##export VERSIONDATE=20101117
##export VERSION=0.9.8
##export VERSIONDATE=20110107
##export VERSION=0.9.9
##export VERSIONDATE=20110321
##export VERSION=0.9.10
##export VERSIONDATE=20110504
##export VERSION=0.9.11
##export VERSIONDATE=20110525
##export VERSION=0.9.14
##export VERSIONDATE=20111126
##export VERSION=0.9.15
##export VERSIONDATE=20111205
##export VERSION=0.9.16
##export VERSIONDATE=20120430
##export VERSION=0.9.17
##export VERSIONDATE=20120625
##export VERSION=0.9.18
##export VERSIONDATE=20120808
##export VERSION=0.9.19
##export VERSIONDATE=20130102
##export VERSION=0.9.20
##export VERSIONDATE=20130318
##export VERSION=0.9.21
##export VERSIONDATE=20130726
##export VERSION=0.9.22
##export VERSIONDATE=20131008
##export VERSION=0.9.23
##export VERSIONDATE=20131018
##export VERSION=0.99.0
##export VERSIONDATE=20131029
##export VERSION=0.99.1
##export VERSIONDATE=20140818
#####No package 'gio-unix-2.0' found
##export VERSION=0.99.2
##export VERSIONDATE=20141218
##export VERSION=0.99.3
##export VERSIONDATE=20150528
##export VERSION=0.99.4
##export VERSIONDATE=20160406
##export VERSION=0.99.5
##export VERSIONDATE=20170724
##export VERSION=0.99.6
##export VERSIONDATE=20170912
##export VERSION=0.99.7
##export VERSIONDATE=20171128
#export VERSION=0.99.11
#export VERSIONDATE=20190903
#wl-showstatus --package-version
#export DEPENDANCIES=glib2,dbus,polkit
#export OPTIONALDEPENDANCIES=
#export BUILDDEPENDANCIES=
#export LICENSEFILE=COPYING
#export LICENSETYPE=GPL
#export DOWNLOADURL="http://upower.freedesktop.org/releases/"
#export INSTALLPREFIX=`pwd`/inst_$BASENAME-$VERSION
##export DOWNLOADSOURCEURL=http://upower.freedesktop.org/releases/$BASENAME-$VERSION.tar.bz2
#export DOWNLOADSOURCEURL=http://upower.freedesktop.org/releases/$BASENAME-$VERSION.tar.xz
#wl-showstatus download
#wl-download -v -d $TARBALLDIR/$BASENAME $DOWNLOADSOURCEURL
#wl-wait4deps
##tar xfj $TARBALLDIR/$BASENAME/$BASENAME-$VERSION.tar.bz2
#tar xfJ $TARBALLDIR/$BASENAME/$BASENAME-$VERSION.tar.xz
#cd $BASENAME-$VERSION
### fix problem detecting GNU gettext tools on 64-bit
##if ( echo $RUNPLATFORM | grep -q x86_64 ); then
## sed -i.bak -e "s/as_fn_error\(.*GNU gettext tools not found; required for intltool\)/as_echo\1/" configure
##fi
## fix missing gio-unix-2.0 (version >= 0.99.0)
#sed -i.bak2 -e "s/gio-unix-2.0/gio-windows-2.0/" configure
#wl-showstatus configure &&
# #INTLTOOL_PERL="$PERLDIR/bin/perl.exe" ./configure --prefix=$INSTALLPREFIX --build=$BUILDPLATFORM --host=$RUNPLATFORM --enable-introspection=no &&
# #PERL="$PERLDIR/bin/perl.exe" ./configure --prefix=$INSTALLPREFIX --build=$BUILDPLATFORM --host=$RUNPLATFORM --enable-introspection=no &&
# PATH=$PATH:$PERLDIR/../c/bin INTLTOOL_PERL="$PERLDIR/bin/perl.exe" ./configure --prefix=$INSTALLPREFIX --build=$BUILDPLATFORM --host=$RUNPLATFORM --enable-introspection=no &&
# wl-showstatus build-install &&
# ( PATH=$PATH:$PERLDIR/../c/bin make install-strip || PATH=$PATH:$PERLDIR/../c/bin make -i install-strip; make install-pkgconfigDATA ) &&
# wl-makepackage -c -d && wl-install -d $BASENAME-$VERSION && cd .. && wl-showstatus cleanup && rm -rf $BASENAME-$VERSION



export NAME="UPower"
export STATUS=
export URL=http://upower.freedesktop.org/
export BASENAME=upower
export DESCRIPTION="UPower is an abstraction for enumerating power devices, listening to device events and querying history and statistics. Any application or service on the system can access the org.freedesktop.UPower service via the system message bus."
export CATEGORY=hardware
export TYPE=library
export VERSION=0.99.17
export VERSIONDATE=20220319
wl-showstatus --package-version
export DEPENDANCIES=glib2,dbus,polkit
export OPTIONALDEPENDANCIES=
export BUILDDEPENDANCIES=meson,ninja
export LICENSEFILE=COPYING
export LICENSETYPE=GPL
#export DOWNLOADURL="https://cgit.freedesktop.org/upower/ ?h=v"
export DOWNLOADURL="https://gitlab.freedesktop.org/upower/upower/-/tags"
export INSTALLPREFIX=`pwd`/inst_$BASENAME-$VERSION
export DOWNLOADSOURCEURL=https://gitlab.freedesktop.org/upower/upower/-/archive/v$VERSION/upower-v$VERSION.tar.bz2
wl-showstatus download
wl-download -v -d $TARBALLDIR/$BASENAME $DOWNLOADSOURCEURL
wl-wait4deps
tar xfj $TARBALLDIR/$BASENAME/upower-v$VERSION.tar.bz2
cd upower-v$VERSION
# fix src/up-main.c (version >= 0.99.17)
patch -ulbf src/up-main.c << EOF
@@ -31,3 +31,5 @@
 #include <glib.h>
+#ifndef _WIN32
 #include <glib-unix.h>
+#endif
 #include <glib/gi18n-lib.h>
@@ -242,2 +244,3 @@
        /* do stuff on ctrl-c */
+#ifndef _WIN32
        g_unix_signal_add_full (G_PRIORITY_DEFAULT,
@@ -247,2 +250,3 @@
                                NULL);
+#endif

EOF
# fix skip up_self_test in src/meson.build (version >= 0.99.17)
patch -ulbf src/meson.build << EOF
@@ -60,16 +60,2 @@

-up_self_test = executable('up_self_test',
-    sources: [
-        'up-self-test.c',
-    ],
-    c_args: [
-        '-DUPOWER_CONF_PATH="@0@"'.format(meson.source_root() / 'etc' / 'UPower.conf'),
-        '-DG_LOG_DOMAIN="UPower"',
-    ],
-    dependencies: upowerd_deps,
-    link_with: [ upowerd_private, upshared['dummy'] ],
-    gnu_symbol_visibility: 'hidden',
-    build_by_default: true,
-    install: false,
-)

@@ -111,6 +97,2 @@
 #############
-test(
-   'self-test',
-   up_self_test,
-)

EOF
# allow building both static and shared library
sed -i.bak -e "s/shared_\(library\)/\1/" libupower-glib/meson.build
# fix missing gio-unix
sed -i.bak -e "s/gio-unix-/gio-windows-/" meson.build
mkdir -p build_both &&
 wl-showstatus configure &&
 PKG_CONFIG= PYTHONPATH=$PYTHONPATH:$MINGWPREFIX/lib $PYDIR/python.exe $(which meson.py) --prefix $INSTALLPREFIX --backend ninja --buildtype release --strip --default-library both -Dos_backend=dummy -Dudevrulesdir= -Dsystemdsystemunitdir=no -Didevice=disabled -Dintrospection=enabled -Dman=false -Dgtk-doc=false . build_both &&
 wl-showstatus build-install &&
 PKG_CONFIG= PATH=$PATH:$PYDIR PYTHONPATH=$PYTHONPATH:$MINGWPREFIX/lib ninja -Cbuild_both install &&
 wl-makepackage -c -d && wl-install -d $BASENAME-$VERSION && cd .. && wl-showstatus cleanup && rm -rf upower-v$VERSION
