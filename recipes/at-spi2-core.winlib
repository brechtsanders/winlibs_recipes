#export NAME="at-spi2-core"
#export STATUS=
##export URL=http://www.gnome.org/projects/at-spi2-core
#export URL=https://github.com/GNOME/at-spi2-core
#export BASENAME=at-spi2-core
#export DESCRIPTION="Assistive Technology Service Provider Interface - D-Bus based implementation"
#export CATEGORY=accessibility
#export TYPE=library
##export VERSION=0.4.0
##export VERSIONDATE=20101008
##export VERSION=0.4.1
##export VERSIONDATE=20101116
##export VERSION=2.0.0
##export VERSIONDATE=20110405
##export VERSION=2.0.1
##export VERSIONDATE=20110426
##export VERSION=2.0.2
##export VERSIONDATE=20110524
##export VERSION=2.1.1
##export VERSIONDATE=20110509
#####E:\Prog\MinGW-mSys\home\win32\at-spi2-core-2.0.0\bus/at-spi-bus-launcher.c:321:undefined reference to `pipe'
##export VERSION=2.1.2
##export VERSIONDATE=20110614
##export VERSION=2.1.3
##export VERSIONDATE=20110711
##export VERSION=2.1.4
##export VERSIONDATE=20110726
##export VERSION=2.1.5
##export VERSIONDATE=20110816
#####bus/at-spi-bus-launcher.c:28:22: error: sys/wait.h: No such file or directory
#####bus/at-spi-bus-launcher.c:119: error: implicit declaration of function 'WIFEXITED'
##export VERSION=2.2.0
##export VERSIONDATE=20110927
##export VERSION=2.2.1
##export VERSIONDATE=20111018
##export VERSION=2.2.2
##export VERSIONDATE=20111115
##export VERSION=2.2.3
##export VERSIONDATE=20111122
##export VERSION=2.3.1
##export VERSIONDATE=20111026
##export VERSION=2.3.2
##export VERSIONDATE=20111122
##export VERSION=2.3.4
##export VERSIONDATE=20120116
##export VERSION=2.3.5
##export VERSIONDATE=20120207
#####atspi/atspi-misc.c:1336: error: implicit declaration of function 'XOpenDisplay'
##export VERSION=2.4.0
##export VERSIONDATE=20120327
##export VERSION=2.4.1
##export VERSIONDATE=20120417
##export VERSION=2.4.2
##export VERSIONDATE=20120515
##export VERSION=2.5.1
##export VERSIONDATE=20120501
##export VERSION=2.5.2
##export VERSIONDATE=20120605
##export VERSION=2.5.3
##export VERSIONDATE=20120626
##export VERSION=2.5.4
##export VERSIONDATE=20120717
##export VERSION=2.5.5
##export VERSIONDATE=20120807
##export VERSION=2.5.91
##export VERSIONDATE=20120904
##export VERSION=2.5.92
##export VERSIONDATE=20120918
##export VERSION=2.6.0
##export VERSIONDATE=20120925
##export VERSION=2.6.1
##export VERSIONDATE=20121017
##export VERSION=2.6.2
##export VERSIONDATE=20121113
##export VERSION=2.6.3
##export VERSIONDATE=20121211
#####atspi/atspi-misc.c:1373: error: implicit declaration of function 'XOpenDisplay'
##export VERSION=2.7.1
##export VERSIONDATE=20121023
##export VERSION=2.7.2
##export VERSIONDATE=20121120
##export VERSION=2.7.3
##export VERSIONDATE=20121218
##export VERSION=2.7.4
##export VERSIONDATE=20130115
##export VERSION=2.7.4.1
##export VERSIONDATE=20130116
##export VERSION=2.7.5
##export VERSIONDATE=20130205
##export VERSION=2.8.0
##export VERSIONDATE=20130226
##export VERSION=2.9.2
##export VERSIONDATE=20130529
##export VERSION=2.9.3
##export VERSIONDATE=20130618
##export VERSION=2.9.4
##export VERSIONDATE=20130709
##export VERSION=2.9.5
##export VERSIONDATE=20130730
##export VERSION=2.10.0
##export VERSIONDATE=20130924
##export VERSION=2.10.1
##export VERSIONDATE=20131014
##export VERSION=2.10.2
##export VERSIONDATE=20131112
#####test/memory.c:44:3: error: implicit declaration of function 'kill' [-Werror=implicit-function-declaration]
##export VERSION=2.11.1
##export VERSIONDATE=20131101
#####bus/at-spi-bus-launcher.c:304:28: error: 'builder' undeclared (first use in this function)
##export VERSION=2.11.2
##export VERSIONDATE=20131119
##export VERSION=2.11.3
##export VERSIONDATE=20131217
##export VERSION=2.11.5
##export VERSIONDATE=20140204
##export VERSION=2.12.0
##export VERSIONDATE=20140325
##export VERSION=2.13.1
##export VERSIONDATE=20140429
##export VERSION=2.13.4
##export VERSIONDATE=20140721
##export VERSION=2.14.0
##export VERSIONDATE=20140923
##export VERSION=2.14.1
##export VERSIONDATE=20141111
##export VERSION=2.15.1
##export VERSIONDATE=20141028
##export VERSION=2.15.2
##export VERSIONDATE=20141125
##export VERSION=2.15.3
##export VERSIONDATE=20141213
##export VERSION=2.15.4
##export VERSIONDATE=20150120
##export VERSION=2.16.0
##export VERSIONDATE=20150325
##export VERSION=2.17.1
##export VERSIONDATE=20150721
##export VERSION=2.18.0
##export VERSIONDATE=20150922
##export VERSION=2.18.1
##export VERSIONDATE=20151013
##export VERSION=2.18.2
##export VERSIONDATE=20151108
##export VERSION=2.18.3
##export VERSIONDATE=20151111
##export VERSION=2.19.1
##export VERSIONDATE=20151030
##export VERSION=2.19.2
##export VERSIONDATE=20151127
##export VERSION=2.20.0
##export VERSIONDATE=20160322
##export VERSION=2.20.1
##export VERSIONDATE=20160412
##export VERSION=2.20.2
##export VERSIONDATE=20160523
##export VERSION=2.21.1
##export VERSIONDATE=20160510
##export VERSION=2.21.2
##export VERSIONDATE=20160524
##export VERSION=2.21.4
##export VERSIONDATE=20160719
##export VERSION=2.22.0
##export VERSIONDATE=20160926
##export VERSION=2.22.1
##export VERSIONDATE=20170321
##export VERSION=2.23.4
##export VERSIONDATE=20170117
##export VERSION=2.24.0
##export VERSIONDATE=20170321
##export VERSION=2.24.1
##export VERSIONDATE=20170509
##export VERSION=2.25.1
##export VERSIONDATE=20170425
##export VERSION=2.25.2
##export VERSIONDATE=20170523
##export VERSION=2.25.3
##export VERSIONDATE=20170620
##export VERSION=2.25.4
##export VERSIONDATE=20170621
##export VERSION=2.26.0
##export VERSIONDATE=20170912
##export VERSION=2.26.1
##export VERSIONDATE=20171031
#export VERSION=2.26.3
#export VERSIONDATE=20190305
#export DEPENDENCIES=libx11,libxtst,dbus,libdl,glib2,libxevie,dbus-glib,libsm,xkbcommon
#export OPTIONALDEPENDENCIES=
#export BUILDDEPENDENCIES=
#export OPTIONALBUILDDEPENDENCIES=
##export VERSION=2.27.1
##export VERSIONDATE=20171212
##export VERSION=2.28.0
##export VERSIONDATE=20180313
##export VERSION=2.28.1
##export VERSIONDATE=20190305
##export VERSION=2.29.1
##export VERSIONDATE=20180619
##export VERSION=2.30.0
##export VERSIONDATE=20180904
##export VERSION=2.30.1
##export VERSIONDATE=20190305
##export VERSION=2.31.1
##export VERSIONDATE=20190108
##export VERSION=2.31.2
##export VERSIONDATE=20190219
##export VERSION=2.32.0
##export VERSIONDATE=20190312
##export VERSION=2.32.1
##export VERSIONDATE=20190412
##export VERSION=2.33.1
##export VERSIONDATE=20190521
##export VERSION=2.33.2
##export VERSIONDATE=20190618
##export VERSION=2.34.0
##export VERSIONDATE=20190910
##export VERSION=2.35.1
##export VERSIONDATE=20200119
##export VERSION=2.36.0
##export VERSIONDATE=20200308
##export VERSION=2.36.1
##export VERSIONDATE=20200905
##export VERSION=2.38.0
##export VERSIONDATE=20200913
##export VERSION=2.39.1
##export VERSIONDATE=20210112
##export VERSION=2.40.0
##export VERSIONDATE=20210320
##export VERSION=2.40.1
##export VERSIONDATE=20210502
##export VERSION=2.40.2
##export VERSIONDATE=20210606
##export VERSION=2.40.3
##export VERSIONDATE=20210710
#wl-showstatus --package-version
##export DEPENDENCIES=libx11,libxtst,dbus,libdl,glib2,libxevie,dbus-glib,libsm,xkbcommon,sys_wait_h
##export OPTIONALDEPENDENCIES=
##export BUILDDEPENDENCIES=meson
##export OPTIONALBUILDDEPENDENCIES=
#export LICENSEFILE=COPYING
#export LICENSETYPE=LGPL
#export DOWNLOADURL="http://ftp.gnome.org/pub/GNOME/sources/at-spi2-core/"
#export INSTALLPREFIX=`pwd`/inst_$BASENAME-$VERSION
##export DOWNLOADSOURCEURL=http://ftp.gnome.org/pub/gnome/sources/$BASENAME/`echo $VERSION|sed 's/^\([0-9]*\.[0-9]*\)\..*$/\1/'`/$BASENAME-$VERSION.tar.bz2
#export DOWNLOADSOURCEURL=http://ftp.gnome.org/pub/gnome/sources/$BASENAME/`echo $VERSION|sed 's/^\([0-9]*\.[0-9]*\)\..*$/\1/'`/$BASENAME-$VERSION.tar.xz
#wl-showstatus download
#wl-download -v -d $TARBALLDIR/$BASENAME $DOWNLOADSOURCEURL
#wl-wait4deps
##tar xj --force-local -f $TARBALLDIR/$BASENAME/$BASENAME-$VERSION.tar.bz2
#tar xJ --force-local -f $TARBALLDIR/$BASENAME/$BASENAME-$VERSION.tar.xz
#cd $BASENAME-$VERSION
## fix missing files (version >= 2.0.0)
#mkdir -p sys
#cat > sys/wait.h << EOF
##define fork() -1
##define waitpid(pid,status,options) -1
##define inet_aton(opt,bind) ((bind)->s_addr = inet_addr(opt))
##define ENOTCONN WSAENOTCONN
##define WNOHANG 0
##define WEXITSTATUS(status) (((status)  & 0xFF00) >> 8)
##define WIFEXITED(status) (WTERMSIG(status) == 0)
#//#define WIFSTOPPED(status) (((status) & 0xFF) == 0x7F)
##define WIFSIGNALED(status) (!WIFSTOPPED(status) && !WIFEXITED(status))
#//#define WSTOPSIG(status) WEXITSTATUS(status)
##define WTERMSIG(status) ((status) & 0x7F)
#EOF
## fix missing strtok_r in atspi/atspi-event-listener.c (version >= 2.0.0)
#mv atspi/atspi-event-listener.c atspi/atspi-event-listener.c.bak &&
#echo "#define strtok_r(_s,_sep,_lasts) (*(_lasts)=strtok((_s),(_sep)))" > atspi/atspi-event-listener.c &&
#cat atspi/atspi-event-listener.c.bak >> atspi/atspi-event-listener.c
### fix missing pipe/kill/stdout in bus/at-spi-bus-launcher.c (version >= 2.0.0 <= 2.6.2)
##mv bus/at-spi-bus-launcher.c bus/at-spi-bus-launcher.c.bak
##cat > bus/at-spi-bus-launcher.c << EOF
###include <stdint.h>
###define WINDOWS
###include <windows.h>
##static int kill (DWORD pid, int sig)
##{
## BOOL status;
## HANDLE hProcess;
## if ((hProcess = OpenProcess(PROCESS_TERMINATE, FALSE, pid)) == NULL || hProcess == INVALID_HANDLE_VALUE)
##  return -1;
## status = TerminateProcess(hProcess, ~0);
## CloseHandle(hProcess);
## return (status ? 0 : -1);
##}
###include <fcntl.h>
###define pipe(fds) _pipe(fds, 4096, _O_BINARY) 
###define WIFSTOPPED(status) (((status) & 0xFF) == 0x7F)
###define WSTOPSIG(status) WEXITSTATUS(status)
##EOF
##sed -e "s/stdout/std_out/g" bus/at-spi-bus-launcher.c.bak >> bus/at-spi-bus-launcher.c
### fix pipe/kill/stdout in bus/at-spi-bus-launcher.c (version >= 2.6.3)
##patch -ulbf bus/at-spi-bus-launcher.c << EOF
##--- bus/at-spi-bus-launcher.c  2012-09-17 17:57:58 +0200
##+++ bus/at-spi-bus-launcher.c  2012-12-11 20:28:50 +0100
##@@ -21,4 +21,24 @@
##  */
##
##+#ifdef __MINGW32__
##+#include <stdint.h>
##+#define WINDOWS
##+#include <windows.h>
##+static int kill (DWORD pid, int sig)
##+{
##+ BOOL status;
##+ HANDLE hProcess;
##+ if ((hProcess = OpenProcess(PROCESS_TERMINATE, FALSE, pid)) == NULL || hProcess == INVALID_HANDLE_VALUE)
##+  return -1;
##+ status = TerminateProcess(hProcess, ~0);
##+ CloseHandle(hProcess);
##+ return (status ? 0 : -1);
##+}
##+#include <fcntl.h>
##+#define pipe(fds) _pipe(fds, 4096, _O_BINARY)
##+#define WIFSTOPPED(status) (((status) & 0xFF) == 0x7F)
##+#define WSTOPSIG(status) WEXITSTATUS(status)
##+#endif
##+
## #include "config.h"
##
##@@ -188,4 +208,5 @@
##   g_debug ("a11y bus address: %s", app->a11y_bus_address);
##
##+#ifndef __MINGW32__
##   {
##     Display *display = XOpenDisplay (NULL);
##@@ -202,4 +223,5 @@
##       }
##   }
##+#endif
##
##   return TRUE;
##@@ -502,4 +524,7 @@
##   gboolean result = FALSE;
##
##+#ifdef __MINGW32__
##+  return FALSE;
##+#else
##   bridge_display = XOpenDisplay (NULL);
##   if (!bridge_display)
##@@ -531,4 +556,5 @@
##   XCloseDisplay (bridge_display);
##   return result;
##+#endif
## }
##
##@@ -644,4 +670,5 @@
##    * we don't want early login processes to pick up the stale address.
##    */
##+#ifndef __MINGW32__
##   {
##     Display *display = XOpenDisplay (NULL);
##@@ -657,4 +684,5 @@
##       }
##   }
##+#endif
##
##   if (_global_app->a11y_launch_error_message)
#EOF
## fix pipe/kill/stdout in bus/at-spi-bus-launcher.c (version >= 2.11.2)
#mv bus/at-spi-bus-launcher.c bus/at-spi-bus-launcher.c.bak
#cat > bus/at-spi-bus-launcher.c << EOF
##ifdef __MINGW32__
##include <stdint.h>
##define WINDOWS
##include <windows.h>
#static int kill (DWORD pid, int sig)
#{
# BOOL status;
# HANDLE hProcess;
# if ((hProcess = OpenProcess(PROCESS_TERMINATE, FALSE, pid)) == NULL || hProcess == INVALID_HANDLE_VALUE)
#  return -1;
# status = TerminateProcess(hProcess, ~0);
# CloseHandle(hProcess);
# return (status ? 0 : -1);
#}
##include <fcntl.h>
##define pipe(fds) _pipe(fds, 4096, _O_BINARY)
##define WIFSTOPPED(status) (((status) & 0xFF) == 0x7F)
##define WSTOPSIG(status) WEXITSTATUS(status)
##endif
#EOF
#cat bus/at-spi-bus-launcher.c.bak >> bus/at-spi-bus-launcher.c
### avoid using already defined interface in atspi/atspi-misc.c (version >= 2.4.0 <= 2.6.2)
##mv atspi/atspi-misc.c atspi/atspi-misc.c.bak
##sed -e "s/\b\(interface\)\b/iface/g" atspi/atspi-misc.c.bak > atspi/atspi-misc.c
## avoid using already defined interface and X stuff in atspi/atspi-misc.c (version >= 2.6.3)
#patch -ulbf atspi/atspi-misc.c << EOF
#--- atspi/atspi-misc.c  2012-12-10 17:18:06 +0100
#+++ atspi/atspi-misc.c  2012-12-11 19:53:52 +0100
#@@ -683,8 +683,8 @@
# {
#   int type = dbus_message_get_type (closure->message);
#-  const char *interface = dbus_message_get_interface (closure->message);
#+  const char *iface = dbus_message_get_interface (closure->message);
#
#   if (type == DBUS_MESSAGE_TYPE_SIGNAL &&
#-      !strncmp (interface, "org.a11y.atspi.Event.", 21))
#+      !strncmp (iface, "org.a11y.atspi.Event.", 21))
#   {
#     _atspi_dbus_handle_event (closure->bus, closure->message, closure->data);
#@@ -750,8 +750,8 @@
# {
#   int type = dbus_message_get_type (message);
#-  const char *interface = dbus_message_get_interface (message);
#+  const char *iface = dbus_message_get_interface (message);
#
#   if (type == DBUS_MESSAGE_TYPE_SIGNAL &&
#-      !strncmp (interface, "org.a11y.atspi.Event.", 21))
#+      !strncmp (iface, "org.a11y.atspi.Event.", 21))
#   {
#     return defer_message (bus, message, data);
#@@ -1026,5 +1026,5 @@
#
# dbus_bool_t
#-_atspi_dbus_call (gpointer obj, const char *interface, const char *method, GError **error, const char *type, ...)
#+_atspi_dbus_call (gpointer obj, const char *iface, const char *method, GError **error, const char *type, ...)
# {
#   va_list args;
#@@ -1040,5 +1040,5 @@
#   set_timeout (aobj->app);
#   retval = dbind_method_call_reentrant_va (aobj->app->bus, aobj->app->bus_name,
#-                                           aobj->path, interface, method, &err,
#+                                           aobj->path, iface, method, &err,
#                                            type, args);
#   va_end (args);
#@@ -1055,5 +1055,5 @@
# DBusMessage *
# _atspi_dbus_call_partial (gpointer obj,
#-                          const char *interface,
#+                          const char *iface,
#                           const char *method,
#                           GError **error,
#@@ -1063,5 +1063,5 @@
#
#   va_start (args, type);
#-  return _atspi_dbus_call_partial_va (obj, interface, method, error, type, args);
#+  return _atspi_dbus_call_partial_va (obj, iface, method, error, type, args);
# }
#
#@@ -1069,5 +1069,5 @@
# DBusMessage *
# _atspi_dbus_call_partial_va (gpointer obj,
#-                          const char *interface,
#+                          const char *iface,
#                           const char *method,
#                           GError **error,
#@@ -1086,5 +1086,5 @@
#     goto out;
#
#-  msg = dbus_message_new_method_call (aobj->app->bus_name, aobj->path, interface, method);
#+  msg = dbus_message_new_method_call (aobj->app->bus_name, aobj->path, iface, method);
#   if (!msg)
#     goto out;
#@@ -1111,5 +1111,5 @@
#
# dbus_bool_t
#-_atspi_dbus_get_property (gpointer obj, const char *interface, const char *name, GError **error, const char *type, void *data)
#+_atspi_dbus_get_property (gpointer obj, const char *iface, const char *name, GError **error, const char *type, void *data)
# {
#   DBusMessage *message, *reply;
#@@ -1135,5 +1135,5 @@
#     return FALSE;
#   }
#-  dbus_message_append_args (message, DBUS_TYPE_STRING, &interface, DBUS_TYPE_STRING, &name, DBUS_TYPE_INVALID);
#+  dbus_message_append_args (message, DBUS_TYPE_STRING, &iface, DBUS_TYPE_STRING, &name, DBUS_TYPE_INVALID);
#   dbus_error_init (&err);
#   set_timeout (aobj->app);
#@@ -1160,5 +1160,5 @@
#   if (dbus_message_iter_get_arg_type (&iter) != 'v')
#   {
#-    g_warning ("AT-SPI: expected a variant when fetching %s from interface %s; got %s\\n", name, interface, dbus_message_get_signature (reply));
#+    g_warning ("AT-SPI: expected a variant when fetching %s from interface %s; got %s\\n", name, iface, dbus_message_get_signature (reply));
#     goto done;
#   }
#@@ -1358,4 +1358,8 @@
# get_accessibility_bus_address_x11 (void)
# {
#+#ifdef __MINGW32__
#+  g_warning ("Could not open X display");
#+  return NULL;
#+#else
#   Atom AT_SPI_BUS;
#   Atom actual_type;
#@@ -1392,4 +1396,5 @@
#   XFree (data_x11);
#   return data;
#+#endif
# }
#
#EOF
## avoid using already defined interface in registryd/deviceeventcontroller.c (version >= 2.4.0)
#mv registryd/deviceeventcontroller.c registryd/deviceeventcontroller.c.bak
#sed -e "s/\b\(interface\)\b/iface/g" registryd/deviceeventcontroller.c.bak > registryd/deviceeventcontroller.c
## avoid using already defined interface in registryd/deviceeventcontroller.c (version >= 2.11.2)
#mv registryd/deviceeventcontroller.h registryd/deviceeventcontroller.h.bak
#sed -e "s/\b\(interface\)\b/iface/g" registryd/deviceeventcontroller.h.bak > registryd/deviceeventcontroller.h
## fix registryd/display.c (version >= 2.6.3)
#patch registryd/display.c << EOF
#--- registryd/display.c  2012-09-10 18:48:18 +0200
#+++ registryd/display.c  2012-12-11 20:32:18 +0100
#@@ -38,2 +38,5 @@
# {
#+#ifdef __MINGW32__
#+  return NULL;
#+#else
#         /*
#@@ -49,2 +52,3 @@
#  return default_display;
#+#endif
# }
#EOF
## fix missing XPending in registryd/event-source.c (version >= 2.6.3)
#if ! grep -q XPending $MINGWPREFIX/include/X11/Xlib.h; then
# mv registryd/event-source.c registryd/event-source.c.bak
# echo "#define XPending(d) 0" > registryd/event-source.c
# cat registryd/event-source.c.bak >> registryd/event-source.c
#fi
### fix building DLLs on 64-bit
##if ( echo $RUNPLATFORM | grep -q x86_64 ); then
## autoreconf -f -i -I m4 -I $MINGWPREFIX/share/aclocal
##fi
## fix already defined DATA_DIR (version >= 2.20.0)
#mv bus/Makefile.in bus/Makefile.in.bak &&
#sed -e "s/-DDATADIR/-DDATA_DIR/" bus/Makefile.in.bak > bus/Makefile.in &&
#mv bus/at-spi-bus-launcher.c bus/at-spi-bus-launcher.c.bak &&
#sed -e "s/DATADIR/DATA_DIR/" bus/at-spi-bus-launcher.c.bak > bus/at-spi-bus-launcher.c
## skip making test (version >= 2.8.0)
#cat > test/Makefile.in << EOF
#clean:
#all:
#install:
#install-strip:
#EOF
## fix problem detecting GNU gettext tools on 64-bit
#if ( echo $RUNPLATFORM | grep -q x86_64 ); then
# mv configure configure.bak
# sed -e "s/as_fn_error\(.*GNU gettext tools not found; required for intltool\)/as_echo\1/" configure.bak > configure
#fi
#wl-showstatus configure &&
# #./configure --prefix=$INSTALLPREFIX --build=$BUILDPLATFORM --host=$RUNPLATFORM LDFLAGS="-no-undefined -Wl,-no-undefined" &&
# #INTLTOOL_PERL="$PERLDIR/bin/perl.exe" ./configure --prefix=$INSTALLPREFIX --build=$BUILDPLATFORM --host=$RUNPLATFORM LDFLAGS="-Wl,--as-needed -lplibc -no-undefined -Wl,-no-undefined" &&
# #INTLTOOL_PERL="$PERLDIR/bin/perl.exe" ./configure --prefix=$INSTALLPREFIX --build=$BUILDPLATFORM --host=$RUNPLATFORM LDFLAGS="-Wl,--as-needed -lplibc -luuid -no-undefined -Wl,-no-undefined" &&
# #INTLTOOL_PERL="$PERLDIR/bin/perl.exe" ./configure --prefix=$INSTALLPREFIX --build=$BUILDPLATFORM --host=$RUNPLATFORM --without-x --enable-introspection=no LDFLAGS="-Wl,--as-needed -lplibc -luuid -Wl,-no-undefined" &&
# #INTLTOOL_PERL="$PERLDIR/bin/perl.exe" ./configure --prefix=$INSTALLPREFIX --build=$BUILDPLATFORM --host=$RUNPLATFORM --with-x --enable-introspection=no LDFLAGS="-Wl,--as-needed -lplibc -luuid -Wl,-no-undefined" &&
# #INTLTOOL_PERL="$PERLDIR/bin/perl.exe" ./configure --prefix=$INSTALLPREFIX --build=$BUILDPLATFORM --host=$RUNPLATFORM --with-x --enable-introspection=no LDFLAGS="-Wl,--as-needed -Wl,-no-undefined" &&
# #PERL="$PERLDIR/bin/perl.exe" ./configure --prefix=$INSTALLPREFIX --build=$BUILDPLATFORM --host=$RUNPLATFORM --enable-static --enable-shared --with-x --enable-introspection=no LDFLAGS="-Wl,--as-needed -Wl,-no-undefined" &&
# #INTLTOOL_PERL="$PERLDIR/bin/perl.exe" ./configure --prefix=$INSTALLPREFIX --build=$BUILDPLATFORM --host=$RUNPLATFORM --enable-static --enable-shared --with-x --enable-introspection=no LDFLAGS="-Wl,--as-needed -Wl,-no-undefined" &&
# INTLTOOL_PERL="$PERLDIR/bin/perl.exe" PATH=$PATH:$PERLDIR/../c/bin ./configure --prefix=$INSTALLPREFIX --build=$BUILDPLATFORM --host=$RUNPLATFORM --enable-static --enable-shared --with-x --enable-introspection=no CFLAGS="-I$MINGWPREFIX/include/libdl-win32" LDFLAGS="-Wl,--as-needed -Wl,-no-undefined" &&
# # fix missing strcasecmp on non-MinGW-W64 (version >= 2.22.0)
# if ! ( echo -e "#include<_mingw.h>\nint v=__MINGW64_VERSION_MAJOR;" | ${CC:-gcc} -c -xc - -o /dev/null &> /dev/null ); then
#  echo "#define strcasecmp stricmp" >> config.h
# fi &&
# wl-showstatus build-install &&
# make install-strip &&
# wl-makepackage -c -d && wl-install -d $BASENAME-$VERSION && cd .. && wl-showstatus cleanup && rm -rf $BASENAME-$VERSION



export NAME="at-spi2-core"
export STATUS=
export URL=https://github.com/GNOME/at-spi2-core
export BASENAME=at-spi2-core
export DESCRIPTION="Assistive Technology Service Provider Interface - D-Bus based implementation"
export CATEGORY=accessibility
export TYPE=library
#export VERSION=2.40.3
#export VERSIONDATE=20210710
#export VERSION=2.42.0
#export VERSIONDATE=20210919
#export DEPENDENCIES=libx11,libxtst,dbus,libdl,glib2,libxevie,dbus-glib,libsm,xkbcommon,sys_wait_h
#export OPTIONALDEPENDENCIES=
#export BUILDDEPENDENCIES=meson
#export OPTIONALBUILDDEPENDENCIES=
#export VERSION=2.44.0
#export VERSIONDATE=20220318
#export VERSION=2.44.1
#export VERSIONDATE=20220422
#export VERSION=2.45.1
#export VERSIONDATE=20220703
#export VERSION=2.46.0
#export VERSIONDATE=20220918
#export VERSION=2.47.1
#export VERSIONDATE=20230108
#export VERSION=2.48.0
#export VERSIONDATE=20230320
#export VERSION=2.48.1
#export VERSIONDATE=20230511
#export VERSION=2.48.2
#export VERSIONDATE=20230512
#export VERSION=2.48.3
#export VERSIONDATE=20230528
#export VERSION=2.48.4
#export VERSIONDATE=20230903
#export VERSION=2.49.1
#export VERSIONDATE=20230718
#export VERSION=2.49.90
#export VERSIONDATE=20230806
#export VERSION=2.49.91
#export VERSIONDATE=20230903
####atspi-device-legacy.c:(.text+0x2d1): undefined reference to `timersub'
####atspi-device.c:(.text+0x1d1): undefined reference to `atspi_device_legacy_new'
#export VERSION=2.50.0
#export VERSIONDATE=20230916
#export VERSION=2.50.1
#export VERSIONDATE=20240106
export VERSION=2.51.0
export VERSIONDATE=20240106
wl-showstatus --package-version
export DEPENDENCIES=libx11,libxtst,dbus,libdl,glib2,libxevie,dbus-glib,libsm,xkbcommon,sys_wait_h,atk
export OPTIONALDEPENDENCIES=
export BUILDDEPENDENCIES=meson
export OPTIONALBUILDDEPENDENCIES=
export LICENSEFILE=COPYING
export LICENSETYPE=LGPL
export DOWNLOADURL="http://ftp.gnome.org/pub/GNOME/sources/at-spi2-core/"
export INSTALLPREFIX=`pwd`/inst_$BASENAME-$VERSION
export DOWNLOADSOURCEURL=http://ftp.gnome.org/pub/gnome/sources/$BASENAME/$(echo $VERSION|sed 's/^\([0-9]*\.[0-9]*\)\..*$/\1/')/$BASENAME-$VERSION.tar.xz
wl-showstatus download
wl-download -v -d $TARBALLDIR/$BASENAME $DOWNLOADSOURCEURL
wl-wait4deps
tar xJ --force-local -f $TARBALLDIR/$BASENAME/$BASENAME-$VERSION.tar.xz
cd $BASENAME-$VERSION
## fix MSVC issue
#mkdir -p winfix
#cp -rf $PYDIR/lib/distutils winfix/
#patch -ulbf winfix/distutils/cygwinccompiler.py << EOF
#@@ -85,3 +85,3 @@
#         else:
#-            raise ValueError("Unknown MS Compiler version %s " % msc_ver)
#+            return None
#
#EOF
# fix missing pipe() in bus/at-spi-bus-launcher.c (version >= 2.40.3)
mv bus/at-spi-bus-launcher.c bus/at-spi-bus-launcher.c.bak
cat > bus/at-spi-bus-launcher.c << EOF
#undef DATADIR
#include <windows.h>
static int kill (DWORD pid, int sig)
{
 BOOL status;
 HANDLE hProcess;
 if ((hProcess = OpenProcess(PROCESS_TERMINATE, FALSE, pid)) == NULL || hProcess == INVALID_HANDLE_VALUE)
  return -1;
 status = TerminateProcess(hProcess, ~0);
 CloseHandle(hProcess);
 return (status ? 0 : -1);
}
#include <fcntl.h>
#define pipe(fds) _pipe(fds, 4096, _O_BINARY)
#define mkdir(p,m) mkdir(p)
EOF
sed -e "s?sys/wait\.h?../win32ports/include/&?; s?DATADIR??" bus/at-spi-bus-launcher.c.bak >> bus/at-spi-bus-launcher.c
# avoid already defined word interface (version >= 2.35.1)
sed -i.bak -e "s/\binterface\b/iface/g" atspi/atspi-misc-private.h atspi/atspi-misc.c dbind/dbind.h dbind/dbind.c registryd/deviceeventcontroller.h registryd/deviceeventcontroller.c
# fix undefined LockMask in registryd/deviceeventcontroller.c (version >= 2.44.0)
mv registryd/deviceeventcontroller.c registryd/deviceeventcontroller.c.bak2 &&
echo "#define LockMask 0" > registryd/deviceeventcontroller.c &&
cat registryd/deviceeventcontroller.c.bak2 >> registryd/deviceeventcontroller.c
# fix missing getuid/geteuid in atk-adaptor/bridge.c (version >= 2.45.1)
patch -ulbf atk-adaptor/bridge.c << EOF
@@ -651,2 +651,5 @@
 {
+#ifdef _WIN32
+  return 0;
+#else
   FILE *fp;
@@ -678,2 +681,3 @@
   return get_ancestral_uid (ppid);
+#endif
 }
@@ -683,2 +687,3 @@
 {
+#ifndef _WIN32
   if (uid == getuid () || uid == geteuid ())
@@ -690,2 +695,3 @@
   }
+#endif
   return FALSE;
@@ -939,2 +945,3 @@

+#ifndef _WIN32
   if (getuid () != 0)
@@ -950,2 +957,3 @@
   }
+#endif

EOF
## fix missing timersub in atspi/atspi-device-legacy.c (version >= 2.49.1)
#mv atspi/atspi-device-legacy.c atspi/atspi-device-legacy.c.bak
#cat > atspi/atspi-device-legacy.c << EOF
##include <time.h>
##ifndef timersub
##define timersub(a, b, result)                      \\
# {                                                  \\
#   (result)->tv_sec = (a)->tv_sec - (b)->tv_sec;    \\
#   (result)->tv_usec = (a)->tv_usec - (b)->tv_usec; \\
#   if ((result)->tv_usec < 0) {                     \\
#     --(result)->tv_sec;                            \\
#     (result)->tv_usec += 1000000;                  \\
#   }                                                \\
# }
##endif
#EOF
#cat atspi/atspi-device-legacy.c.bak >> atspi/atspi-device-legacy.c
# fix bus/meson.build (version >= 2.42.0)
patch -ulbf bus/meson.build << EOF
@@ -36,2 +36,3 @@

+if x11_option != 'no'
 if x11_dep.found()
@@ -42,2 +43,3 @@
 endif
+endif

EOF
## don't build test/memory.c due to missing fork/kill (version >= 2.35.1)
#mv test/meson.build test/meson.build.bak &&
#touch test/meson.build
## fix missing atspi_conf and don't build atk/atk-adaptor/test in meson.build (version >= 2.45.1)
#patch -ulbf meson.build << EOF
#@@ -62,3 +62,3 @@
#   if host_system == 'windows'
#-    atspi_conf.set('DLL_EXPORT', true)
#+    at_spi_conf.set('DLL_EXPORT', true)
#     at_spi_conf.set('_ATK_EXTERN', '__declspec(dllexport) extern')
#@@ -215,6 +215,6 @@
# subdir('registryd')
#-subdir('atk')
#+#subdir('atk')
# subdir('droute')
#-subdir('atk-adaptor')
#-subdir('tests')
#+#subdir('atk-adaptor')
#+#subdir('tests')
#
#EOF
# fix meson.build (version >= 2.48.0)
patch -ulbf meson.build << EOF
@@ -64,3 +64,3 @@
   if host_system == 'windows'
-    atspi_conf.set('DLL_EXPORT', true)
+    at_spi_conf.set('DLL_EXPORT', true)
     at_spi_conf.set('_ATK_EXTERN', '__declspec(dllexport) extern')
@@ -211,3 +211,3 @@
   subdir('atk-adaptor')
-  subdir('tests')
+  #subdir('tests')
 endif
EOF
## fix reinstalling already installed atk in atk/meson.build (version >= 2.45.1)
#patch -ulbf atk/meson.build << EOF
#@@ -70,3 +70,2 @@
#
#-install_headers(atk_headers + ['atk.h'], subdir: atk_api_path)
#
#@@ -130,3 +129,3 @@
#   version: atk_libversion,
#-  install: true,
#+  install: false,
#   dependencies: [glib_dep, gobject_dep],
#EOF
# fix bus/meson.build (version >= 2.47.1)
patch -ulbf bus/meson.build << EOF
@@ -36,3 +36,3 @@

-if x11_option != 'no'
+if true
 if x11_dep.found()
EOF
mkdir -p build_both &&
 wl-showstatus configure &&
 #PKG_CONFIG= PYTHONPATH=${PYTHONPATH:+$PYTHONPATH:}$MINGWPREFIX/lib $PYDIR/python.exe $(which meson.py) --prefix $INSTALLPREFIX --backend ninja --buildtype release --strip --default-library both -Ddefault_bus=dbus-broker -Dintrospection=no -Denable-x11=no -Ddocs=false -Dc_args="-I$MINGWPREFIX/win32ports/include" -Dc_args="-I$MINGWPREFIX/include/libdl-win32" . build_both &&
 #PKG_CONFIG= PYTHONPATH=${PYTHONPATH:+$PYTHONPATH:}$MINGWPREFIX/lib $PYDIR/python.exe $(which meson.py) --prefix $INSTALLPREFIX --backend ninja --buildtype release --strip --default-library both -Ddefault_bus=dbus-broker -Dintrospection=yes -Denable-x11=no -Ddocs=false -Dc_args="-I$MINGWPREFIX/win32ports/include" -Dc_args="-I$MINGWPREFIX/include/libdl-win32" . build_both &&
 #PKG_CONFIG= PYTHONPATH=${PYTHONPATH:+$PYTHONPATH:}$MINGWPREFIX/lib $PYDIR/python.exe $(which meson.py) --prefix $INSTALLPREFIX --backend ninja --buildtype release --strip --default-library both -Ddefault_bus=dbus-broker -Dintrospection=no -Dx11=no -Ddocs=false -Dc_args="-I$MINGWPREFIX/win32ports/include" -Dc_args="-I$MINGWPREFIX/include/libdl-win32" . build_both &&
 #PKG_CONFIG= PYTHONPATH=${PYTHONPATH:+$PYTHONPATH:}$MINGWPREFIX/lib $PYDIR/python.exe $(which meson.py) --prefix $INSTALLPREFIX --backend ninja --buildtype release --strip --default-library both -Ddefault_bus=dbus-broker -Dintrospection=disabled -Dx11=disabled -Ddocs=false -Dc_args="-I$MINGWPREFIX/win32ports/include" -Dc_args="-I$MINGWPREFIX/include/libdl-win32" . build_both &&
 #PKG_CONFIG= PYTHONPATH=${PYTHONPATH:+$PYTHONPATH:}$MINGWPREFIX/lib $PYDIR/python.exe $(which meson.py) --prefix $INSTALLPREFIX --backend ninja --buildtype release --strip --default-library both -Ddefault_bus=dbus-broker -Dintrospection=disabled -Dx11=disabled -Ddocs=false -Dc_args="-I$(cygpath -m $MINGWPREFIX/include/libdl-win32) -Wno-int-conversion" . build_both &&
 PYTHONPATH=${PYTHONPATH:+$PYTHONPATH:}$MINGWPREFIX/lib $PYDIR/python.exe $(which meson.py) --prefix $INSTALLPREFIX --backend ninja --buildtype release --strip --default-library both -Ddefault_bus=dbus-broker -Dintrospection=disabled -Dx11=disabled -Ddocs=false -Dc_args="-I$(cygpath -m $MINGWPREFIX/include/libdl-win32) -Wno-int-conversion" . build_both &&
 ## fix slash/backslash path issue when calling Python from Ninja
 #sed -i.bak -e "s/join_paths/os.path.join/g; /COMMAND =.*python\.exe/ s?\"/\([a-zA-Z]\)/?\"\1:/?; /COMMAND =.*python\.exe/ s?/?\\\\?g" build_both/build.ninja &&
 # fix execution of Python scripts
 sed -i.bak -e "s?\(COMMAND\|POST_BUILD\)\( *= *\| *=.*\&\& *\)\(\"\{0,1\}[^ ]*\)\(\.py\|glib-mkenums\|g-ir-scanner\)\(\"\{0,1\} \)?\1\2$(echo $PYDIR/python.exe|sed -e "s?^/\([a-zA-Z]\)/?\1:\\\\\\\\?; s?/?\\\\\\\\?g") \3\4\5?" build_*/build.ninja &&
 wl-showstatus build-install &&
 #PKG_CONFIG= PATH=$PATH:$PYDIR PYTHONPATH=${PYTHONPATH:+$PYTHONPATH:}$MINGWPREFIX/lib ninja -Cbuild_both install &&
 PATH=$PATH:$PYDIR PYTHONPATH=${PYTHONPATH:+$PYTHONPATH:}$MINGWPREFIX/lib ninja -Cbuild_both install &&
 #PKG_CONFIG= PATH=$PYDIR:$PATH PYTHONPATH=$(pwd)/winfix:$MINGWPREFIX/lib${PYTHONPATH:+:$PYTHONPATH} ninja -Cbuild_both install &&
 # don't install at-spi2-atk.desktop (already part of at-spi2-atk) (version >= 2.45.1)
 rm -f $INSTALLPREFIX/lib/gnome-settings-daemon-3.0/gtk-modules/at-spi2-atk.desktop &&
 wl-makepackage -c -d && wl-install -d $BASENAME-$VERSION && cd .. && wl-showstatus cleanup && rm -rf $BASENAME-$VERSION
####TO DO: check if at-spi2-atk is now included in at-spi2-core



