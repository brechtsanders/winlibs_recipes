export NAME="libmicrohttpd"
export STATUS=
export URL=http://www.gnu.org/software/libmicrohttpd/
export BASENAME=libmicrohttpd
export DESCRIPTION="GNU libmicrohttpd is a small C library that is supposed to make it easy to run an HTTP server as part of another application."
export CATEGORY=communication
export TYPE=library
#export VERSION=0.3.1
#export VERSION=0.4.0a
#export VERSION=0.4.1
#export VERSION=0.4.2
#export VERSIONDATE=
#export VERSION=0.4.4
#export VERSIONDATE=20091103
####doesn't work (not listening on port?)
#export VERSION=0.4.6
#export VERSIONDATE=20100315
#export VERSION=0.9.0
#export VERSIONDATE=20100727
####src/daemon/daemon.c:1647:23: error: 'IPV6_V6ONLY' undeclared (first use in this function)
#export VERSION=0.9.1
#export VERSIONDATE=20100910
#export VERSION=0.9.2
#export VERSIONDATE=20101017
#export VERSION=0.9.3
#export VERSIONDATE=20101123
#export VERSION=0.9.4
#export VERSIONDATE=20101226
#export VERSION=0.9.5
#export VERSIONDATE=20110110
#export VERSION=0.9.6
#export VERSIONDATE=20110125
#export VERSION=0.9.7
#export VERSIONDATE=20110214
#export VERSION=0.9.8
#export VERSIONDATE=20110304
#export VERSION=0.9.9
#export VERSIONDATE=20110329
#export VERSION=0.9.10
#export VERSIONDATE=20110427
#export VERSION=0.9.11
#export VERSIONDATE=20110521
#export VERSION=0.9.13
#export VERSIONDATE=20110713
#export VERSION=0.9.14
#export VERSIONDATE=20110913
#export VERSION=0.9.15
#export VERSIONDATE=20110928
#export VERSION=0.9.16
#export VERSIONDATE=20111104
#export VERSION=0.9.17
#export VERSIONDATE=20111120
#export VERSION=0.9.18
#export VERSIONDATE=20120123
#export VERSION=0.9.19
#export VERSIONDATE=20120201
####daemon.c:959: error: 'F_GETFL' undeclared (first use in this function)
#export VERSION=0.9.20
#export VERSIONDATE=20120531
#export VERSION=0.9.21
#export VERSIONDATE=20120720
#export VERSION=0.9.22
#export VERSIONDATE=20120902
#export VERSION=0.9.23
#export VERSIONDATE=20121110
#export VERSION=0.9.24
#export VERSIONDATE=20121226
####src/daemon/.libs/daemon.o:daemon.c:(.text+0x36bb): undefined reference to `_plibc_init_utf8'
#export VERSION=0.9.25
#export VERSIONDATE=20130206
#export VERSION=0.9.26
#export VERSIONDATE=20130330
#export VERSION=0.9.27
#export VERSIONDATE=20130506
#export VERSION=0.9.28
#export VERSIONDATE=20130719
####src/microhttpd/.libs/connection.o:connection.c:(.text+0x246): undefined reference to `_SHUTDOWN'
#export VERSION=0.9.29
#export VERSIONDATE=20130823
#export VERSION=0.9.30
#export VERSIONDATE=20130903
########config.status: error: cannot find input file: `doc/doxygen/Makefile.in'
#export VERSION=0.9.31
#export VERSIONDATE=20131019
#export VERSION=0.9.32
#export VERSIONDATE=20131204
#export VERSION=0.9.33
#export VERSIONDATE=20131222
####src/include/microhttpd.h:1065:32: error: unknown type name 'socklen_t'
#export VERSION=0.9.34
#export VERSIONDATE=20140225
#export VERSION=0.9.35
#export VERSIONDATE=20140503
#export VERSION=0.9.36
#export VERSIONDATE=20140526
#export VERSION=0.9.37
#export VERSIONDATE=20140602
####src/microspdy/io.c:32:1: error: conflicting types for 'SPDYF_io_set_daemon'
#wl-showstatus --package-version
#export DEPENDENCIES=pthreads,plibc,gettext
#export DEPENDENCIES=pthreads,plibc,gettext,gnutls,libgcrypt,libgpg-error,pthreads
#export VERSION=0.9.38
#export VERSIONDATE=20141007
#export VERSION=0.9.39
#export VERSIONDATE=20141224
#export VERSION=0.9.40
#export VERSIONDATE=20150407
#export VERSION=0.9.41
#export VERSIONDATE=20150430
#export VERSION=0.9.42
#export VERSIONDATE=20150513
#export VERSION=0.9.43
#export VERSIONDATE=20150916
#export VERSION=0.9.44
#export VERSIONDATE=20151002
#export VERSION=0.9.45
#export VERSIONDATE=20151101
#export VERSION=0.9.46
#export VERSIONDATE=20151110
#export VERSION=0.9.47
#export VERSIONDATE=20151204
#export VERSION=0.9.48
#export VERSIONDATE=20151219
#export VERSION=0.9.49
#export VERSIONDATE=20160409
#export VERSION=0.9.50
#export VERSIONDATE=20160602
#export VERSION=0.9.51
#export VERSIONDATE=20160828
#export VERSION=0.9.52
#export VERSIONDATE=20161018
#export VERSION=0.9.53
#export VERSIONDATE=20170412
#export VERSION=0.9.54
#export VERSIONDATE=20170503
#export VERSION=0.9.55
#export VERSIONDATE=20170529
#export VERSION=0.9.56
#export VERSIONDATE=20171125
#export VERSION=0.9.57
#export VERSIONDATE=20171128
#export VERSION=0.9.58
#export VERSIONDATE=20171208
#export VERSION=0.9.59
#export VERSIONDATE=20180202
#export VERSION=0.9.60
#export VERSIONDATE=20181107
#export VERSION=0.9.61
#export VERSIONDATE=20181129
#export VERSION=0.9.62
#export VERSIONDATE=20181209
#export VERSION=0.9.63
#export VERSIONDATE=20190211
#export VERSION=0.9.64
#export VERSIONDATE=20190610
#export VERSION=0.9.65
#export VERSIONDATE=20190706
#export VERSION=0.9.66
#export VERSIONDATE=20190801
#export VERSION=0.9.67
#export VERSIONDATE=20191018
#export VERSION=0.9.68
#export VERSIONDATE=20191027
#export VERSION=0.9.69
#export VERSIONDATE=20191215
#export VERSION=0.9.70
#export VERSIONDATE=20200209
#export VERSION=0.9.71
#export VERSIONDATE=20200629
#export VERSION=0.9.72
#export VERSIONDATE=20201229
#export VERSION=0.9.73
#export VERSIONDATE=20210425
#export VERSION=0.9.74
#export VERSIONDATE=20211220
#export VERSION=0.9.75
#export VERSIONDATE=20211227
export VERSION=0.9.76
export VERSIONDATE=20230228
wl-showstatus --package-version
export DEPENDENCIES=pthreads,gettext,gnutls,libgcrypt,file
export OPTIONALDEPENDENCIES=
export BUILDDEPENDENCIES=
export OPTIONALBUILDDEPENDENCIES=
export LICENSEFILE=COPYING
export LICENSETYPE=LGPL2
export DOWNLOADURL="http://ftp.gnu.org/gnu/libmicrohttpd/"
export INSTALLPREFIX=`pwd`/inst_$BASENAME-$VERSION
export DOWNLOADSOURCEURL=http://ftp.gnu.org/gnu/libmicrohttpd/$BASENAME-$VERSION.tar.gz
wl-showstatus download
wl-download -v -d $TARBALLDIR/$BASENAME $DOWNLOADSOURCEURL
wl-wait4deps
tar xz --force-local -f $TARBALLDIR/$BASENAME/$BASENAME-$VERSION.tar.gz
cd $BASENAME-$VERSION
## fix for missing sys/socket.h (version >= 0.4.0a)
#mkdir sys
#echo > sys/socket.h << EOF
##include <winsock2.h>
#typedef int socklen_t;
#EOF
## fix for missing sys/select.h (version >= 0.9.26)
#touch sys/select.h
## fix duplicate definitions in src/include/plibc.h (version >= 0.4.0a)
#patch -ulbf src/include/plibc.h << EOF
#--- src/include/plibc.h Sat Dec 27 08:49:29 2008
#+++ src/include/plibc.h Fri Mar  6 16:27:34 2009
#@@ -341,3 +341,3 @@
#   const char *hstrerror (int err);
#-  void gettimeofday (struct timeval *tp, void *tzp);
#+  //void gettimeofday (struct timeval *tp, void *tzp);
#   int mkstemp (char *tmplate);
#@@ -345,3 +345,3 @@
#   char *ctime (const time_t * clock);
#-  char *ctime_r (const time_t * clock, char *buf);
#+  //char *ctime_r (const time_t * clock, char *buf);
#   const char *inet_ntop (int af, const void *src, char *dst, size_t size);
#EOF
## fix src/include/plibc/plibc.h for 64-bit (version <= 0.4.6)
#patch -ulbf src/include/plibc/plibc.h << EOF
#--- src/include/plibc/plibc.h  2010-10-18 13:08:32 +0200
#+++ src/include/plibc/plibc.h  2012-07-18 10:01:06 +0200
#@@ -73,2 +73,3 @@
#
#+#ifndef __MINGW64__
# struct stat64
#@@ -87,2 +88,3 @@
# };
#+#endif
#
#@@ -212,3 +214,5 @@
# #define EWOULDBLOCK EAGAIN     /* Operation would block */
#+#ifndef EOVERFLOW
# #define EOVERFLOW 139 /* Value too large for defined data type */
#+#endif
#
#@@ -356,3 +360,5 @@
# #endif
#+#ifndef __MINGW64__
# int truncate(const char *fname, int distance);
#+#endif
# int statfs(const char *path, struct statfs *buf);
#@@ -464,4 +470,6 @@
#
#+#ifndef __MINGW64__
# #define strcasecmp(a, b) stricmp(a, b)
# #define strncasecmp(a, b, c) strnicmp(a, b, c)
#+#endif
#
#EOF
## fix undefined pthread_mutex_t in src/daemon/https/tls/gnutls_global.h
#mv src/daemon/https/tls/gnutls_global.h src/daemon/https/tls/gnutls_global.h.bak
#echo "#include <pthread.h>" > src/daemon/https/tls/gnutls_global.h
#cat src/daemon/https/tls/gnutls_global.h.bak >> src/daemon/https/tls/gnutls_global.h
## workaround missing config.h in pthread.h
#touch config.h
## fix non-blocking mode in src/daemon/daemon.c (version >= 0.4.1)
#patch -ulbf src/daemon/daemon.c << EOF
#--- src/daemon/daemon.c  Thu Mar 19 05:06:42 2009
#+++ src/daemon/daemon.c  Fri Mar 20 09:17:59 2009
#@@ -64,2 +64,5 @@
# #endif
#+#ifndef MSG_DONTWAIT
#+#define MSG_DONTWAIT 0
#+#endif
# #endif
#@@ -1278,3 +1281,7 @@
#     {
#+#ifdef __MINGW32__
#+      unsigned long sk_flags;
#+#else
#       int sk_flags;
#+#endif
# 
#@@ -1293,2 +1300,6 @@
#        * The others must immediately return. */
#+#ifdef __MINGW32__
#+      sk_flags = 1;
#+      ioctlsocket(socket_fd, FIONBIO, &sk_flags);
#+#else
#       sk_flags = fcntl (socket_fd, F_GETFL);
#@@ -1298,2 +1309,3 @@
#         goto thread_failed;
#+#endif
#EOF
## fix non-blocking mode in src/daemon/daemon.c (version >= 0.9.19)
#patch -ulbf src/daemon/daemon.c << EOF
#--- src/daemon/daemon.c  2012-01-24 16:07:32 +0100
#+++ src/daemon/daemon.c  2012-02-01 08:10:12 +0100
#@@ -958,2 +958,3 @@
#     /* make socket non-blocking */
#+#ifndef MINGW
#     int flags = fcntl (connection->socket_fd, F_GETFL);
#@@ -961,2 +962,6 @@
#         (0 != fcntl (connection->socket_fd, F_SETFL, flags | O_NONBLOCK)) )
#+#else
#+    unsigned long flags = 1;
#+    if (0 != ioctlsocket(connection->socket_fd, FIONBIO, &flags))
#+#endif
#       {
#EOF
## fix duplicate definitions (in SVN after version 0.4.1)
#mv src/hsearch.c src/hsearch.c.bak
#sed -e "s/#include <search.h>/typedef unsigned int size_t;/"  src/hsearch.c.bak > src/hsearch.c
#mv src/hsearch_r.c src/hsearch_r.c.bak
#sed -e "s/#include <search.h>//"  src/hsearch.c_r.bak > src/hsearch_r.c
#mv src/include/platform.h src/include/platform.h.bak
#sed -e "s/#include <search.h>//"  src/include/platform.h.bak > src/include/platform.h
## fix missing _win_tfind (plibc < 0.1.5)
#cat >> src/include/plibc.h << EOF
##include <search.h>
##define TSEARCH(k, r, c) tsearch(k, r, c)
##define TFIND(k, r, c) tfind(k, r, c)
##define TDELETE(k, r, c) tdelete(k, r, c)
#EOF
##fix src/include/plibc.h for 64-bit (version <= 0.4.6)
#patch -ulbf src/include/plibc.h << EOF
#--- src/include/plibc.h  2009-10-11 11:21:22 +0200
#+++ src/include/plibc.h  2011-10-21 15:34:52 +0200
#@@ -79,2 +79,3 @@
#
#+/*
#   struct stat64
#@@ -93,2 +94,3 @@
#   };
#+*/
#
#@@ -201,3 +203,3 @@
# #define EWOULDBLOCK EAGAIN      /* Operation would block */
#-#define EOVERFLOW 139           /* Value too large for defined data type */
#+//#define EOVERFLOW 139           /* Value too large for defined data type */
#
#@@ -345,3 +347,3 @@
# #endif
#-  int truncate (const char *fname, int distance);
#+  //int truncate (const char *fname, int distance);
#   int statfs (const char *path, struct statfs *buf);
#@@ -450,4 +452,4 @@
#
#-#define strcasecmp(a, b) stricmp(a, b)
#-#define strncasecmp(a, b, c) strnicmp(a, b, c)
#+//#define strcasecmp(a, b) stricmp(a, b)
#+//#define strncasecmp(a, b, c) strnicmp(a, b, c)
#
#EOF
## fix src/daemon/connection.c to never return size MHD_SIZE_UNKNOWN
#patch -ulbf src/daemon/connection.c << EOF
#--- src/daemon/connection.c  2010-03-11 13:34:20 +0100
#+++ src/daemon/connection.c  2010-04-01 10:02:50 +0200
#@@ -498,4 +498,5 @@
#    }
#-  else if (NULL == MHD_get_response_header (connection->response,
#-                                            MHD_HTTP_HEADER_CONTENT_LENGTH))
#+  else if ((NULL == MHD_get_response_header (connection->response,
#+                                            MHD_HTTP_HEADER_CONTENT_LENGTH)) &&
#+           ((size_t)MHD_SIZE_UNKNOWN != (size_t)connection->response->total_size))
#    {
#EOF
## fix "error: expected expression before ')' token" in src/daemon/daemon.c (version = 0.9.2)
#patch -ulbf src/daemon/daemon.c << EOF
#--- src/daemon/daemon.c  2010-10-15 14:19:16 +0200
#+++ src/daemon/daemon.c  2010-10-18 17:39:14 +0200
#@@ -1399,3 +1399,3 @@
#              FPRINTF (stderr,
#-                      "Specified thread pool size too big\n");
#+                      "Specified thread pool size too big\n", NULL);
# #endif
#EOF
## fix missing socklen_t in src/include/microhttpd.h (version >= 0.9.20)
#mv src/include/microhttpd.h src/include/microhttpd.h.bak
#echo "#include <ws2tcpip.h>" > src/include/microhttpd.h
#cat src/include/microhttpd.h.bak >> src/include/microhttpd.h
## fix missing socklen_t in src/include/microhttpd.h (version >= 0.9.22)
#cat >> src/include/platform.h << EOF
##include <winsock2.h>
##include <ws2tcpip.h>
##ifndef SHUT_RD
##define SHUT_RD 0
##define SHUT_WR 1
##define SHUT_RDWR 2
##endif
##ifndef ENOTCONN
##define ENOTCONN WSAENOTCONN
##define EWOULDBLOCK WSAEWOULDBLOCK
##endif
#EOF
## fix unresolved plibc_init_utf8 in src/daemon/daemon.c (version >= 0.9.22)
#mv src/daemon/daemon.c src/daemon/daemon.c.bak
#echo "#define plibc_init_utf8(g,p,n)" >> src/daemon/daemon.c
#cat src/daemon/daemon.c.bak >> src/daemon/daemon.c
## fix missing SOCKET in src/microhttpd/daemon.c (version >= 0.9.27)
#mv src/microhttpd/daemon.c src/microhttpd/daemon.c.bak2
#echo "#include <plibc.h>" > src/microhttpd/daemon.c
##sed -e "s/SOCKET/socket/g; s/socket_ERROR/-1/g" src/microhttpd/daemon.c.bak2 >> src/microhttpd/daemon.c
#sed -e "s/\([^_]\)SOCKET\([^_]\)/\1socket\2/g" src/microhttpd/daemon.c.bak2 >> src/microhttpd/daemon.c
# fix missing src/microhttpd/autoinit_funcs.h (version >= 0.9.39)
touch src/microhttpd/autoinit_funcs.h
## skip making examples
#cat > src/examples/Makefile.in << EOF
#clean:
#all:
#install:
#install-strip:
#EOF
## fix building DLLs on 64-bit
#if ( echo $RUNPLATFORM | grep -q x86_64 ); then
# autoreconf -f -i -I m4 -I $MINGWPREFIX/share/aclocal
#fi
## fix configure for 64-bit (version <= 0.4.6)
#mv configure configure.bak
#sed -e "s/-pthreads/-lpthread/; s/ -no-undefined/ -Wl,-no-undefined/" configure.bak > configure
## fix configure for 64-bit (version >= 0.9.15 <= 0.9.17)
#mv configure configure.bak
#sed -e "s/-plibc/-lplibc/; s/ -no-undefined/ -Wl,-no-undefined/" configure.bak > configure
#make check
# --disable-messages is required to avoid a compile error (version >= 0.9.0)
#PERL="$PERLDIR/bin/perl.exe" ./configure --prefix=$INSTALLPREFIX --build=$BUILDPLATFORM --host=$RUNPLATFORM && make install
wl-showstatus configure &&
 #./configure --prefix=$INSTALLPREFIX --build=$BUILDPLATFORM --host=$RUNPLATFORM CFLAGS="-DMAP_ANONYMOUS=0" LDFLAGS="-Wl,--allow-multiple-definition" && make install
 #./configure --prefix=$INSTALLPREFIX --build=$BUILDPLATFORM --host=$RUNPLATFORM LDFLAGS="-Wl,--allow-multiple-definition" && make install
 #./configure --prefix=$INSTALLPREFIX --build=$BUILDPLATFORM --host=$RUNPLATFORM CFLAGS="-Drandom=rand" LDFLAGS="-static-libgcc" && make install
 ##./configure --prefix=$INSTALLPREFIX --build=$BUILDPLATFORM --host=$RUNPLATFORM --enable-messages --enable-curl && make install
 #./configure --prefix=$INSTALLPREFIX --build=$BUILDPLATFORM --host=$RUNPLATFORM CFLAGS="-Drandom=rand" --disable-messages &&
 #./configure --prefix=$INSTALLPREFIX --build=$BUILDPLATFORM --host=$RUNPLATFORM CFLAGS="-Drandom=rand" &&
 ./configure --prefix=$INSTALLPREFIX --build=$BUILDPLATFORM --host=$RUNPLATFORM --disable-examples &&
 wl-showstatus build-install &&
 # fix building DLLs
 mv libtool libtool.bak &&
 sed -e "s/\(allow_undefined=\)yes/\1no/" libtool.bak > libtool &&
 make install-strip &&
 rm -f $INSTALLPREFIX/bin/demo.exe &&
 wl-makepackage -c -d && wl-install -d $BASENAME-$VERSION && cd .. && wl-showstatus cleanup && rm -rf $BASENAME-$VERSION



