#export NAME="nss"
#export STATUS=
#export URL=http://www.mozilla.org/projects/security/pki/nss/
#export BASENAME=nss
#export DESCRIPTION="Network Security Services (NSS) is a set of libraries designed to support cross-platform development of security-enabled client and server applications. Applications built with NSS can support SSL v2 and v3, TLS, PKCS #5, PKCS #7, PKCS #11, PKCS #12, S/MIME, X.509 v3 certificates, and other security standards."
#export CATEGORY=portability
#export TYPE=library
##export VERSION=3.12.6
##export VERSION=3.12.6-with-nspr-4.8.4
##export VERSIONDATE=
##export VERSION=3.12.8
##export VERSIONDATE=20100924
##export VERSION=3.12.10
##export VERSIONDATE=20110507
##export VERSION=3.12.11
##export VERSIONDATE=20110810
#####nsinstall.c:46: error: conflicting types for 'mode_t'
#####nsinstall.c:137: error: too many arguments to function 'mkdir'
##export DEPENDENCIES=
##export VERSION=3.13.1
##export VERSIONDATE=20111028
##export VERSION=3.13.2
##export VERSIONDATE=20120216
##export VERSION=3.13.3
##export VERSIONDATE=20120222
##export VERSION=3.13.4
##export VERSIONDATE=20120407
##export VERSION=3.13.5
##export VERSIONDATE=20120602
#####mozilla/security/nss/lib/util/secasn1.h:49:21: fatal error: plarena.h: No such file or directory
#####Note: plarena.h is in NSPR
##export VERSION=3.13.6
##export VERSIONDATE=20120811
##export VERSION=3.14
##export VERSIONDATE=20121022
##export VERSION=3.14.1
##export VERSIONDATE=20121215
##export VERSION=3.14.2
##export VERSIONDATE=20130201
#export VERSION=3.14.3
#export VERSIONDATE=20130216
##export VERSION=3.14.5
##export VERSIONDATE=20131111
#####ar.exe: WINNT6.1_DBG.OBJ\secdig.obj: No such file or directory
#####ar.exe: WINNT6.1_DBG.OBJ\quickder.obj: File format not recognized
#wl-showstatus --package-version
#export DEPENDENCIES=nspr
#export OPTIONALDEPENDENCIES=xulrunner
#export BUILDDEPENDENCIES=
#export OPTIONALBUILDDEPENDENCIES=
##export LICENSEFILE=
##export LICENSETYPE="Mozilla Public License / GPL / LGPL"
#export LICENSEFILE=COPYING
#export LICENSETYPE=MPL
#export DOWNLOADURL="http://ftp.mozilla.org/pub/mozilla.org/security/nss/releases/ NSS_ _RTM/"
#export INSTALLPREFIX=`pwd`/inst_$BASENAME-$VERSION
#export DOWNLOADSOURCEURL=http://ftp.mozilla.org/pub/mozilla.org/security/nss/releases/NSS_`echo $VERSION|sed -e "s/\./_/g"`_RTM/src/nss-$VERSION.tar.gz
#wl-download -v -d $TARBALLDIR/$BASENAME $DOWNLOADSOURCEURL
#wl-wait4deps
#tar xz --force-local -f $TARBALLDIR/$BASENAME/$BASENAME-$VERSION.tar.gz
#cd $BASENAME-$VERSION
#
#patch -ulbf mozilla/security/coreconf/nsinstall/nsinstall.c << EOF
#--- mozilla/security/coreconf/nsinstall/nsinstall.c  2009-06-05 04:15:16 +0200
#+++ mozilla/security/coreconf/nsinstall/nsinstall.c  2011-10-27 17:44:34 +0200
#@@ -1 +1,9 @@
#+#define fchmod(f,p) 0
#+#define fchown(tofd,uid,gid) 0
#+#define lstat(path, sb) stat((path), (sb))
#+#define chown(toname,uid,gid) 0
#+#define lchown(toname,uid,gid) 0
#+#define S_ISLNK(m) 0
#+#define readlink(rpath,buf,path_max) -1
#+#define symlink(name1,name2) -1
# /* ***** BEGIN LICENSE BLOCK *****
#@@ -45,3 +53,23 @@
# #include <windows.h>
#-typedef unsigned int mode_t;
#+//typedef unsigned int mode_t;
#+#include <sys/utime.h>
#+#include <getopt.h>
#+#include <errno.h>
#+typedef int uid_t;
#+typedef int gid_t;
#+struct passwd {
#+ int pw_uid;
#+ //char *pw_name;
#+ //char *pw_dir;
#+ //char *pw_shell;
#+};
#+struct group {
#+ int gr_gid;
#+ //char *gr_name;
#+ //char **gr_mem;
#+};
#+#define getpwnam(username) NULL
#+#define getgrnam(groupname) NULL
#+//#include <stdio.h>
#+//#define fail
# #else
#@@ -136,3 +164,7 @@
#     }
#+#ifndef _WIN32
#     rv = mkdir(path, mode);
#+#else
#+    rv = mkdir(path);
#+#endif
#     if (rv) {
#@@ -306,3 +338,7 @@
#            }
#+#ifndef _WIN32
#            if (!exists && mkdir(toname, mode) < 0) {
#+#else
#+           if (!exists && mkdir(toname) < 0) {
#+#endif
#                /* we probably have two nsinstall programs in a race here. */
#EOF
##cat mozilla/security/coreconf/nsinstall/pathsub.c >> mozilla/security/coreconf/nsinstall/nsinstall.c
#echo "#include \"pathsub.c\"" >> mozilla/security/coreconf/nsinstall/nsinstall.c
#
##mv mozilla/security/nss/lib/freebl/mpi/Makefile.win mozilla/security/nss/lib/freebl/mpi/Makefile.win.bak
##sed -e "s/^\(CC=\)cl/\1gcc/" mozilla/security/nss/lib/freebl/mpi/Makefile.win.bak > mozilla/security/nss/lib/freebl/mpi/Makefile.win
#
##mv mozilla/security/coreconf/WIN32.mk mozilla/security/coreconf/WIN32.mk.bak
##sed -e "s/\( *= *\)cl/\1gcc/; s/-Od//; s/-Zi//; s/-W3//; s/-we[0-9][0-9][0-9][0-9]//g; s/-GT//; s/-nologo//; s/\/FIXED:NO//; s/-mno-cygwin//" mozilla/security/coreconf/WIN32.mk.bak > mozilla/security/coreconf/WIN32.mk
#
##mv mozilla/security/coreconf/WINNT.mk mozilla/security/coreconf/WINNT.mk.bak
##sed -e "s/-GT//" mozilla/security/coreconf/WINNT.mk.bak > mozilla/security/coreconf/WINNT.mk
#
###export CVSROOT=":pserver:anonymous@cvs-mirror.mozilla.org:/cvsroot"
###export JAVA_HOME="/c/jdk1.6.0_27"
##export NO_MDUPDATE="1"
##export NSDISTMODE="copy"
##export BUILD_OPT="1"
##export OS_TARGET="WIN95"
##export NS_USE_GCC="1"
#
#patch -ulbf mozilla/security/coreconf/rules.mk << EOF
#--- mozilla/security/coreconf/rules.mk  2010-04-26 01:37:40.000000000 +0200
#+++ mozilla/security/coreconf/rules.mk  2011-11-11 21:39:26.576273015 +0100
#@@ -400,7 +400,7 @@
# PWD := \$(shell pwd)
# ifeq (,\$(findstring ;,\$(PATH)))
# ifndef USE_MSYS
#-PWD := \$(subst \\,/,\$(shell cygpath -w \$(PWD)))
#+#PWD := \$(subst \\,/,\$(shell cygpath -w \$(PWD)))
# endif
# endif
# 
#EOF
## fix mozilla/security/coreconf/WIN32.mk
#mv mozilla/security/coreconf/WIN32.mk mozilla/security/coreconf/WIN32.mk.bak
##sed -e "s/-mno-cygwin//" mozilla/security/coreconf/WIN32.mk.bak >  mozilla/security/coreconf/WIN32.mk
#sed -e "s/\( *= *\)cl/\1gcc/; s/-Od//; s/-Zi//; s/-W3//; s/-we[0-9][0-9][0-9][0-9]//g; s/-GT//; s/-nologo//; s/\/FIXED:NO//; s/-mno-cygwin//" mozilla/security/coreconf/WIN32.mk.bak > mozilla/security/coreconf/WIN32.mk
#patch -ulbf mozilla/security/coreconf/WINNT.mk << EOF
#--- mozilla/security/coreconf/WINNT.mk  2009-02-14 06:51:10.000000000 +0100
#+++ mozilla/security/coreconf/WINNT.mk  2011-11-11 21:39:26.580272977 +0100
#@@ -46,7 +46,7 @@
# #
# # Win NT needs -GT so that fibers can work
# #
#-OS_CFLAGS += -GT
#+#OS_CFLAGS += -GT
# 
# # WINNT uses the lib prefix, Win95 and WinCE don't
# NSPR31_LIB_PREFIX = lib
#EOF
#patch -ulbf mozilla/security/nss/cmd/crmftest/Makefile << EOF
#--- mozilla/security/nss/cmd/crmftest/Makefile  2005-11-14 01:17:21.000000000 +0100
#+++ mozilla/security/nss/cmd/crmftest/Makefile  2011-11-11 21:39:26.596273012 +0100
#@@ -90,7 +90,7 @@
# LDDIST = \$(DIST)/lib
# 
# ifeq (,\$(filter-out WIN%,\$(OS_TARGET)))
#-EXTRA_LIBS += \$(LDDIST)/sectool.lib
#+#EXTRA_LIBS += \$(LDDIST)/sectool.lib
# endif
# 
# include ../platrules.mk
#EOF
#patch -ulbf mozilla/security/nss/cmd/pk11mode/Makefile << EOF
#--- mozilla/security/nss/cmd/pk11mode/Makefile  2009-03-31 01:40:52.000000000 +0200
#+++ mozilla/security/nss/cmd/pk11mode/Makefile  2011-11-11 21:39:26.596273012 +0100
#@@ -61,9 +61,9 @@
# ifeq (\$(OS_ARCH), WINNT)
# 
# EXTRA_LIBS += \\
#-  \$(NSPR_LIB_DIR)/\$(NSPR31_LIB_PREFIX)plc4.\$(LIB_SUFFIX) \\
#-  \$(NSPR_LIB_DIR)/\$(NSPR31_LIB_PREFIX)plds4.\$(LIB_SUFFIX) \\
#-  \$(NSPR_LIB_DIR)/\$(NSPR31_LIB_PREFIX)nspr4.\$(LIB_SUFFIX) \\
#+  \$(NSPR_LIB_DIR)/\$(NSPR31_LIB_PREFIX)plc4\$(IMPORT_LIB_SUFFIX) \\
#+  \$(NSPR_LIB_DIR)/\$(NSPR31_LIB_PREFIX)plds4\$(IMPORT_LIB_SUFFIX) \\
#+  \$(NSPR_LIB_DIR)/\$(NSPR31_LIB_PREFIX)nspr4\$(IMPORT_LIB_SUFFIX) \\
#   \$(NULL)
# 
# else
#EOF
#patch -ulbf mozilla/security/nss/cmd/shlibsign/Makefile << EOF
#--- mozilla/security/nss/cmd/shlibsign/Makefile  2009-08-07 21:06:37.000000000 +0200
#+++ mozilla/security/nss/cmd/shlibsign/Makefile  2011-11-11 21:39:26.596273012 +0100
#@@ -59,9 +59,9 @@
# ifeq (\$(OS_ARCH), WINNT)
# 
# EXTRA_LIBS += \\
#-  \$(NSPR_LIB_DIR)/\$(NSPR31_LIB_PREFIX)plc4.\$(LIB_SUFFIX) \\
#-  \$(NSPR_LIB_DIR)/\$(NSPR31_LIB_PREFIX)plds4.\$(LIB_SUFFIX) \\
#-  \$(NSPR_LIB_DIR)/\$(NSPR31_LIB_PREFIX)nspr4.\$(LIB_SUFFIX) \\
#+  \$(NSPR_LIB_DIR)/\$(NSPR31_LIB_PREFIX)plc4\$(IMPORT_LIB_SUFFIX) \\
#+  \$(NSPR_LIB_DIR)/\$(NSPR31_LIB_PREFIX)plds4\$(IMPORT_LIB_SUFFIX) \\
#+  \$(NSPR_LIB_DIR)/\$(NSPR31_LIB_PREFIX)nspr4\$(IMPORT_LIB_SUFFIX) \\
#   \$(NULL)
# 
# else
#@@ -85,8 +85,8 @@
# endif
# CHECKLOC = \$(CHECKLIBS:.\$(DLL_SUFFIX)=.chk)
# 
#-MD_LIB_RELEASE_FILES = \$(CHECKLOC)
#-ALL_TRASH += \$(CHECKLOC)
#+MD_LIB_RELEASE_FILES = # \$(CHECKLOC)
#+#ALL_TRASH += \$(CHECKLOC)
# 
# 
# #######################################################################
#@@ -120,5 +120,5 @@
#   \$(call core_abspath,\$(NSPR_LIB_DIR)) \$(call core_abspath,\$<)
# endif
# 
#-libs install :: \$(CHECKLOC)
#+libs install :: #\$(CHECKLOC)
# 
#EOF
#patch -ulbf mozilla/security/nss/cmd/shlibsign/mangle/Makefile << EOF
#--- mozilla/security/nss/cmd/shlibsign/mangle/Makefile  2008-11-20 16:44:24.000000000 +0100
#+++ mozilla/security/nss/cmd/shlibsign/mangle/Makefile  2011-11-11 21:39:26.600273013 +0100
#@@ -59,9 +59,9 @@
# ifeq (\$(OS_ARCH), WINNT)
# 
# EXTRA_LIBS += \\
#-  \$(NSPR_LIB_DIR)/\$(NSPR31_LIB_PREFIX)plc4.\$(LIB_SUFFIX) \\
#-  \$(NSPR_LIB_DIR)/\$(NSPR31_LIB_PREFIX)plds4.\$(LIB_SUFFIX) \\
#-  \$(NSPR_LIB_DIR)/\$(NSPR31_LIB_PREFIX)nspr4.\$(LIB_SUFFIX) \\
#+  \$(NSPR_LIB_DIR)/\$(NSPR31_LIB_PREFIX)plc4\$(IMPORT_LIB_SUFFIX) \\
#+  \$(NSPR_LIB_DIR)/\$(NSPR31_LIB_PREFIX)plds4\$(IMPORT_LIB_SUFFIX) \\
#+  \$(NSPR_LIB_DIR)/\$(NSPR31_LIB_PREFIX)nspr4\$(IMPORT_LIB_SUFFIX) \\
#   \$(NULL)
# 
# else
#EOF
#patch -ulbf mozilla/security/nss/lib/ckfw/builtins/config.mk << EOF
#--- mozilla/security/nss/lib/ckfw/builtins/config.mk  2009-06-11 02:55:34.000000000 +0200
#+++ mozilla/security/nss/lib/ckfw/builtins/config.mk  2011-11-11 21:39:26.600273013 +0100
#@@ -48,7 +48,7 @@
# 
# ifeq (,\$(filter-out WIN%,\$(OS_TARGET)))
#     SHARED_LIBRARY = \$(OBJDIR)/\$(DLL_PREFIX)\$(LIBRARY_NAME)\$(LIBRARY_VERSION).\$(DLL_SUFFIX)
#-    RES = \$(OBJDIR)/\$(LIBRARY_NAME).res
#+    RES = \$(OBJDIR)/\$(LIBRARY_NAME).res.o
#     RESNAME = \$(LIBRARY_NAME).rc
# endif
# 
#EOF
#patch -ulbf mozilla/security/nss/lib/ckfw/capi/Makefile << EOF
#--- mozilla/security/nss/lib/ckfw/capi/Makefile  2009-07-29 22:15:19.000000000 +0200
#+++ mozilla/security/nss/lib/ckfw/capi/Makefile  2011-11-11 21:39:26.608273006 +0100
#@@ -75,6 +75,9 @@
#   -lplc4 \\
#   -lplds4 \\
#   -lnspr4 \\
#+        -lcrypt32 \\
#+        -ladvapi32 \\
#+        -lrpcrt4 \\
#   \$(NULL)
# endif
# 
#EOF
#patch -ulbf mozilla/security/nss/lib/freebl/config.mk << EOF
#--- mozilla/security/nss/lib/freebl/config.mk  2010-08-18 00:27:12.000000000 +0200
#+++ mozilla/security/nss/lib/freebl/config.mk  2011-11-11 21:39:26.608273006 +0100
#@@ -82,7 +82,7 @@
# # don't want the 32 in the shared library name
# SHARED_LIBRARY = \$(OBJDIR)/\$(DLL_PREFIX)\$(LIBRARY_NAME)\$(LIBRARY_VERSION).\$(DLL_SUFFIX)
# 
#-RES     = \$(OBJDIR)/\$(LIBRARY_NAME).res
#+RES     = \$(OBJDIR)/\$(LIBRARY_NAME).res.o
# RESNAME = freebl.rc
# 
# ifndef WINCE
#EOF
#patch -ulbf mozilla/security/nss/lib/freebl/Makefile << EOF
#--- mozilla/security/nss/lib/freebl/Makefile  2011-02-06 11:13:27.000000000 +0100
#+++ mozilla/security/nss/lib/freebl/Makefile  2011-11-11 21:39:26.608273006 +0100
#@@ -167,6 +167,17 @@
#     endif
# endif
# else
#+# 64-bit Windows
#+ifdef NS_USE_GCC
#+    # win64/gcc - use the x86 code for now, skipping optimization
#+    ifdef BUILD_OPT
#+  OPTIMIZER += -Os
#+    endif
#+    ASFILES  =
#+    DEFINES += -DMPI_AMD64 -DMP_USE_UINT_DIGIT
#+    DEFINES += -DMP_CHAR_STORE_SLOW -DMP_IS_LITTLE_ENDIAN
#+else
#+# MSVC
#     # -DMP_NO_MP_WORD
#     ifdef BUILD_OPT
#   OPTIMIZER += -Ox  # maximum optimization for freebl
#@@ -178,6 +189,7 @@
#     MPI_SRCS += mpi_amd64.c
# endif
# endif
#+endif
# 
# ifeq (\$(OS_TARGET),WINCE)
#     DEFINES += -DMP_ARGCHK=0  # no assert in WinCE
#EOF
#patch -ulbf mozilla/security/nss/lib/freebl/mpi/mpi-priv.h << EOF
#--- mozilla/security/nss/lib/freebl/mpi/mpi-priv.h  2010-07-20 03:26:02.000000000 +0200
#+++ mozilla/security/nss/lib/freebl/mpi/mpi-priv.h  2011-11-11 21:39:26.632273000 +0100
#@@ -254,7 +254,7 @@
# #define MPI_ASM_DECL
# #endif
# 
#-#ifdef MPI_AMD64
#+#if defined(MPI_AMD64) && defined(MP_ASSEMBLY_MULTIPLY)
# 
# mp_digit MPI_ASM_DECL s_mpv_mul_set_vec64(mp_digit*, mp_digit *, mp_size, mp_digit);
# mp_digit MPI_ASM_DECL s_mpv_mul_add_vec64(mp_digit*, const mp_digit*, mp_size, mp_digit);
#EOF
#patch -ulbf mozilla/security/nss/lib/nss/config.mk << EOF
#--- mozilla/security/nss/lib/nss/config.mk  2009-12-15 23:22:31.000000000 +0100
#+++ mozilla/security/nss/lib/nss/config.mk  2011-11-11 21:39:26.632273000 +0100
#@@ -42,7 +42,7 @@
# SHARED_LIBRARY = \$(OBJDIR)/\$(DLL_PREFIX)\$(LIBRARY_NAME)\$(LIBRARY_VERSION).\$(DLL_SUFFIX)
# IMPORT_LIBRARY = \$(OBJDIR)/\$(IMPORT_LIB_PREFIX)\$(LIBRARY_NAME)\$(LIBRARY_VERSION)\$(IMPORT_LIB_SUFFIX)
# 
#-RES = \$(OBJDIR)/\$(LIBRARY_NAME).res
#+RES = \$(OBJDIR)/\$(LIBRARY_NAME).res.o
# RESNAME = \$(LIBRARY_NAME).rc
# 
# ifdef NS_USE_GCC
#EOF
#patch -ulbf mozilla/security/nss/lib/smime/config.mk << EOF
#--- mozilla/security/nss/lib/smime/config.mk  2009-06-11 02:55:47.000000000 +0200
#+++ mozilla/security/nss/lib/smime/config.mk  2011-11-11 21:39:26.632273000 +0100
#@@ -43,7 +43,7 @@
# SHARED_LIBRARY = \$(OBJDIR)/\$(DLL_PREFIX)\$(LIBRARY_NAME)\$(LIBRARY_VERSION).\$(DLL_SUFFIX)
# IMPORT_LIBRARY = \$(OBJDIR)/\$(IMPORT_LIB_PREFIX)\$(LIBRARY_NAME)\$(LIBRARY_VERSION)\$(IMPORT_LIB_SUFFIX)
# 
#-RES = \$(OBJDIR)/smime.res
#+RES = \$(OBJDIR)/smime.res.o
# RESNAME = smime.rc
# 
# ifdef NS_USE_GCC
#EOF
#patch -ulbf mozilla/security/nss/lib/softoken/config.mk << EOF
#--- mozilla/security/nss/lib/softoken/config.mk  2010-06-12 02:58:33.000000000 +0200
#+++ mozilla/security/nss/lib/softoken/config.mk  2011-11-11 21:39:26.632273000 +0100
#@@ -49,7 +49,7 @@
# SHARED_LIBRARY = \$(OBJDIR)/\$(DLL_PREFIX)\$(LIBRARY_NAME)\$(LIBRARY_VERSION).\$(DLL_SUFFIX)
# IMPORT_LIBRARY = \$(OBJDIR)/\$(IMPORT_LIB_PREFIX)\$(LIBRARY_NAME)\$(LIBRARY_VERSION)\$(IMPORT_LIB_SUFFIX)
# 
#-RES = \$(OBJDIR)/\$(LIBRARY_NAME).res
#+RES = \$(OBJDIR)/\$(LIBRARY_NAME).res.o
# RESNAME = \$(LIBRARY_NAME).rc
# 
# ifdef NS_USE_GCC
#EOF
#patch -ulbf mozilla/security/nss/lib/softoken/legacydb/config.mk << EOF
#--- mozilla/security/nss/lib/softoken/legacydb/config.mk  2009-06-11 02:55:49.000000000 +0200
#+++ mozilla/security/nss/lib/softoken/legacydb/config.mk  2011-11-11 21:39:26.632273000 +0100
#@@ -51,7 +51,7 @@
# SHARED_LIBRARY = \$(OBJDIR)/\$(DLL_PREFIX)\$(LIBRARY_NAME)\$(LIBRARY_VERSION).\$(DLL_SUFFIX)
# IMPORT_LIBRARY = \$(OBJDIR)/\$(IMPORT_LIB_PREFIX)\$(LIBRARY_NAME)\$(LIBRARY_VERSION)\$(IMPORT_LIB_SUFFIX)
# 
#-RES = \$(OBJDIR)/\$(LIBRARY_NAME).res
#+RES = \$(OBJDIR)/\$(LIBRARY_NAME).res.o
# RESNAME = \$(LIBRARY_NAME).rc
# 
# ifdef NS_USE_GCC
#EOF
#patch -ulbf mozilla/security/nss/lib/ssl/config.mk << EOF
#--- mozilla/security/nss/lib/ssl/config.mk  2010-02-04 20:09:08.000000000 +0100
#+++ mozilla/security/nss/lib/ssl/config.mk  2011-11-11 21:39:26.632273000 +0100
#@@ -55,7 +55,7 @@
# SHARED_LIBRARY = \$(OBJDIR)/\$(DLL_PREFIX)\$(LIBRARY_NAME)\$(LIBRARY_VERSION).\$(DLL_SUFFIX)
# IMPORT_LIBRARY = \$(OBJDIR)/\$(IMPORT_LIB_PREFIX)\$(LIBRARY_NAME)\$(LIBRARY_VERSION)\$(IMPORT_LIB_SUFFIX)
# 
#-RES = \$(OBJDIR)/ssl.res
#+RES = \$(OBJDIR)/ssl.res.o
# RESNAME = ssl.rc
# 
# ifdef NS_USE_GCC
#EOF
#patch -ulbf mozilla/security/nss/lib/sysinit/config.mk << EOF
#--- mozilla/security/nss/lib/sysinit/config.mk  2010-02-16 20:38:42.000000000 +0100
#+++ mozilla/security/nss/lib/sysinit/config.mk  2011-11-11 21:39:26.636273000 +0100
#@@ -47,8 +47,8 @@
# SHARED_LIBRARY = \$(OBJDIR)/\$(DLL_PREFIX)\$(LIBRARY_NAME)\$(LIBRARY_VERSION).\$(DLL_SUFFIX)
# IMPORT_LIBRARY = \$(OBJDIR)/\$(IMPORT_LIB_PREFIX)\$(LIBRARY_NAME)\$(LIBRARY_VERSION)\$(IMPORT_LIB_SUFFIX)
# 
#-RES = \$(OBJDIR)/\$(LIBRARY_NAME).res
#-RESNAME = \$(LIBRARY_NAME).rc
#+#RES = \$(OBJDIR)/\$(LIBRARY_NAME).res
#+#RESNAME = \$(LIBRARY_NAME).rc
# 
# ifdef NS_USE_GCC
# EXTRA_SHARED_LIBS += \\
#EOF
#patch -ulbf mozilla/security/nss/lib/util/config.mk << EOF
#--- mozilla/security/nss/lib/util/config.mk  2009-12-15 23:22:31.000000000 +0100
#+++ mozilla/security/nss/lib/util/config.mk  2011-11-11 21:39:26.636273000 +0100
#@@ -42,7 +42,7 @@
# SHARED_LIBRARY = \$(OBJDIR)/\$(DLL_PREFIX)\$(LIBRARY_NAME)\$(LIBRARY_VERSION).\$(DLL_SUFFIX)
# IMPORT_LIBRARY = \$(OBJDIR)/\$(IMPORT_LIB_PREFIX)\$(LIBRARY_NAME)\$(LIBRARY_VERSION)\$(IMPORT_LIB_SUFFIX)
# 
#-RES = \$(OBJDIR)/\$(LIBRARY_NAME).res
#+RES = \$(OBJDIR)/\$(LIBRARY_NAME).res.o
# RESNAME = \$(LIBRARY_NAME).rc
# 
# ifdef NS_USE_GCC
#EOF
##patch -ulbf mozilla/security/nss/lib/util/pkcs11n.h << EOF
##--- mozilla/security/nss/lib/util/pkcs11n.h  2011-09-14 03:21:10.000000000 +0200
##+++ mozilla/security/nss/lib/util/pkcs11n.h  2011-11-16 09:22:47.018780002 +0100
##@@ -362,7 +362,7 @@
##  *  cast the resulting value to the deprecated type in the #define, thus
##  *  producting the warning when the #define is used.
##  */
##-#if (__GNUC__  == 4) && (__GNUC_MINOR < 5)
##+#if (__GNUC__  == 4) && (__GNUC_MINOR__ < 5)
## /* The mac doesn't like the friendlier deprecate messages. I'm assuming this
##  * is a gcc version issue rather than mac or ppc specific */
## typedef CK_TRUST __CKT_NSS_UNTRUSTED __attribute__((deprecated));
##EOF
## remove read-only attributes to avoid nsinstall crash
#attrib -r mozilla\\dist\\public\\nss\\*.*
#attrib -r mozilla\\dist\\private\\nss\\*.*
#
#if ( echo $RUNPLATFORM | grep -q x86_64 ); then
# export USE_64=1
#fi
#make -j1 -C mozilla/security/coreconf CC=${CC:-gcc} &&
# make -j1 -C mozilla/security/coreconf/nsinstall CC=${CC:-gcc} &&
# make -j1 -C mozilla/security/coreconf/nsinstall nsinstall CC=${CC:-gcc} &&
# ## nsinstall.exe fails on Windows Vista or higher with: "execvp: nsinstall: Bad file number", fix by running MSYS with elevated privileges (Run as administrator)
# #PATH=`pwd`/mozilla/security/coreconf/nsinstall:$PATH make -j1 -C mozilla/security/nss -f Makefile CC=${CC:-gcc} &&
# #cp -f mozilla/security/coreconf/nsinstall/nsinstall.exe mozilla/security/coreconf/nsinstall/nsinst.exe &&
# #PATH=`pwd`/mozilla/security/coreconf/nsinstall:$PATH make -j1 -C mozilla/security/nss -f Makefile CC="${CC:-gcc} -I$MINGWPREFIX/include/nspr" AR="ar cru" NSINSTALL="$(pwd)/mozilla/security/coreconf/nsinstall/nsinst.exe" &&
# #PATH=`pwd`/mozilla/security/coreconf/nsinstall:$PATH make -j1 -C mozilla/security/nss -f Makefile CC="${CC:-gcc} -I$MINGWPREFIX/include/nspr" AR="ar cru" NSINSTALL="$PYDIR/python.exe $(pwd)/../xulrunner-17.0.1/mozilla-release/js/src/config/nsinstall.py" &&
# make -j1 -C mozilla/security/nss -f Makefile CC="${CC:-gcc} -I$MINGWPREFIX/include/nspr" AR="ar cru" NSINSTALL="$PYDIR/python.exe $MINGWPREFIX/bin/nsinstall.py" &&
#    echo OK



export NAME="nss"
export STATUS=
export URL=http://www.mozilla.org/projects/security/pki/nss/
export BASENAME=nss
export DESCRIPTION="Network Security Services (NSS) is a set of libraries designed to support cross-platform development of security-enabled client and server applications. Applications built with NSS can support SSL v2 and v3, TLS, PKCS #5, PKCS #7, PKCS #11, PKCS #12, S/MIME, X.509 v3 certificates, and other security standards."
export CATEGORY=portability
export TYPE=library
#export VERSION=3.15
#export VERSIONDATE=20130529
#export VERSION=3.15.1
#export VERSIONDATE=20130704
####nss/lib/libpkix/pkix_pl_nss/system/pkix_pl_object.c:490: undefined reference to `_PKIX_0_DEBUG_ARG'
####See also: https://bugzilla.mozilla.org/show_bug.cgi?id=779649
#export VERSION=3.15.2
#export VERSIONDATE=20130926
####nss/lib/pk11wrap/debug_module.c:899: undefined reference to `_InterlockedExchangeAdd'
#export VERSION=3.15.3
#export VERSIONDATE=20131111
#export VERSION=3.15.3.1
#export VERSIONDATE=20131210
########Assertion failure: !(me->flags & _PR_IDLE_THREAD), at prulock.c:197
#export VERSION=3.15.4
#export VERSIONDATE=20140107
#export VERSION=3.15.5
#export VERSIONDATE=20140219
#export VERSION=3.16
#export VERSIONDATE=20140319
####*** [../../../dist/WINNT6.1_gcc_DBG.OBJ/lib/softokn3.chk] Error 3
####caused by crashing dist/WIN*.OBJ/bin/shlibsign.exe
#export VERSION=3.16.1
#export VERSIONDATE=20140506
#export VERSION=3.16.2
#export VERSIONDATE=20140626
#export VERSION=3.16.2.3
#export VERSIONDATE=20141027
#export VERSION=3.16.3
#export VERSIONDATE=20140704
#export VERSION=3.16.4
#export VERSIONDATE=20140807
#export VERSION=3.16.5
#export VERSIONDATE=20140924
#export VERSION=3.16.6
#export VERSIONDATE=20141011
#export VERSION=3.17
#export VERSIONDATE=20140819
#export VERSION=3.17.1
#export VERSIONDATE=20140924
#export VERSION=3.17.2
#export VERSIONDATE=20141011
#export VERSION=3.17.3
#export VERSIONDATE=20141202
#export VERSION=3.17.4
#export VERSIONDATE=20150129
#export VERSION=3.18
#export VERSIONDATE=20150319
#export VERSION=3.18.1
#export VERSIONDATE=20150421
#export VERSION=3.19
#export VERSIONDATE=20150505
#export VERSION=3.19.1
#export VERSIONDATE=20150529
#export VERSION=3.19.2
#export VERSIONDATE=20150617
#export VERSION=3.19.2.1
#export VERSIONDATE=20151021
#export VERSION=3.19.2.2
#export VERSIONDATE=20151219
####nss/lib/freebl/win_rand.c:156: undefined reference to `SystemFunction036@8'
#export VERSION=3.19.3
#export VERSIONDATE=20150811
#export VERSION=3.19.4
#export VERSIONDATE=20151021
####/bin/sh: -c: line 0: syntax error near unexpected token `('
#export VERSION=3.20
#export VERSIONDATE=20150820
#export VERSION=3.20.1
#export VERSIONDATE=20151021
#export VERSION=3.20.2
#export VERSIONDATE=20151219
#export VERSION=3.21
#export VERSIONDATE=20151111
#export VERSION=3.23
#export VERSIONDATE=20160405
####nss/lib/freebl/win_rand.c:161:11: error: assignment from incompatible pointer type [-Werror]
####nss/external_tests/google_test/gtest/src/gtest.cc:3515:41: error: 'localtime_r' was not declared in this scope
#export VERSION=3.26
#export VERSIONDATE=20160830
#export VERSION=3.29
#export VERSIONDATE=20170419
#export VERSION=3.45
#export VERSIONDATE=20190822
#export VERSION=3.79.4
#export VERSIONDATE=20230210
#export VERSION=3.87
#export VERSIONDATE=20230112
#export VERSION=3.87.1
#export VERSIONDATE=20230210
#export VERSION=3.88.1
#export VERSIONDATE=20230210
#export VERSION=3.89
#export VERSIONDATE=20230310
#export VERSION=3.89.1
#export VERSIONDATE=20230506
#export VERSION=3.90
#export VERSIONDATE=20230604
#export VERSION=3.90.1
#export VERSIONDATE=20231111
#export VERSION=3.91
#export VERSIONDATE=20230630
#export VERSION=3.92
#export VERSIONDATE=20230727
#export VERSION=3.93
#export VERSIONDATE=20231002
export VERSION=3.94
export VERSIONDATE=20231003
wl-showstatus --package-version
export DEPENDENCIES=nspr,zlib,sqlite3
export OPTIONALDEPENDENCIES=xulrunner
export BUILDDEPENDENCIES=
export OPTIONALBUILDDEPENDENCIES=
#export BUILDDEPENDENCIES=nsinstall
#export OPTIONALBUILDDEPENDENCIES=
#export LICENSEFILE=
#export LICENSETYPE="Mozilla Public License / GPL / LGPL"
export LICENSEFILE=nss/COPYING
export LICENSETYPE=MPL
#export DOWNLOADURL="http://ftp.mozilla.org/pub/mozilla.org/security/nss/releases/ NSS_ _RTM/"
#export DOWNLOADURL="https://ftp.mozilla.org/pub/security/nss/releases/ NSS_"
#export DOWNLOADURL="https://firefox-source-docs.mozilla.org/security/nss/releases/ nss_ .html"
export DOWNLOADURL="https://hg.mozilla.org/projects/nss/tags NSS_ _RTM"
export INSTALLPREFIX=`pwd`/inst_$BASENAME-$VERSION
#export DOWNLOADSOURCEURL=http://ftp.mozilla.org/pub/mozilla.org/security/nss/releases/NSS_`echo $VERSION|sed -e "s/\./_/g"`_RTM/src/nss-$VERSION.tar.gz
#export DOWNLOADSOURCEURL=http://ftp.mozilla.org/pub/security/nss/releases/NSS_$(echo $VERSION|sed -e "s/\./_/g")_RTM/src/nss-$VERSION.tar.gz
export DOWNLOADSOURCEURL=https://ftp.mozilla.org/pub/security/nss/releases/NSS_$(echo $VERSION|sed -e "s/\./_/g")_RTM/src/nss-$VERSION.tar.gz
#export DOWNLOADSOURCEURL=https://hg.mozilla.org/projects/nss/archive/NSS_$(echo $VERSION|tr . _)_RTM.zip
wl-showstatus download
wl-download -v -d $TARBALLDIR/$BASENAME $DOWNLOADSOURCEURL
wl-wait4deps
tar xz --force-local -f $TARBALLDIR/$BASENAME/$BASENAME-$VERSION.tar.gz
cd $BASENAME-$VERSION
#unzip -oq $TARBALLDIR/$BASENAME/NSS_$(echo $VERSION|tr . _)_RTM.zip
#cd nss-NSS_3_94_RTM
## fix missing SHGetSpecialFolderPath in nss/lib/freebl/win_rand.c (version <= 3.20)
#mv nss/lib/freebl/win_rand.c nss/lib/freebl/win_rand.c.bak
#echo "#define _WIN32_IE 0x0400" > nss/lib/freebl/win_rand.c
#echo "#include <shlobj.h>" >> nss/lib/freebl/win_rand.c
#cat nss/lib/freebl/win_rand.c.bak >> nss/lib/freebl/win_rand.c
# fix InterlockedIncrement/InterlockedDecrement/InterlockedExchange/InterlockedExchangeAdd problems in nss/lib/softoken/pkcs11.c
mv nss/lib/softoken/pkcs11.c nss/lib/softoken/pkcs11.c.bak
cat > nss/lib/softoken/pkcs11.c << EOF
//#undef __USE_NTOSKRNL__
#include <windows.h>
EOF
cat nss/lib/softoken/pkcs11.c.bak >> nss/lib/softoken/pkcs11.c
# fix InterlockedIncrement/InterlockedDecrement/InterlockedExchange/InterlockedExchangeAdd problems in nss/lib/softoken/sftkdb.c
mv nss/lib/softoken/sftkdb.c nss/lib/softoken/sftkdb.c.bak
cat > nss/lib/softoken/sftkdb.c << EOF
//#undef __USE_NTOSKRNL__
#include <windows.h>
EOF
cat nss/lib/softoken/sftkdb.c.bak >> nss/lib/softoken/sftkdb.c
# fix InterlockedIncrement/InterlockedDecrement/InterlockedExchange/InterlockedExchangeAdd/_PKIX_0_DEBUG_ARG problems in nss/lib/libpkix/pkix_pl_nss/system/pkix_pl_object.c
mv nss/lib/libpkix/pkix_pl_nss/system/pkix_pl_object.c nss/lib/libpkix/pkix_pl_nss/system/pkix_pl_object.c.bak
cat > nss/lib/libpkix/pkix_pl_nss/system/pkix_pl_object.c << EOF
//#undef __USE_NTOSKRNL__
#include <windows.h>
#undef ERROR
EOF
cat nss/lib/libpkix/pkix_pl_nss/system/pkix_pl_object.c.bak >> nss/lib/libpkix/pkix_pl_nss/system/pkix_pl_object.c
# fix InterlockedExchange problems in nss/lib/certdb/certdb.c
mv nss/lib/certdb/certdb.c nss/lib/certdb/certdb.c.bak
cat > nss/lib/certdb/certdb.c << EOF
//#undef __USE_NTOSKRNL__
#include <windows.h>
EOF
cat nss/lib/certdb/certdb.c.bak >> nss/lib/certdb/certdb.c
# fix InterlockedExchange problems in nss/lib/ssl/sslsock.c (version >= 3.26)
mv nss/lib/ssl/sslsock.c nss/lib/ssl/sslsock.c.bak
cat > nss/lib/ssl/sslsock.c << EOF
//#undef __USE_NTOSKRNL__
#include <windows.h>
EOF
cat nss/lib/ssl/sslsock.c.bak >> nss/lib/ssl/sslsock.c
# fix InterlockedExchangeAdd problems in nss/lib/pk11wrap/debug_module.c
mv nss/lib/pk11wrap/debug_module.c nss/lib/pk11wrap/debug_module.c.bak
cat > nss/lib/pk11wrap/debug_module.c << EOF
//#undef __USE_NTOSKRNL__
#include <windows.h>
EOF
cat nss/lib/pk11wrap/debug_module.c.bak >> nss/lib/pk11wrap/debug_module.c
# fix InterlockedDecrement problems in nss/lib/ssl/ssl3con.c
mv nss/lib/ssl/ssl3con.c nss/lib/ssl/ssl3con.c.bak
cat > nss/lib/ssl/ssl3con.c << EOF
//#undef __USE_NTOSKRNL__
#include <windows.h>
EOF
cat nss/lib/ssl/ssl3con.c.bak >> nss/lib/ssl/ssl3con.c
# fix InterlockedDecrement problems in nss/lib/ckfw/wrap.c
mv nss/lib/ckfw/wrap.c nss/lib/ckfw/wrap.c.bak
cat > nss/lib/ckfw/wrap.c << EOF
//#undef __USE_NTOSKRNL__
#include <windows.h>
EOF
cat nss/lib/ckfw/wrap.c.bak >> nss/lib/ckfw/wrap.c
# fix missing CERT_FindCRLEntryReasonExten
cp -f nss/lib/certhigh/crlv2.c nss/cmd/certcgi/
patch -ulbf nss/cmd/certcgi/manifest.mn << EOF
--- nss/cmd/certcgi/manifest.mn  2013-09-25 15:57:56 +0200
+++ nss/cmd/certcgi/manifest.mn  2013-11-03 11:54:00 +0100
@@ -16,3 +16,3 @@

-CSRCS = certcgi.c
+CSRCS = certcgi.c crlv2.c

EOF
# fix missing CERT_FindCRLEntryReasonExten
cp -f nss/lib/certhigh/crlv2.c nss/cmd/rsaperf/
patch -ulbf nss/cmd/rsaperf/manifest.mn << EOF
--- nss/cmd/rsaperf/manifest.mn  2013-09-25 15:57:56 +0200
+++ nss/cmd/rsaperf/manifest.mn  2013-11-03 12:16:34 +0100
@@ -19,3 +19,3 @@

-CSRCS  = rsaperf.c defkey.c
+CSRCS  = rsaperf.c defkey.c crlv2.c

EOF
# fix missing sectool.lib
mv nss/cmd/crmftest/Makefile nss/cmd/crmftest/Makefile.bak
sed -e "s/sectool\.lib/libsectool.a/" nss/cmd/crmftest/Makefile.bak > nss/cmd/crmftest/Makefile
# fix InterlockedExchange/InterlockedExchangeAdd/InterlockedIncrement/InterlockedDecrement problems in nss/cmd/selfserv/selfserv.c
mv nss/cmd/selfserv/selfserv.c nss/cmd/selfserv/selfserv.c.bak
cat > nss/cmd/selfserv/selfserv.c << EOF
//#undef __USE_NTOSKRNL__
#include <windows.h>
EOF
cat nss/cmd/selfserv/selfserv.c.bak >> nss/cmd/selfserv/selfserv.c
# fix InterlockedExchange/InterlockedExchangeAdd/InterlockedIncrement/InterlockedDecrement problems in nss/cmd/strsclnt/strsclnt.c
mv nss/cmd/strsclnt/strsclnt.c nss/cmd/strsclnt/strsclnt.c.bak
cat > nss/cmd/strsclnt/strsclnt.c << EOF
//#undef __USE_NTOSKRNL__
#include <windows.h>
EOF
cat nss/cmd/strsclnt/strsclnt.c.bak >> nss/cmd/strsclnt/strsclnt.c
# fix nss/lib/util/secport.c (version >= 3.15.3.1)
mv nss/lib/util/secport.c nss/lib/util/secport.c.bak
echo "#include <windows.h>" > nss/lib/util/secport.c
cat nss/lib/util/secport.c.bak >> nss/lib/util/secport.c
# fix nss/lib/ssl/sslmutex.c (version >= 3.15.3.1)
mv nss/lib/ssl/sslmutex.c nss/lib/ssl/sslmutex.c.bak
echo "#include <windows.h>" > nss/lib/ssl/sslmutex.c
cat nss/lib/ssl/sslmutex.c.bak >> nss/lib/ssl/sslmutex.c
# fix nss/lib/ssl/sslsnce.c (version >= 3.15.3.1)
mv nss/lib/ssl/sslsnce.c nss/lib/ssl/sslsnce.c.bak
echo "#include <windows.h>" > nss/lib/ssl/sslsnce.c
cat nss/lib/ssl/sslsnce.c.bak >> nss/lib/ssl/sslsnce.c
# fix missing SystemFunction036 in nss/lib/freebl/win_rand.c (version >= 3.16.1)
patch -ulbf nss/lib/freebl/win_rand.c << EOF
--- nss/lib/freebl/win_rand.c  2014-05-07 00:28:44 +0200
+++ nss/lib/freebl/win_rand.c  2014-05-07 00:47:48 +0200
@@ -146,2 +146,3 @@
  */
+#ifndef __MINGW32__
 #define RtlGenRandom SystemFunction036
@@ -150,2 +151,20 @@
     ULONG RandomBufferLength);
+#else
+typedef BOOLEAN WINAPI (*fnSystemFunction036)(PVOID RandomBuffer, ULONG RandomBufferLength);
+BOOLEAN WINAPI RtlGenRandom (PVOID RandomBuffer, ULONG RandomBufferLength)
+{
+  HMODULE dll;
+  fnSystemFunction036 fn;
+  BOOLEAN result;
+  if ((dll = LoadLibrary("Advapi32.dll")) == NULL)
+    return FALSE;
+  if ((fn = GetProcAddress(dll, "SystemFunction036")) == NULL) {
+    FreeLibrary(dll);
+    return FALSE;
+  }
+  result = fn(RandomBuffer, RandomBufferLength);
+  FreeLibrary(dll);
+  return result;
+}
+#endif

EOF
# fix assertion error in shlibsign
patch -ulbf nss/cmd/shlibsign/sign.sh << EOF
--- nss/cmd/shlibsign/sign.sh  2015-03-17 00:03:37.000000000 +0100
+++ nss/cmd/shlibsign/sign.sh  2015-03-19 21:31:12.882675200 +0100
@@ -32,3 +32,3 @@
     echo "\${2}"/shlibsign -v -i "\${5}"
-    "\${2}"/shlibsign -v -i "\${5}"
+    "\${2}"/shlibsign -v -i "\${5}" || true
     ;;
EOF
## fix 64-bit issues nss/lib/util/secoid.c (version >= 3.21)
#patch -ulbf nss/lib/util/secoid.c << EOF
#--- nss/lib/util/secoid.c  2015-11-09 06:12:59.000000000 +0100
#+++ nss/lib/util/secoid.c  2015-11-11 10:17:23.280088700 +0100
#@@ -1967,3 +1967,3 @@
#            entry = PL_HashTableAdd( oidmechhash,
#-                                       (void *)oid->mechanism, (void *)oid );
#+                                       (void *)(uintptr_t)oid->mechanism, (void *)(uintptr_t)oid );
#            if ( entry == NULL ) {
#@@ -1988,3 +1988,3 @@
#
#-    ret = PL_HashTableLookupConst ( oidmechhash, (void *)mechanism);
#+    ret = PL_HashTableLookupConst ( oidmechhash, (void *)(uintptr_t)mechanism);
#     if ( ret == NULL ) {
#EOF
## fix unsupported visibility attribute in nss/lib/zlib/gzguts.h (version >= 3.21)
#mv nss/lib/zlib/gzguts.h nss/lib/zlib/gzguts.h.bak &&
#echo "#define NO_VIZ" > nss/lib/zlib/gzguts.h &&
#cat nss/lib/zlib/gzguts.h.bak >> nss/lib/zlib/gzguts.h
## fix unsupported visibility attribute in nss/lib/zlib/zutil.h (version >= 3.21)
#mv nss/lib/zlib/zutil.h nss/lib/zlib/zutil.h.bak &&
#echo "#define NO_VIZ" > nss/lib/zlib/zutil.h &&
#cat nss/lib/zlib/zutil.h.bak >> nss/lib/zlib/zutil.h
## fix 64-bit issues nss/lib/softoken/pkcs11.c (version >= 3.21)
#patch -ulbf nss/lib/softoken/pkcs11.c << EOF
#--- nss/lib/softoken/pkcs11.c  2015-11-11 10:48:14.904442900 +0100
#+++ nss/lib/softoken/pkcs11.c  2015-11-11 10:51:46.496270500 +0100
#@@ -2306,3 +2306,3 @@
#     slot = (SFTKSlot *)PL_HashTableLookupConst(nscSlotHashTable[index],
#-                                                       (void *)slotID);
#+                                                       (void *)(uintptr_t)slotID);
#     /* cleared slots shouldn't 'show up' */
#@@ -2367,3 +2367,3 @@
#
#-    entry = PL_HashTableAdd(nscSlotHashTable[index],(void *)slot->slotID,slot);
#+    entry = PL_HashTableAdd(nscSlotHashTable[index],(void *)(uintptr_t)slot->slotID,slot);
#     if (entry == NULL) {
#@@ -2861,3 +2861,3 @@
#            slot = (SFTKSlot *)
#-                       PL_HashTableLookup(tmpSlotHashTable, (void *)slotID);
#+                       PL_HashTableLookup(tmpSlotHashTable, (void *)(uintptr_t)slotID);
#            PORT_Assert(slot);
#@@ -2865,3 +2865,3 @@
#            SFTK_DestroySlotData(slot);
#-           PL_HashTableRemove(tmpSlotHashTable, (void *)slotID);
#+           PL_HashTableRemove(tmpSlotHashTable, (void *)(uintptr_t)slotID);
#        }
#@@ -2880,3 +2880,3 @@
#
#-    slot = (SFTKSlot *) PL_HashTableLookup(tmpSlotHashTable, (void *)slotID);
#+    slot = (SFTKSlot *) PL_HashTableLookup(tmpSlotHashTable, (void *)(uintptr_t)slotID);
#     if (slot == NULL) {
#EOF
## fix 64-bit issues nss/lib/softoken/pkcs11u.c (version >= 3.21)
#patch -ulbf nss/lib/softoken/pkcs11u.c << EOF
#--- nss/lib/softoken/pkcs11u.c  2015-11-11 10:53:58.098716300 +0100
#+++ nss/lib/softoken/pkcs11u.c  2015-11-11 10:54:11.895750400 +0100
#@@ -803,3 +803,3 @@
# {
#-    return (SECItem *)PL_HashTableLookup(slot->tokObjHashTable, (void *)handle);
#+    return (SECItem *)PL_HashTableLookup(slot->tokObjHashTable, (void *)(uintptr_t)handle);
# }
#EOF
# fix already defined interface in (version >= 3.87)
sed -i.bak "s/\binterface\b/iface/g" nss/lib/pk11wrap/pk11load.c nss/lib/softoken/pkcs11.c
# fix missing nss.pc
mkdir -p $INSTALLPREFIX/lib/pkgconfig &&
cat > $INSTALLPREFIX/lib/pkgconfig/nss.pc << EOF
prefix=$INSTALLPREFIX
exec_prefix=\${prefix}
libdir=\${exec_prefix}/lib
includedir=\${prefix}/include/nss

Name: NSS
Description: Mozilla Network Security Services
Version: $VERSION
Requires: nspr
Libs: -L\${libdir} -lnss3 -lnssutil3 -lsmime3 -lssl3
Cflags: -I\${includedir}
EOF
## fix missing localtime_r in nss/external_tests/google_test/gtest/src/gtest.cc (version >= 3.26)
#mv nss/external_tests/google_test/gtest/src/gtest.cc nss/external_tests/google_test/gtest/src/gtest.cc.bak &&
#echo "#define localtime_r(clock,result) (*(result) = *localtime(clock),result)" > nss/external_tests/google_test/gtest/src/gtest.cc &&
#cat nss/external_tests/google_test/gtest/src/gtest.cc.bak >> nss/external_tests/google_test/gtest/src/gtest.cc
## fix invalid compiler option -w44996 (version >= 3.26)
#mv nss/lib/sqlite/Makefile nss/lib/sqlite/Makefile.bak &&
#sed -e "s/-w44996//" nss/lib/sqlite/Makefile.bak > nss/lib/sqlite/Makefile
## fix missing softokn3.chk
#touch $(ls -1d dist/WIN*)/lib/softokn3.chk
# fix libraries looked for in the wrong place
#cp -u $MINGWPREFIX/lib/libplc4*.a $MINGWPREFIX/lib/libplds4*.a $MINGWPREFIX/lib/libnspr4*.a dist/WIN*.OBJ/lib/
#mkdir -p dist/$(uname -s|sed -e "s/\(MINGW32\|MSYS\)_NT-/WINNT/" -e "s/-WOW$//")_gcc_DBG.OBJ/lib
#cp -u $MINGWPREFIX/lib/libplc4* $MINGWPREFIX/lib/libplds4* $MINGWPREFIX/lib/libnspr4* dist/$(uname -s|sed -e "s/\(MINGW32\|MSYS\)_NT-/WINNT/" -e "s/-WOW$//")_gcc_DBG.OBJ/lib/
mkdir -p dist/$(uname -s|sed -e "s/\(MINGW32\|MSYS\)_NT-/WINNT/" -e "s/-WOW$//")_gcc$(if ( echo $RUNPLATFORM | grep -q x86_64 ); then echo _64; fi)_DBG.OBJ/lib
cp -u $MINGWPREFIX/lib/libplc4*.a $MINGWPREFIX/lib/libplds4*.a $MINGWPREFIX/lib/libnspr4*.a dist/$(uname -s|sed -e "s/\(MINGW32\|MSYS\)_NT-/WINNT/" -e "s/-WOW$//")_gcc$(if ( echo $RUNPLATFORM | grep -q x86_64 ); then echo _64; fi)_DBG.OBJ/lib/
# fix invalid compiler option -GT and missing plarena.h
sed -i.bak -e "s?^\(OS_CFLAGS.*\)-GT?\1-I$MINGWPREFIX/include/nspr?" nss/coreconf/WINNT.mk
# fix invalid compiler flag
sed -i.bak -e "s/OS_CFLAGS += -w44996/#&/" nss/lib/sqlite/Makefile
# fix uname -r returning special characters
####/bin/sh: -c: line 0: syntax error near unexpected token `('
sed -i.orig -e "s?\(uname -r\)?\1|tr '()/' '__-'?" nss/coreconf/arch.mk
wl-showstatus build &&
 #make -j1 -Cnss -f Makefile CC="${CC:-gcc} -I$MINGWPREFIX/include/nspr" AR="ar cru" NSINSTALL="$PYDIR/python.exe $MINGWPREFIX/bin/nsinstall.py" NS_USE_GCC=1 $(if ( echo $RUNPLATFORM | grep -q x86_64 ); then echo USE_64=1; fi) &&
 #make -j1 -Cnss -f Makefile NSINSTALL="$PYDIR/python.exe $MINGWPREFIX/bin/nsinstall.py" NS_USE_GCC=1 OS_TARGET=WINNT $(if ( echo $RUNPLATFORM | grep -q x86_64 ); then echo USE_64=1; fi) &&
 #make -j1 -Cnss -f Makefile NSINSTALL="$(which nsinstall.exe 2> /dev/null || (echo -n "$PYDIR/python.exe "; ls -1 $MINGWPREFIX/bin/nsinstall.py $(pwd)/../xulrunner-*/mozilla-release/js/src/config/nsinstall.py 2> /dev/null | head -n1))" NS_USE_GCC=1 OS_TARGET=WINNT $(if ( echo $RUNPLATFORM | grep -q x86_64 ); then echo USE_64=1; fi) &&
 #make -j1 -Cnss -f Makefile NSINSTALL="$(which nsinstall.exe 2> /dev/null || (echo -n "$PYDIR/python.exe "; ls -1 $MINGWPREFIX/bin/nsinstall.py $(pwd)/../xulrunner-*/mozilla-release/js/src/config/nsinstall.py 2> /dev/null | head -n1))" NS_USE_GCC=1 OS_TARGET=WINNT $(if ( echo $RUNPLATFORM | grep -q x86_64 ); then echo USE_64=1; fi) NSS_DISABLE_GTESTS=1 &&
 #make -j1 -Cnss -f Makefile NSINSTALL="$(which nsinstall.exe 2> /dev/null || (echo -n "$PYDIR/python.exe "; ls -1 $MINGWPREFIX/bin/nsinstall.py $(pwd)/../xulrunner-*/mozilla-release/js/src/config/nsinstall.py 2> /dev/null | head -n1))" NS_USE_GCC=1 OS_TARGET=WINNT $(if ( echo $RUNPLATFORM | grep -q x86_64 ); then echo "USE_64=1"; fi) OS_ARCH=$(uname -s|sed -e "s/\(MINGW32\|MINGW64\|MSYS\)_NT-/WINNT/" -e "s/-WOW$//") OBJDIR_NAME_BASE=MINGW NSS_DISABLE_GTESTS=1 LD_LIBS="-Wl,--as-needed -lz" &&
 #make -j1 -Cnss -f Makefile NSINSTALL="$(which nsinstall.exe 2> /dev/null || (echo -n "$PYDIR/python.exe "; ls -1 $MINGWPREFIX/bin/nsinstall.py $(pwd)/../xulrunner-*/mozilla-release/js/src/config/nsinstall.py 2> /dev/null | head -n1))" NS_USE_GCC=1 OS_TARGET=WINNT $(if ( echo $RUNPLATFORM | grep -q x86_64 ); then echo USE_64=1; fi) NSS_DISABLE_GTESTS=1 NSS_BUILD_WITHOUT_SOFTOKEN=1 &&
 #make -j1 -Cnss -f Makefile NSINSTALL="$(which nsinstall.exe 2> /dev/null || (echo -n "$PYDIR/python.exe "; ls -1 $MINGWPREFIX/bin/nsinstall.py $(pwd)/../xulrunner-*/mozilla-release/js/src/config/nsinstall.py 2> /dev/null | head -n1))" NS_USE_GCC=1 OS_TARGET=WINNT $(if ( echo $RUNPLATFORM | grep -q x86_64 ); then echo USE_64=1; fi) USE_SYSTEM_ZLIB=1 NSS_USE_SYSTEM_SQLITE=1 LD_LIBS="-Wl,--as-needed -lz" &&
 #( make -j1 -Cnss -f Makefile NSINSTALL="$(which nsinstall.exe 2> /dev/null || (echo -n "$PYDIR/python.exe "; ls -1 $MINGWPREFIX/bin/nsinstall.py $(pwd)/../xulrunner-*/mozilla-release/js/src/config/nsinstall.py 2> /dev/null | head -n1))" NS_USE_GCC=1 OS_TARGET=WINNT $(if ( echo $RUNPLATFORM | grep -q x86_64 ); then echo USE_64=1; fi) USE_SYSTEM_ZLIB=1 NSS_USE_SYSTEM_SQLITE=1 LD_LIBS="-Wl,--as-needed -lz" || ( for F in dist/*.OBJ; do cp -u $MINGWPREFIX/lib/libsqlite3*.a $MINGWPREFIX/lib/libplc4*.a $MINGWPREFIX/lib/libplds4*.a $MINGWPREFIX/lib/libnspr4*.a $F/lib/; done && make -j1 -Cnss -f Makefile NSINSTALL="$(which nsinstall.exe 2> /dev/null || (echo -n "$PYDIR/python.exe "; ls -1 $MINGWPREFIX/bin/nsinstall.py $(pwd)/../xulrunner-*/mozilla-release/js/src/config/nsinstall.py 2> /dev/null | head -n1))" NS_USE_GCC=1 OS_TARGET=WINNT $(if ( echo $RUNPLATFORM | grep -q x86_64 ); then echo USE_64=1; fi) USE_SYSTEM_ZLIB=1 NSS_USE_SYSTEM_SQLITE=1 LD_LIBS="-Wl,--as-needed -lz" )) &&
 #make -j1 -Cnss -f Makefile NSINSTALL="$(which nsinstall.exe 2> /dev/null || (echo -n "$PYDIR/python.exe "; ls -1 $MINGWPREFIX/bin/nsinstall.py $(pwd)/../xulrunner-*/mozilla-release/js/src/config/nsinstall.py 2> /dev/null | head -n1))" NS_USE_GCC=1 OS_TARGET=WINNT $(if ( echo $RUNPLATFORM | grep -q x86_64 ); then echo USE_64=1; fi) USE_SYSTEM_ZLIB=1 NSS_USE_SYSTEM_SQLITE=1 NSS_DISABLE_GTESTS=1 LD_LIBS="-Wl,--as-needed -lz" &&
 #NSS_USE_SYSTEM_FREEBL=0
 #NSINSTALL="$(ls -1 $MINGWPEFIX/bin/nsinstall.exe $(pwd)/../inst_nsinstall-*/bin/nsinstall.exe 2> /dev/null | head -n1)"
 #make -j1 -Cnss -f Makefile NSINSTALL="$(which nsinstall.exe 2> /dev/null || (echo -n "$PYDIR/python.exe "; ls -1 $MINGWPREFIX/bin/nsinstall.py $(pwd)/../xulrunner-*/mozilla-release/js/src/config/nsinstall.py 2> /dev/null | head -n1))" NS_USE_GCC=1 OS_TARGET=WINNT $(if ( echo $RUNPLATFORM | grep -q x86_64 ); then echo "USE_64=1"; fi) OS_ARCH=$(uname -s|sed -e "s/\(MINGW32\|MINGW64\|MSYS\)_NT-/WINNT/" -e "s/-WOW$//") NSPR_INCLUDE_DIR=$MINGWPEFIX/include/nspr OBJDIR_NAME_BASE=MINGW USE_SYSTEM_ZLIB=1 ZLIB_LIBS=-lz NSS_USE_SYSTEM_SQLITE=1 NSS_DISABLE_GTESTS=1 BUILD_OPT=1 LD_LIBS="-Wl,--as-needed -lz" &&
 #make -j1 -Cnss CC=${CC:-gcc} RC="${WINDRES:-windres} -O coff --use-temp-file" NSINSTALL="$(which nsinstall.exe 2> /dev/null || (echo -n "$PYDIR/python.exe "; ls -1 $MINGWPREFIX/bin/nsinstall.py $(pwd)/../xulrunner-*/mozilla-release/js/src/config/nsinstall.py 2> /dev/null | head -n1))" NS_USE_GCC=1 OS_TARGET=WINNT $(if ( echo $RUNPLATFORM | grep -qv "^i.86" ); then echo "USE_64=1"; fi) $(if echo $RUNPLATFORM|grep -q "^aarch64"; then echo "CPU_ARCH=aarch64"; fi) OS_ARCH=$(uname -s|sed -e "s/\(MINGW32\|MINGW64\|MSYS\)_NT-/WINNT/" -e "s/-WOW$//") NSPR_INCLUDE_DIR=$MINGWPEFIX/include/nspr OBJDIR_NAME_BASE=MINGW USE_SYSTEM_ZLIB=1 ZLIB_LIBS=-lz NSS_USE_SYSTEM_SQLITE=1 NSS_DISABLE_GTESTS=1 BUILD_OPT=1 LD_LIBS="-Wl,--as-needed -lz" &&
 make -j1 -Cnss CC="${CC:-gcc} $(if ${CC:-gcc} --version|grep -q "^clang"; then echo "-Wno-incompatible-function-pointer-types"; fi)" RC="${WINDRES:-windres} -O coff --use-temp-file" NSINSTALL="$(which nsinstall.exe 2> /dev/null || (echo -n "$PYDIR/python.exe "; ls -1 $MINGWPREFIX/bin/nsinstall.py $(pwd)/../xulrunner-*/mozilla-release/js/src/config/nsinstall.py 2> /dev/null | head -n1))" NS_USE_GCC=1 OS_TARGET=WINNT $(if ( echo $RUNPLATFORM | grep -qv "^i.86" ); then echo "USE_64=1"; fi) $(if echo $RUNPLATFORM|grep -q "^aarch64"; then echo "CPU_ARCH=aarch64"; fi) OS_ARCH=$(uname -s|sed -e "s/\(MINGW32\|MINGW64\|MSYS\)_NT-/WINNT/" -e "s/-WOW$//") NSPR_INCLUDE_DIR=$MINGWPEFIX/include/nspr OBJDIR_NAME_BASE=MINGW USE_SYSTEM_ZLIB=1 ZLIB_LIBS=-lz NSS_USE_SYSTEM_SQLITE=1 NSS_DISABLE_GTESTS=1 BUILD_OPT=1 LD_LIBS="-Wl,--as-needed -lz" &&
 #NSS_USE_SYSTEM_FREEBL=0
 #for F in nss/lib/*/MINGW.OBJ; do
 # mkdir -p $(dirname $F)/WINNT10.0-22621_aarch64_gcc_64_OPT.OBJ
 # cp -u $F/*.o $(dirname $F)/WINNT10.0-22621_aarch64_gcc_64_OPT.OBJ
 #done &&
 wl-showstatus build-install &&
 mkdir -p $INSTALLPREFIX/include $INSTALLPREFIX/lib $INSTALLPREFIX/bin &&
 cp -rf dist/public/* $INSTALLPREFIX/include/ &&
 #rm -f dist/$(uname -s|sed -e "s/\(MINGW32\|MSYS\)_NT-/WINNT/" -e "s/-WOW$//")_gcc$(if ( echo $RUNPLATFORM | grep -q x86_64 ); then echo _64; fi)_DBG.OBJ/lib/libplc4*.a &&
 #rm -f dist/$(uname -s|sed -e "s/\(MINGW32\|MSYS\)_NT-/WINNT/" -e "s/-WOW$//")_gcc$(if ( echo $RUNPLATFORM | grep -q x86_64 ); then echo _64; fi)_DBG.OBJ/lib/libplds4*.a &&
 #rm -f dist/$(uname -s|sed -e "s/\(MINGW32\|MSYS\)_NT-/WINNT/" -e "s/-WOW$//")_gcc$(if ( echo $RUNPLATFORM | grep -q x86_64 ); then echo _64; fi)_DBG.OBJ/lib/libnspr4*.a &&
 cp -f dist/*.OBJ/lib/*.a $INSTALLPREFIX/lib/ &&
 rm -f $INSTALLPREFIX/lib/lib{plc4,plds4,nspr4}*.a &&
 cp -f dist/*.OBJ/bin/*.exe dist/*.OBJ/lib/*.dll $INSTALLPREFIX/bin/ &&
 strip $INSTALLPREFIX/bin/*.dll $INSTALLPREFIX/bin/*.exe &&
 # avoid installing libssl.a (conflicts with OpenSSL)
 mv -f $INSTALLPREFIX/lib/libssl.a $INSTALLPREFIX/lib/libssl-nss.a &&
 #mv $INSTALLPREFIX/lib/libssl3.a $INSTALLPREFIX/lib/libssl3.dll.a &&
 #mv -f $INSTALLPREFIX/lib/libssl.a $INSTALLPREFIX/lib/libssl3.a &&
 wl-makepackage -c -d && wl-install -d $BASENAME-$VERSION && cd .. && rm -rf $BASENAME-$VERSION
 #wl-makepackage -c -d && wl-install -d $BASENAME-$VERSION && cd .. && rm -rf nss-NSS_3_94_RTM
####for F in mozilla/security/nss/lib/util/*.o; do cp -f $F $(ls -1d mozilla/security/nss/lib/util/WINNT*.OBJ)/$(basename $F)bj; done
####ls -1 dist/WINNT6.1_gcc_DBG.OBJ/lib/softokn3.dll && touch dist/WINNT6.1_gcc_DBG.OBJ/lib/softokn3.chk
####ls -1 dist/WINNT6.1_gcc_DBG.OBJ/lib/freebl3.dll && touch dist/WINNT6.1_gcc_DBG.OBJ/lib/freebl3.chk
####ls -1 dist/WINNT6.1_gcc_DBG.OBJ/lib/nssdbm3.dll && touch dist/WINNT6.1_gcc_DBG.OBJ/lib/nssdbm3.chk
####Note: requires "Run As Administrator" privileges when using nsinstall.exe
####See also: https://developer.mozilla.org/en-US/docs/Mozilla/Projects/NSS/Reference/NSS_environment_variables
####TO DO: don't install dependancies (e.g. libzlib.a, libsqlite3.a)



