export NAME="Cython"
export STATUS=
export URL=https://cython.org/
export BASENAME=cython
export DESCRIPTION="Cython is an optimising static compiler for both the Python programming language and the extended Cython programming language (based on Pyrex). It makes writing C extensions for Python as easy as Python itself."
export CATEGORY=development
export TYPE=library
#export VERSION=0.29.14
#export VERSIONDATE=20200119
#export VERSION=0.29.15
#export VERSIONDATE=20200211
#export VERSION=0.29.16
#export VERSIONDATE=20200325
#export VERSION=0.29.17
#export VERSIONDATE=20200427
#export VERSION=0.29.18
#export VERSIONDATE=20200519
#export VERSION=0.29.19
#export VERSIONDATE=20200521
#export VERSION=0.29.20
#export VERSIONDATE=20200611
#export VERSION=0.29.21
#export VERSIONDATE=20200709
#export VERSION=0.29.22
#export VERSIONDATE=20210221
#export VERSION=0.29.23
#export VERSIONDATE=20210415
####error: Microsoft Visual C++ 14.0 is required. Get it with "Microsoft Visual C++ Build Tools": http://landinghub.visualstudio.com/visual-cpp-build-tools
#export VERSION=0.29.24
#export VERSIONDATE=20210714
#export VERSION=0.29.25
#export VERSIONDATE=20211206
#export VERSION=0.29.25-1
#export VERSIONDATE=20211206
#export VERSION=0.29.26
#export VERSIONDATE=20211217
#export VERSION=0.29.27
#export VERSIONDATE=20220129
#export VERSION=0.29.28
#export VERSIONDATE=20220217
#export VERSION=0.29.29
#export VERSIONDATE=20220517
#export VERSION=0.29.30
#export VERSIONDATE=20220518
#export VERSION=0.29.31
#export VERSIONDATE=20220728
#export VERSION=0.29.32
#export VERSIONDATE=20220729
#export VERSION=0.29.33
#export VERSIONDATE=20230106
#export VERSION=0.29.34
#export VERSIONDATE=20230402
#export VERSION=0.29.35
#export VERSIONDATE=20230524
#export VERSION=0.29.36
#export VERSIONDATE=20230705
#export VERSION=0.29.37.1
#export VERSIONDATE=20231219
#export VERSION=3.0.0a9
#export VERSIONDATE=20210721
#export VERSION=3.0.0a10
#export VERSIONDATE=20220107
#export VERSION=3.0.0a11
#export VERSIONDATE=20220731
#export VERSION=3.0.0b2
#export VERSIONDATE=20230327
#export VERSION=3.0.0
#export VERSIONDATE=20230717
#export VERSION=3.0.1
#export VERSIONDATE=20230825
#export VERSION=3.0.2
#export VERSIONDATE=20230827
#export VERSION=3.0.3
#export VERSIONDATE=20231005
#export VERSION=3.0.4
#export VERSIONDATE=20231018
#export VERSION=3.0.5
#export VERSIONDATE=20231031
#export VERSION=3.0.6
#export VERSIONDATE=20231126
#export VERSION=3.0.7
#export VERSIONDATE=20231219
####error: Microsoft Visual C++ 14.0 or greater is required. Get it with "Microsoft C++ Build Tools": https://visualstudio.microsoft.com/visual-cpp-build-tools/
#export VERSION=3.0.8
#export VERSIONDATE=20240110
#export VERSION=3.0.9
#export VERSIONDATE=20240305
#export VERSION=3.0.10
#export VERSIONDATE=20240331
#export VERSION=3.0.11
#export VERSIONDATE=20240805
#export VERSION=3.0.11-1
#export VERSIONDATE=20240806
#export VERSION=3.0.12
#export VERSIONDATE=20250211
#export VERSION=3.1.0
#export VERSIONDATE=20250509
#export VERSION=3.1.1
#export VERSIONDATE=20250519
export VERSION=3.1.2
export VERSIONDATE=20250609
wl-showstatus --package-version
export DEPENDENCIES=
export OPTIONALDEPENDENCIES=
export BUILDDEPENDENCIES=
export OPTIONALBUILDDEPENDENCIES=
#export LICENSEFILE=LICENSE.txt
export LICENSEFILE=COPYING.txt
export LICENSETYPE=Apache
#export DOWNLOADURL="https://pypi.org/project/Cython/#files"
export DOWNLOADURL="https://github.com/cython/cython/releases"
export INSTALLPREFIX=`pwd`/inst_$BASENAME-$VERSION
#export DOWNLOADSOURCEURL=https://files.pythonhosted.org/packages/9c/9b/706dac7338c2860cd063a28cdbf5e9670995eaea408abbf2e88ba070d90d/Cython-0.29.14.tar.gz
#export DOWNLOADSOURCEURL=https://files.pythonhosted.org/packages/d9/82/d01e767abb9c4a5c07a6a1e6f4d5a8dfce7369318d31f48a52374094372e/Cython-0.29.15.tar.gz
#export DOWNLOADSOURCEURL=https://files.pythonhosted.org/packages/49/8a/6a4135469372da2e3d9f88f71c6d00d8a07ef65f121eeca0c7ae21697219/Cython-0.29.16.tar.gz
#export DOWNLOADSOURCEURL=https://files.pythonhosted.org/packages/99/36/a3dc962cc6d08749aa4b9d85af08b6e354d09c5468a3e0edc610f44c856b/Cython-0.29.17.tar.gz
#export DOWNLOADSOURCEURL=https://files.pythonhosted.org/packages/4f/94/15b333b182ce12c76e2da888d608edd472f617bafcd8d1bb857c18faac3e/Cython-0.29.18.tar.gz
#export DOWNLOADSOURCEURL=https://files.pythonhosted.org/packages/79/36/69246177114d0b6cb7bd4f9aef177b434c0f4a767e05201b373e8c8d7092/Cython-0.29.19.tar.gz
#export DOWNLOADSOURCEURL=https://files.pythonhosted.org/packages/3f/61/16a435de52fcda15246597a602aab6132cea50bedeb0919cb8874a068a20/Cython-0.29.20.tar.gz
#export DOWNLOADSOURCEURL=https://files.pythonhosted.org/packages/6c/9f/f501ba9d178aeb1f5bf7da1ad5619b207c90ac235d9859961c11829d0160/Cython-0.29.21.tar.gz
#export DOWNLOADSOURCEURL=https://files.pythonhosted.org/packages/d3/38/adc49a5aca4f644e6322237089fdcf194084f5fe41445e6e632f28b32bf7/Cython-0.29.22.tar.gz
#export DOWNLOADSOURCEURL=https://files.pythonhosted.org/packages/d9/cd/0d2d90b27219c07f68f1c25bcc7b02dd27639d2180add9d4b73e70945869/Cython-0.29.23.tar.gz
#export DOWNLOADSOURCEURL=https://github.com/cython/cython/releases/download/$VERSION/Cython-$VERSION.tar.gz
export DOWNLOADSOURCEURL=https://github.com/cython/cython/archive/refs/tags/$VERSION.tar.gz
wl-showstatus download
wl-download -v -d $TARBALLDIR/$BASENAME $DOWNLOADSOURCEURL
wl-wait4deps
wl-showstatus extract
#tar xz --force-local -f $TARBALLDIR/$BASENAME/Cython-$VERSION.tar.gz
#cd Cython-$VERSION
tar xz --force-local -f $TARBALLDIR/$BASENAME/$VERSION.tar.gz
cd cython-$VERSION
# fix 64-bit issues
#### see also: https://github.com/cython/cython/issues/2734
if ( echo $RUNPLATFORM | grep -q x86_64 ); then
 for F in $(find -name '*.c'); do
  mv $F $F.bak &&
  echo "#define MS_WIN64" > $F &&
  cat $F.bak >> $F &&
  rm -f $F.bak
 done
fi
# fix MSVC issue
mkdir -p winfix
cp -rf $PYDIR/lib/distutils winfix/
patch -ulbf winfix/distutils/cygwinccompiler.py << EOF
@@ -85,3 +85,3 @@
         else:
-            raise ValueError("Unknown MS Compiler version %s " % msc_ver)
+            return None

@@ -184,3 +184,4 @@
         # Additional libraries
-        libraries.extend(self.dll_libraries)
+        if self.dll_libraries is not None:
+            libraries.extend(self.dll_libraries)
 
EOF
patch -ulbf winfix/distutils/ccompiler.py << EOF
@@ -931,3 +931,3 @@
     ('posix', 'unix'),
-    ('nt', 'msvc'),
+    ('nt', 'mingw32'),

EOF
# fix Cython/Plex/Scanners.c (version >= 0.29.26)
patch -ulbf Cython/Plex/Scanners.c << EOF
@@ -218,5 +218,2 @@
   #undef MASK
-  #ifdef SIZEOF_VOID_P
-    enum { __pyx_check_sizeof_voidp = 1 / (int)(SIZEOF_VOID_P == sizeof(void*)) };
-  #endif
 #endif
EOF
# fix SIZEOF_VOID_P issues (version >= 0.29.26)
sed -i.bak -e "s?enum { __pyx_check_sizeof_voidp = 1 / (int)(SIZEOF_VOID_P == sizeof(void\*)) };?//&?" Cython/Compiler/FlowControl.c Cython/Compiler/FusedNode.c Cython/Compiler/Scanning.c Cython/Compiler/Visitor.c Cython/Plex/Actions.c Cython/Plex/Scanners.c Cython/Runtime/refnanny.c Cython/Tempita/_tempita.c Cython/Utility/ModuleSetupCode.c
#wl-showstatus build &&
# PATH=$PYDIR:$PATH PYTHONPATH=$(pwd)/winfix:$MINGWPREFIX/lib${PYTHONPATH:+:$PYTHONPATH} $PYDIR/python.exe setup.py build --compiler=mingw32 &&
# #make PYTHON=$PYDIR/python.exe &&
#    echo OK  
#wl-showstatus build &&
# PATH=$PYDIR:$PATH PYTHONPATH=$(pwd)/winfix:$MINGWPREFIX/lib${PYTHONPATH:+:$PYTHONPATH} make &&
#    echo OK
mkdir -p $INSTALLPREFIX/python/Lib/site-packages
wl-showstatus build &&
 PATH=$PYDIR:$PATH PYTHON=$PYDIR/python.exe PYTHONPATH=$PWD/winfix:$MINGWPREFIX/python/Lib/site-packages:$INSTALLPREFIX/python:$INSTALLPREFIX/python/Lib/site-packages:$PYDIR/Lib/site-packages${PYTHONPATH:+:$PYTHONPATH} PYTHONDONTWRITEBYTECODE=1 $PYDIR/python.exe setup.py build --compiler=mingw32 &&
 wl-showstatus build-install &&
 #PATH=$PYDIR:$PATH PYTHON=$PYDIR/python.exe PYTHONPATH=$PWD/winfix:$MINGWPREFIX/python/Lib/site-packages:$INSTALLPREFIX/python:$INSTALLPREFIX/python/Lib/site-packages:$PYDIR/Lib/site-packages${PYTHONPATH:+:$PYTHONPATH} PYTHONDONTWRITEBYTECODE=1 $PYDIR/python.exe setup.py install --prefix=$(cygpath -w $INSTALLPREFIX/python) &&
 PATH=$PYDIR:$PATH PYTHON=$PYDIR/python.exe PYTHONPATH=$PWD/winfix:$MINGWPREFIX/python/Lib/site-packages:$INSTALLPREFIX/python:$INSTALLPREFIX/python/Lib/site-packages:$PYDIR/Lib/site-packages${PYTHONPATH:+:$PYTHONPATH} PYTHONDONTWRITEBYTECODE=1 $PYDIR/python.exe setup.py install install --root=$(cygpath -w $INSTALLPREFIX) --prefix=python &&
 #--compiler=mingw32
 ## delete any __pycache__ folder(s)
 #find $INSTALLPREFIX -name __pycache__ -exec echo rm -rf {} \; | sh &&
 #wl-makepackage -c -d && wl-install -d $BASENAME-$VERSION && cd .. && wl-showstatus cleanup && rm -rf Cython-$VERSION
 wl-makepackage -c -d && wl-install -d $BASENAME-$VERSION && cd .. && wl-showstatus cleanup && rm -rf cython-$VERSION
####Note: it may be necesary to uninstall the currently installed cython with: wl-uninstall cython
####PYTHONPATH=$MINGWPREFIX/python/Lib/site-packages:$PYDIR/Lib/site-packages${PYTHONPATH:+:$PYTHONPATH} $PYDIR/python.exe $MINGWPREFIX/python/Scripts/cython-script.py --help



cat > $PYDIR/Lib/distutils/distutils.cfg << EOF
[build]
compiler=mingw32
[build_ext]
compiler=mingw32
EOF

wl-showstatus build &&
 make PYTHON=$PYDIR/python.exe &&
    echo OK



echo "print('Hello world')" > hello.py
$PYDIR/python.exe hello.py

#PYTHONPATH=$MINGWPREFIX/python/Lib/site-packages:$PYDIR/Lib/site-packages${PYTHONPATH:+:$PYTHONPATH} $PYDIR/python.exe $MINGWPREFIX/python/Scripts/cythonize-script.py -3 hello.py -f

#PYTHONPATH=$MINGWPREFIX/python/Lib/site-packages:$PYDIR/Lib/site-packages${PYTHONPATH:+:$PYTHONPATH} $PYDIR/python.exe $MINGWPREFIX/python/Scripts/cython-script.py -3 --embed -o hello.c hello.py
#PYTHONPATH=$MINGWPREFIX/python/Lib/site-packages:$PYDIR/Lib/site-packages${PYTHONPATH:+:$PYTHONPATH} $PYDIR/python.exe $MINGWPREFIX/python/Scripts/cython-script.py -3 --embed=WinMain -o hello.c hello.py
PYTHONPATH=$MINGWPREFIX/python/Lib/site-packages:$PYDIR/Lib/site-packages${PYTHONPATH:+:$PYTHONPATH} $MINGWPREFIX/python/Scripts/cython.exe -3 --embed=WinMain -o hello.c hello.py
#PYTHONPATH=$MINGWPREFIX/python/Lib/site-packages:$PYDIR/Lib/site-packages${PYTHONPATH:+:$PYTHONPATH} $PYDIR/python.exe $MINGWPREFIX/python/Lib/site-packages/cython.py -3 --embed=WinMain -o hello.c hello.py
gcc -c -o hello.o hello.c -I$PYDIR/include
gcc -mconsole -Wl,--subsystem,console -o hello.exe hello.o -L$PYDIR/libs -lpython37
#gcc -mwindows -Wl,--subsystem,windows -o hello.exe hello.o -L$PYDIR/libs -lpython37
#PATH=$PYDIR:$PATH ./hello.exe
PATH=$PYDIR:$PATH PYTHONPATH=$PYDIR/Lib:$PYDIR/Lib/site-packages${PYTHONPATH:+:$PYTHONPATH} ./hello.exe



