export NAME="PostGIS"
export STATUS=
export URL=http://postgis.net/
export BASENAME=postgis
export DESCRIPTION="PostGIS is a spatial database extender for PostgreSQL object-relational database. It adds support for geographic objects allowing location queries to be run in SQL. (Contains liblwgeom.)"
export CATEGORY=
export TYPE=library
#export VERSION=2.0.5
#export VERSIONDATE=20140330
#export VERSION=2.0.6
#export VERSIONDATE=20140514
#export VERSION=2.0.7
#export VERSIONDATE=20150328
#export VERSION=2.1.1
#export VERSIONDATE=20131203
#export VERSION=2.1.2
#export VERSIONDATE=20140329
#export VERSION=2.1.3
#export VERSIONDATE=20140514
####configure: error: the PGXS Makefile E:/Prog/MinGW-MSYS-4.8.1/msys/custombuilt/lib/pgxs/src/makefiles/pgxs.mk cannot be found. Please install the PostgreSQL server development packages and re-run configure.
#export VERSION=2.1.4
#export VERSIONDATE=20140911
#export VERSION=2.1.5
#export VERSIONDATE=20141219
#export VERSION=2.1.6
#export VERSIONDATE=20150321
####configure: error: PostGIS raster requires OGR to be enabled in GDAL. Use --without-raster to build without raster support.
#export VERSION=2.1.7
#export VERSIONDATE=20150330
#export VERSION=2.1.8
#export VERSIONDATE=20150707
#export VERSION=2.1.9
#export VERSIONDATE=20170919
#export VERSION=2.2.0
#export VERSIONDATE=20151008
#export VERSION=2.2.2
#export VERSIONDATE=20160405
#export VERSION=2.2.3
#export VERSIONDATE=20161007
#export VERSION=2.2.4
#export VERSIONDATE=20161127
#export VERSION=2.2.5
#export VERSIONDATE=20170130
#export VERSION=2.2.6
#export VERSIONDATE=20171019
#export VERSION=2.2.7
#export VERSIONDATE=20180406
#export VERSION=2.2.8
#export VERSIONDATE=20181123
#export VERSION=2.3.0
#export VERSIONDATE=20160927
#export VERSION=2.3.1
#export VERSIONDATE=20161129
#export VERSION=2.3.2
#export VERSIONDATE=20170131
#export VERSION=2.3.3
#export VERSIONDATE=20170702
####configure: error: PostGIS raster requires OGR to be enabled in GDAL. Use --without-raster to build without raster support.
#export VERSION=2.3.4
#export VERSIONDATE=20171019
####configure: error: cannot find install-sh, install.sh, or shtool in "." "./.." "./../.."
#export VERSION=2.3.5
#export VERSIONDATE=20171116
#export VERSION=2.3.6
#export VERSIONDATE=20180117
#export VERSION=2.3.7
#export VERSIONDATE=20180406
#export VERSION=2.3.8
#export VERSIONDATE=20181125
#export VERSION=2.3.9
#export VERSIONDATE=20190312
#export VERSION=2.3.10
#export VERSIONDATE=20190811
#export VERSION=2.3.11
#export VERSIONDATE=20200601
#wl-showstatus --package-version
#export DEPENDENCIES=proj,geos,libxml2,postgresql,json,gettext,gdal
#export OPTIONALDEPENDENCIES=
#export BUILDDEPENDENCIES=
#export OPTIONALBUILDDEPENDENCIES=
#export VERSION=2.4.0
#export VERSIONDATE=20170930
#export VERSION=2.4.1
#export VERSIONDATE=20171019
#export VERSION=2.4.2
#export VERSIONDATE=20171116
#export VERSION=2.4.3
#export VERSIONDATE=20180117
#export VERSION=2.4.4
#export VERSIONDATE=20180408
#export VERSION=2.4.5
#export VERSIONDATE=20180913
#export VERSION=2.4.6
#export VERSIONDATE=20181125
#export VERSION=2.4.7
#export VERSIONDATE=20190312
#export VERSION=2.4.8
#export VERSIONDATE=20190811
#export VERSION=2.4.9
#export VERSIONDATE=20200816
#export VERSION=2.4.10
#export VERSIONDATE=20220425
#export VERSION=2.5.0
#export VERSIONDATE=20180924
#export VERSION=2.5.1
#export VERSIONDATE=20181119
#export VERSION=2.5.2
#export VERSIONDATE=20190312
####Can't fetch local revision (neither .svn nor .git found)
####protoc-c.exe: Unknown option: --cpp_out=.
#export VERSION=2.5.3
#export VERSIONDATE=20190811
#export VERSION=2.5.4
#export VERSIONDATE=20200228
#export VERSION=2.5.5
#export VERSIONDATE=20200816
#export VERSION=2.5.6
#export VERSIONDATE=20220421
#export VERSION=2.5.7
#export VERSIONDATE=20220720
#export VERSION=2.5.8
#export VERSIONDATE=20220720
#export VERSION=2.5.9
#export VERSIONDATE=20221113
#export VERSION=3.0.0
#export VERSIONDATE=20191020
####error: vector_tile.pb-c.c: No such file or directory
#export VERSION=3.0.1
#export VERSIONDATE=20200223
#export VERSION=3.0.2
#export VERSIONDATE=20200816
#export VERSION=3.0.3
#export VERSIONDATE=20201123
#export VERSION=3.0.5
#export VERSIONDATE=20220203
#export VERSION=3.0.6
#export VERSIONDATE=20220720
#export VERSION=3.0.7
#export VERSIONDATE=20220819
####configure hangs at: checking for library containing GDALAllRegister...
#export VERSION=3.1.0
#export VERSIONDATE=20201219
#export VERSION=3.1.1
#export VERSIONDATE=20210129
#export VERSION=3.1.2
#export VERSIONDATE=20210524
#export VERSION=3.1.3
#export VERSIONDATE=20210703
#export VERSION=3.1.4
#export VERSIONDATE=20210904
#export VERSION=3.1.5
#export VERSIONDATE=20220202
#export VERSION=3.1.6
#export VERSIONDATE=20220721
#export VERSION=3.1.7
#export VERSIONDATE=20220819
#export VERSION=3.1.12
#export VERSIONDATE=20241223
#export VERSION=3.2.0
#export VERSIONDATE=20211218
#export VERSION=3.2.1
#export VERSIONDATE=20220213
#export VERSION=3.2.2
#export VERSIONDATE=20220724
#export VERSION=3.2.3
#export VERSIONDATE=20220819
#export VERSION=3.2.8
#export VERSIONDATE=20241223
#export VERSION=3.3.0
#export VERSIONDATE=20220828
#export VERSION=3.3.1
#export VERSIONDATE=20220911
#export VERSION=3.3.2
#export VERSIONDATE=20221113
#export VERSION=3.3.8
#export VERSIONDATE=20241223
#export VERSION=3.4.3
#export VERSIONDATE=20241113
#export VERSION=3.4.4
#export VERSIONDATE=20241223
#export VERSION=3.5.0
#export VERSIONDATE=20241113
#export VERSION=3.5.1
#export VERSIONDATE=20241223
#export VERSION=3.5.2
#export VERSIONDATE=20250119
export VERSION=3.5.3
export VERSIONDATE=20250518
#export VERSION=3.6.0
#export VERSIONDATE=20250902
wl-showstatus --package-version
#export DEPENDENCIES=proj,geos,libxml2,postgresql,json,gettext,protobuf-c
export DEPENDENCIES=proj,geos,libxml2,postgresql,json,gettext,protobuf-c,gdal
#export DEPENDENCIES=proj,geos,libxml2,postgresql,json,gettext,protobuf-c,gdal,sfcgal
export OPTIONALDEPENDENCIES=
export BUILDDEPENDENCIES=protobuf
export OPTIONALBUILDDEPENDENCIES=
export LICENSEFILE=COPYING
export LICENSETYPE=GPL
#export DOWNLOADURL="http://postgis.net/source"
#export DOWNLOADURL="http://postgis.net/development/source_code/"
export DOWNLOADURL="http://download.osgeo.org/postgis/source/"
export INSTALLPREFIX=`pwd`/inst_$BASENAME-$VERSION
#export DOWNLOADSOURCEURL=http://download.osgeo.org/postgis/source/$BASENAME-$VERSION.tar.gz
export DOWNLOADSOURCEURL=https://download.osgeo.org/postgis/source/$BASENAME-$VERSION.tar.gz
wl-showstatus download
wl-download -v -d $TARBALLDIR/$BASENAME $DOWNLOADSOURCEURL
wl-wait4deps
tar xz --force-local -f $TARBALLDIR/$BASENAME/$BASENAME-$VERSION.tar.gz
cd $BASENAME-$VERSION
# fix missing json_tokener_errors in liblwgeom/lwin_geojson.c
patch -ulbf liblwgeom/lwin_geojson.c << EOF
--- liblwgeom/lwin_geojson.c  2014-06-25 17:56:30 +0200
+++ liblwgeom/lwin_geojson.c  2014-10-03 10:20:52 +0200
@@ -29,3 +29,3 @@

-#ifndef JSON_C_VERSION
+#if defined(JSON_C_VERSION) && JSON_C_MAJOR_VERSION == 0 && JSON_C_MINOR_VERSION < 10
 // Adds support for libjson < 0.10
EOF
# fix invalid number of parameters to get_attstatsslot/free_attstatsslot in postgis/gserialized_estimate.c (version >= 2.3.3)
patch -ulbf postgis/gserialized_estimate.c << EOF
@@ -828,4 +828,3 @@
   /* Then read the geom status histogram from that */
-  rv = get_attstatsslot(stats_tuple, 0, 0, stats_kind, InvalidOid,
-                        NULL, NULL, NULL, &floatptr, &nvalues);
+  rv = get_attstatsslot(NULL, stats_tuple, stats_kind, InvalidOid, 0);
   if ( ! rv ) {
@@ -841,3 +840,3 @@
   /* Clean up */
-  free_attstatsslot(0, NULL, 0, floatptr, nvalues);
+  free_attstatsslot(NULL);

EOF
# fix missing FLT_MAX in libpgcommon/gserialized_gist.c (version >= 2.3.3)
mv libpgcommon/gserialized_gist.c libpgcommon/gserialized_gist.c.bak &&
echo "#include <float.h>" > libpgcommon/gserialized_gist.c &&
cat libpgcommon/gserialized_gist.c.bak >> libpgcommon/gserialized_gist.c
# fix missing FLT_MAX in postgis/gserialized_gist_nd.c (version >= 2.3.3)
mv postgis/gserialized_gist_nd.c postgis/gserialized_gist_nd.c.bak &&
echo "#include <float.h>" > postgis/gserialized_gist_nd.c &&
cat postgis/gserialized_gist_nd.c.bak >> postgis/gserialized_gist_nd.c
## fix missing asprintf in loader/shpcommon.c (version >= 2.2.0)
#mv loader/shpcommon.c loader/shpcommon.c.bak
#cat > loader/shpcommon.c << EOF
##include <stdio.h>
##include <stdlib.h>
##include <stdarg.h>
##include <string.h>
#int asprintf(char **strp, const char *fmt, ...)
#{
#  int size;
#  va_list args;
#  va_start(args, fmt);
#  if ((size = vsnprintf(NULL, 0, fmt, args)) < 0)
#    return size;
#  if ((*strp = (char*)malloc((size_t)size + 1)) == NULL)
#    return -1;
#  return vsnprintf(*strp, (size_t)size + 1, fmt, args);
#} 
#EOF
#cat loader/shpcommon.c.bak >> loader/shpcommon.c
# fix postgis/mvt.c (version >= 3.4.3)
patch -ulbf postgis/mvt.c << EOF
@@ -113,3 +113,2 @@

-       feature->has_id = builder->has_id;
        feature->id = builder->id;
EOF
# fix postgis/geobuf.c (version >= 3.4.3)
patch -ulbf postgis/geobuf.c << EOF
@@ -635,3 +635,2 @@
        if (ctx->dimensions != 2) {
-               data->has_dimensions = ctx->has_dimensions;
                data->dimensions = ctx->dimensions;
@@ -644,3 +643,2 @@
        if (ctx->precision != 6) {
-               data->has_precision = 1;
                data->precision = ctx->precision;
EOF
# fix undefined bzero() in liblwgeom/ptarray.c (version >= 3.4.3)
sed -i.bak -e "1i #define bzero(b,len) memset(b, 0, len)" liblwgeom/ptarray.c
## fix invalid --c_out= (version >= 2.4.0)
#mv postgis/Makefile postgis/Makefile.bak &&
#sed -e "s/protoc-c \(.*\)-I[^ ]*/protoc-gen-c.exe \1/; s/--c_out=/--cpp_out=/g" postgis/Makefile.bak > postgis/Makefile
wl-showstatus configure &&
 #autoreconf -f -i -I macros -I $MINGWPREFIX/share/aclocal &&
 #./configure --prefix=$INSTALLPREFIX --build=$BUILDPLATFORM --host=$RUNPLATFORM --without-raster --without-protobuf &&
 #./configure --prefix=$INSTALLPREFIX --build=$BUILDPLATFORM --host=$RUNPLATFORM --without-raster &&
 #./configure --prefix=$INSTALLPREFIX --build=$BUILDPLATFORM --host=$RUNPLATFORM &&
 #./configure --prefix=$INSTALLPREFIX --build=$BUILDPLATFORM --host=$RUNPLATFORM --with-gdalconfig="$(which gdal-config)" &&
 ./configure --prefix=$INSTALLPREFIX --build=$BUILDPLATFORM --host=$RUNPLATFORM --with-gdalconfig="$(which gdal-config)" --with-sfcgal=auto &&
 #--without-protobuf 
 # fix building DLLs
 sed -i.bak -e "s/\(allow_undefined=\)yes/\1no/" libtool &&
 # fix -L flag without path (version >= 3.5.3)
 ( sed -i.bak -e "s/-L \(-l\)/\1/" $(grep -l "\-L -l" $(find -name Makefile)) || true ) &&
 wl-showstatus build-install &&
 ## fix missing libSFCGAL.a (use libSFCGAL.dll.a instead)
 #mv liblwgeom/Makefile liblwgeom/Makefile.bak &&
 #sed -e "s/\(-lSFCGAL\)/\1.dll/" liblwgeom/Makefile.bak > liblwgeom/Makefile &&
 #make install INSTALL=$(pwd)/install-sh &&
 #make install &&
 make install PROTOCC=protoc.exe &&
 wl-makepackage -c -d && wl-install -d $BASENAME-$VERSION && cd .. && wl-showstatus cleanup && rm -rf $BASENAME-$VERSION
####TO DO: --with-raster and GDAL support
####TO DO: some files are installed outside of $INSTALLPREFIX
####------------------------------------------------------------------------
####  WARNING: You have set the --prefix to '/R/x86_64-7.2.0-release-posix-seh-rt_v6-rev0/inst_postgis-2.5.4'. But we mostly
####  ignore the --prefix. For your info, using the values determined from
####  /custombuilt/bin/pg_config we will be installing:
####    * postgis shared library in D:/Prog/x86_64-7.2.0-release-posix-seh-rt_v6-rev0/custombuilt/lib
####    * postgis SQL files in D:/Prog/x86_64-7.2.0-release-posix-seh-rt_v6-rev0/custombuilt/share/contrib/postgis-2.5
####    * postgis executables in D:/Prog/x86_64-7.2.0-release-posix-seh-rt_v6-rev0/custombuilt/bin
####------------------------------------------------------------------------



