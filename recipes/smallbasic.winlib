export NAME="SmallBASIC"
export STATUS=
export URL=https://github.com/smallbasic/SmallBASIC
export BASENAME=smallbasic
export DESCRIPTION="SmallBASIC is a fast and easy to learn BASIC language interpreter ideal for everyday calculations, scripts and prototypes. SmallBASIC includes trigonometric, matrices and algebra functions, a built in IDE, a powerful string library, system, sound, and graphic commands along with structured programming syntax."
export CATEGORY=development
export TYPE=application
export VERSION=12.24
export VERSIONDATE=20221029
wl-showstatus --package-version
#export DEPENDANCIES=jsmn,lodepng
export DEPENDANCIES=jsmn,lodepng,stb,sdl2,freetype2,miniaudio
export OPTIONALDEPENDANCIES=
export BUILDDEPENDANCIES=
export LICENSEFILE=COPYING
export LICENSETYPE=GPL
export DOWNLOADURL="https://github.com/smallbasic/SmallBASIC/releases"
export INSTALLPREFIX=`pwd`/inst_$BASENAME-$VERSION
export DOWNLOADSOURCEURL=https://github.com/smallbasic/SmallBASIC/archive/refs/tags/v$VERSION.tar.gz
wl-showstatus download
wl-download -v -d $TARBALLDIR/$BASENAME $DOWNLOADSOURCEURL
wl-wait4deps
wl-showstatus extract
tar xfz $TARBALLDIR/$BASENAME/v$VERSION.tar.gz
cd SmallBASIC-$VERSION
# fix src/common/var_map.c (version >= 12.24)
patch -ulbf src/common/var_map.c << EOF
@@ -20,3 +20,3 @@

-#include "lib/jsmn/jsmn.h"
+#include <jsmn.h>

EOF
# fix src/ui/image.cpp (version >= 12.24)
patch -ulbf src/ui/image.cpp << EOF
@@ -14,3 +14,3 @@
 #include "lib/maapi.h"
-#include "lib/lodepng/lodepng.h"
+#include <lodepng.h>
 #include "ui/image.h"
EOF
# fix src/platform/console/image.cpp (version >= 12.24)
patch -ulbf src/platform/console/image.cpp << EOF
@@ -24,3 +24,3 @@
 #include "ui/rgb.h"
-#include "lib/lodepng/lodepng.h"
+#include <lodepng.h>

EOF
# fix src/ui/textedit.h (version >= 12.24)
patch -ulbf src/ui/textedit.h << EOF
@@ -20,3 +20,3 @@
 #include <ctype.h>
-#include "lib/stb/stb_textedit.h"
+#include <stb_textedit.h>
 #include "ui/inputs.h"
EOF
# fix src/ui/textedit.cpp (version >= 12.24)
patch -ulbf src/ui/textedit.cpp << EOF
@@ -62,3 +62,3 @@
 #pragma GCC diagnostic ignored "-Wunused-function"
-#include "lib/stb/stb_textedit.h"
+#include <stb_textedit.h>
 #pragma GCC diagnostic pop
EOF
# fix src/ui/audio.cpp (version >= 12.24)
patch -ulbf src/ui/audio.cpp << EOF
@@ -17,3 +17,3 @@
 #include "ui/audio.h"
-#include "lib/miniaudio/miniaudio.h"
+#include <miniaudio.h>

EOF
# fix missing file
touch README
# fix missing ../../lib/lodepng/lodepng.*
sed -i.bak -e "s?\.\./\.\./lib/lodepng/lodepng\.[^ ]*??g" src/platform/console/Makefile.am src/platform/sdl/Makefile.am
wl-showstatus preconfigure &&
 mkdir -p m4 &&
 autoreconf -f -i -I m4 -I $MINGWPREFIX/share/aclocal &&
 wl-showstatus configure &&
 #./configure --prefix=$INSTALLPREFIX --build=$BUILDPLATFORM --host=$RUNPLATFORM LDFLAGS="-Wl,--as-needed" LIBS="-llodepng" &&
 ./configure --prefix=$INSTALLPREFIX --build=$BUILDPLATFORM --host=$RUNPLATFORM --enable-sdl --enable-web --enable-fltk LDFLAGS="-Wl,--as-needed" LIBS="-lbz2 -lpng -llodepng -lbrotlidec -lbrotlienc -lbrotlicommon -lz" &&
 #--enable-sdl --enable-web --enable-fltk 
 ## fix building DLLs
 #sed -i.bak -e "s/\(allow_undefined=\)yes/\1no/" libtool &&
 ## fix detection of shared libraries
 #sed -i.bak2 -e "s/\(deplibs_check_method=\"\)[^\"]*/\1file_magic ^x86 archive import|^x86 DLL|PE32+* executable (DLL)|pe-i386|pe-x86-64/; s/'file format pe-i386[^']*'/\"\$deplibs_check_method\"/" libtool &&
 #sed -i.bak2 -e "s/\(deplibs_check_method=\"\)[^\"]*/\1none/" libtool &&
 #sed -i.bak2 -e "s/\(deplibs_check_method=\"\)[^\"]*/\1pass_all/" libtool &&
 #wl-showstatus build &&
 #make &&
 wl-showstatus build-install &&
 make install-strip &&
 wl-makepackage -c -d && wl-install -d $BASENAME-$VERSION && cd .. && wl-showstatus cleanup && rm -rf SmallBASIC-$VERSION



