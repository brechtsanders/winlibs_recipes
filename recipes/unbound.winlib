export NAME="unbound"
export STATUS=
export URL=http://www.unbound.net/
export BASENAME=unbound
export DESCRIPTION="Unbound is a validating, recursive, and caching DNS resolver."
export CATEGORY=communication
export TYPE=library
#export VERSION=1.3.4
#export VERSION=1.4.5
#export VERSIONDATE=20100615
#export VERSION=1.4.6
#export VERSIONDATE=20100803
#export DEPENDANCIES=openssl
#export VERSION=1.4.7
#export VERSIONDATE=20101108
#export VERSION=1.4.8
#export VERSIONDATE=20110125
#export VERSION=1.4.9
#export VERSIONDATE=20110324
#export VERSION=1.4.10
#export VERSIONDATE=20110525
#export VERSION=1.4.11
#export VERSIONDATE=20110630
#export VERSION=1.4.12
#export VERSIONDATE=20110714
#export VERSION=1.4.13
#export VERSIONDATE=20110915
#export VERSION=1.4.14
#export VERSIONDATE=20111219
#export VERSION=1.4.15
#export VERSIONDATE=20120126
#export VERSION=1.4.16
#export VERSIONDATE=20120202
#export VERSION=1.4.17
#export VERSIONDATE=20120524
#export VERSION=1.4.18
#export VERSIONDATE=20120802
#export VERSION=1.4.19
#export VERSIONDATE=20121212
#export VERSION=1.4.20
#export VERSIONDATE=20130321
#export VERSION=1.4.21
#export VERSIONDATE=20130919
#export VERSION=1.4.22
#export VERSIONDATE=20140312
#export VERSION=1.5.0
#export VERSIONDATE=20141118
#export VERSION=1.5.1
#export VERSIONDATE=20141208
####winrc/anchor-update.c:98: undefined reference to `sldns_wire2str_rdata_buf'
#export VERSION=1.5.2
#export VERSIONDATE=20150219
####util/locks.c:57:2: error: unknown type name 'sigset_t'
#export VERSION=1.5.3
#export VERSIONDATE=20150311
#export VERSION=1.5.4
#export VERSIONDATE=20150710
####compat/arc4_lock.c:58: undefined reference to `lock_basic_init'
#export VERSION=1.5.5
#export VERSIONDATE=20151006
#export VERSION=1.5.6
#export VERSIONDATE=20151020
#export VERSION=1.5.7
#export VERSIONDATE=20151210
#export VERSION=1.5.8
#export VERSIONDATE=20160406
#export VERSION=1.5.9
#export VERSIONDATE=20160609
#export VERSION=1.5.10
#export VERSIONDATE=20160927
####util/locks.c:57:2: error: unknown type name 'sigset_t'
#export VERSION=1.6.0
#export VERSIONDATE=20161215
#export VERSION=1.6.1
#export VERSIONDATE=20170222
#export VERSION=1.6.2
#export VERSIONDATE=20170424
#export VERSION=1.6.3
#export VERSIONDATE=20170613
#export VERSION=1.6.4
#export VERSIONDATE=20170627
#export VERSION=1.6.5
#export VERSIONDATE=20170821
#export VERSION=1.6.6
#export VERSIONDATE=20170919
#export VERSION=1.6.7
#export VERSIONDATE=20171010
#export VERSION=1.6.8
#export VERSIONDATE=20171019
#export VERSION=1.7.0
#export VERSIONDATE=20180315
#export VERSION=1.7.1
#export VERSIONDATE=20180503
#export VERSION=1.7.2
#export VERSIONDATE=20180611
#export VERSION=1.7.3
#export VERSIONDATE=20180621
#export VERSION=1.8.0
#export VERSIONDATE=20180910
#export VERSION=1.8.1
#export VERSIONDATE=20181008
#export VERSION=1.8.2
#export VERSIONDATE=20181204
#export VERSION=1.8.3
#export VERSIONDATE=20181211
#export VERSION=1.9.0
#export VERSIONDATE=20190205
#export VERSION=1.9.1
#export VERSIONDATE=20190312
#export VERSION=1.9.2
#export VERSIONDATE=20190617
#export VERSION=1.9.3
#export VERSIONDATE=20190827
#export VERSION=1.9.4
#export VERSIONDATE=20191003
#export VERSION=1.9.5
#export VERSIONDATE=20191119
#export VERSION=1.9.6
#export VERSIONDATE=20191213
#export VERSION=1.10.0
#export VERSIONDATE=20200220
#export VERSION=1.10.1
#export VERSIONDATE=20200519
#export VERSION=1.11.0
#export VERSIONDATE=20200727
#export VERSION=1.12.0
#export VERSIONDATE=20201009
#export VERSION=1.13.0
#export VERSIONDATE=20201203
#export VERSION=1.13.1
#export VERSIONDATE=20210209
#export VERSION=1.13.2
#export VERSIONDATE=20210812
#export VERSION=1.14.0
#export VERSIONDATE=20211209
#export VERSION=1.15.0
#export VERSIONDATE=20220210
#export VERSION=1.16.0
#export VERSIONDATE=20220602
#export VERSION=1.16.1
#export VERSIONDATE=20220712
#export VERSION=1.16.2
#export VERSIONDATE=20220801
#export VERSION=1.16.3
#export VERSIONDATE=20220921
export VERSION=1.17.0
export VERSIONDATE=20221014
####util/configparser.c:2201: undefined reference to `ub_c_lex'
####issue with flex 2.6.3, see also: https://github.com/westes/flex/issues/154
wl-showstatus --package-version
export DEPENDANCIES=openssl,expat,libldns,wsaerror
export OPTIONALDEPENDANCIES=
export BUILDDEPENDANCIES=
export LICENSEFILE=LICENSE
export LICENSETYPE=BSD
export DOWNLOADURL="http://www.unbound.net/download.html"
export INSTALLPREFIX=`pwd`/inst_$BASENAME-$VERSION
export DOWNLOADSOURCEURL=http://www.unbound.net/downloads/$BASENAME-$VERSION.tar.gz
wl-showstatus download
wl-download -v -d $TARBALLDIR/$BASENAME $DOWNLOADSOURCEURL
wl-wait4deps
tar xfz $TARBALLDIR/$BASENAME/$BASENAME-$VERSION.tar.gz
cd $BASENAME-$VERSION
## fix redefinition of ctime_r
#patch -ulbf compat/ctime_r.c << EOF
#--- compat/ctime_r.c  Tue Aug 25 15:05:32 2009
#+++ compat/ctime_r.c  Thu Nov 26 14:18:32 2009
#@@ -22,2 +22,3 @@
# 
#+#ifndef HAVE_PTHREAD
# char *ctime_r(const time_t *timep, char *buf)
#@@ -39 +40,2 @@
# }
#+#endif
#EOF
# fix undefined reference to wsa_strerror
echo "#include <wsaerror.h>" >> config.h
# fix services/listen_dnsport.c for 64-bit (version >= 1.4.13)
patch -ulbf services/listen_dnsport.c << EOF
--- services/listen_dnsport.c  2011-01-17 14:59:08 +0100
+++ services/listen_dnsport.c  2011-09-15 21:49:54 +0200
@@ -56,2 +56,8 @@
 #include <fcntl.h>
+#ifndef EAFNOSUPPORT
+#define EAFNOSUPPORT 102
+#endif
+#ifndef EPROTONOSUPPORT
+#define EPROTONOSUPPORT 135
+#endif

EOF
# fix missing pipe in util/tube.c on 64-bit (version >= 1.4.13)
if ( echo $RUNPLATFORM | grep -q x86_64 ); then
 mv util/tube.c util/tube.c.bak
 echo "#include <fcntl.h>" > util/tube.c
 echo "#define pipe(fds) _pipe(fds, 4096, _O_BINARY)" >> util/tube.c
 cat util/tube.c.bak >> util/tube.c
fi
# fix missing ECONNREFUSED in smallapp/unbound-control.c on 64-bit (version >= 1.4.13)
if ( echo $RUNPLATFORM | grep -q x86_64 ); then
 mv smallapp/unbound-control.c smallapp/unbound-control.c.bak
 echo "#define ECONNREFUSED WSAECONNREFUSED" > smallapp/unbound-control.c
 cat smallapp/unbound-control.c.bak >> smallapp/unbound-control.c
fi
# fix missing SecureZeroMemory in compat/explicit_bzero.c (version >= 1.5.1)
if ! echo -e "#include<_mingw.h>\nint v=__MINGW64_VERSION_MAJOR;" | ${CC:-gcc} -c -xc - -o /dev/null &> /dev/null; then
 mv compat/explicit_bzero.c compat/explicit_bzero.c.bak &&
 #sed -e "s/SecureZeroMemory/RtlSecureZeroMemory/" compat/explicit_bzero.c.bak > compat/explicit_bzero.c
 sed -e "s?SecureZeroMemory?//&?" compat/explicit_bzero.c.bak > compat/explicit_bzero.c
fi
## fix missing sigset_t in util/locks.c (version >= 1.5.5)
##mv util/locks.c util/locks.c.bak
##echo "#include <sys/types.h>" > util/locks.c
##sed -e "s/sigset_t/_sigset_t/" util/locks.c.bak >> util/locks.c
#patch -ulbf util/locks.c << EOF
#--- util/locks.c  2015-10-06 23:02:39.628184000 +0200
#+++ util/locks.c  2015-10-06 23:09:45.267491800 +0200
#@@ -51,5 +51,5 @@
# ub_thread_blocksigs(void)
# {
#-#if defined(HAVE_PTHREAD) || defined(HAVE_SOLARIS_THREADS) || defined(HAVE_SIGPROCMASK)
#+#if (defined(HAVE_PTHREAD) || defined(HAVE_SOLARIS_THREADS) || defined(HAVE_SIGPROCMASK)) && !defined(__MINGW32__)
# #  if defined(HAVE_PTHREAD) || defined(HAVE_SOLARIS_THREADS)
#        int err;
#@@ -76,5 +76,5 @@
# void ub_thread_sig_unblock(int sig)
# {
#-#if defined(HAVE_PTHREAD) || defined(HAVE_SOLARIS_THREADS) || defined(HAVE_SIGPROCMASK)
#+#if (defined(HAVE_PTHREAD) || defined(HAVE_SOLARIS_THREADS) || defined(HAVE_SIGPROCMASK)) && !defined(__MINGW32__)
# #  if defined(HAVE_PTHREAD) || defined(HAVE_SOLARIS_THREADS)
#        int err;
#EOF
## fix Makefile (version >= 1.5.4)
#mv Makefile.in Makefile.in.bak
#sed -e "s/^\(LIBOBJ_WITHOUT_CTIME=.*\)$/\1 locks.o log.o/" Makefile.in.bak > Makefile.in
## use getentropy_win.c instead of getentropy_linux.c in Makefile (version >= 1.5.5)
#mv Makefile.in Makefile.in.bak2
#sed -e "s/getentropy_linux/getentropy_win/g" Makefile.in.bak2 > Makefile.in
#export DEPENDANCIES=libldns
#--with-ldns=$MINGWPREFIX
#make test
wl-showstatus configure &&
 #./configure --prefix=$INSTALLPREFIX --build=$BUILDPLATFORM --host=$RUNPLATFORM --without-pthreads LDFLAGS="-Wl,-no-undefined" && make lib all install
 #./configure --prefix=$INSTALLPREFIX --build=$BUILDPLATFORM --host=$RUNPLATFORM --with-pthreads --with-ssl=$MINGWPREFIX &&
 #./configure --prefix=$INSTALLPREFIX --build=$BUILDPLATFORM --host=$RUNPLATFORM --without-pthreads --with-ldns==$MINGWPREFIX --with-ssl=$MINGWPREFIX LDFLAGS="-Wl,--enable-auto-import" &&
 #./configure --prefix=$INSTALLPREFIX --build=$BUILDPLATFORM --host=$RUNPLATFORM --without-pthreads --with-ssl=$MINGWPREFIX LDFLAGS="-Wl,--enable-auto-import" &&
 #./configure --prefix=$INSTALLPREFIX --build=$BUILDPLATFORM --host=$RUNPLATFORM --with-pthreads --with-ssl=$MINGWPREFIX --with-libexpat=$MINGWPREFIX LDFLAGS="-Wl,--enable-auto-import -lwsaerror -lws2_32" &&
 #./configure --prefix=$INSTALLPREFIX --build=$BUILDPLATFORM --host=$RUNPLATFORM --with-pthreads --with-ssl=$MINGWPREFIX --with-libexpat=$MINGWPREFIX LDFLAGS="-Wl,--enable-auto-import -lwsaerror" &&
 #./configure --prefix=$INSTALLPREFIX --build=$BUILDPLATFORM --host=$RUNPLATFORM --with-conf-file=$INSTALLPREFIX/etc/unbound/unbound.conf --with-pthreads --with-ssl=$MINGWPREFIX --with-libexpat=$MINGWPREFIX LDFLAGS="-Wl,--enable-auto-import -lwsaerror -lws2_32" &&
 ./configure --prefix=$INSTALLPREFIX --build=$BUILDPLATFORM --host=$RUNPLATFORM --disable-debug --with-conf-file=$INSTALLPREFIX/etc/unbound/unbound.conf --with-pthreads --with-ssl=$MINGWPREFIX --with-libexpat=$MINGWPREFIX LDFLAGS="-Wl,--enable-auto-import -lwsaerror -lws2_32" &&
 # fix invalid double pipe in libtool (version >= 1.5.5)
 sed -i.bak -e 's/^\(global_symbol_pipe=\)""/\1"cat"/' libtool &&
 # fix error: lto1.exe: internal compiler error: in gen_subprogram_die, at dwarf2out.c:22668
 sed -i.bak "s/-g//" Makefile &&
 # avoid using syslog
 echo "#undef HAVE_SYSLOG_H" >> config.h &&
 # fix for Windows build (version >= 1.5.5 <= 1.5.10)
 #echo "#define UB_ON_WINDOWS" >> config.h &&
 ##echo "#define USE_WINSOCK" >> config.h &&
 wl-showstatus build-install &&
 #make -j1 lib all install &&
 #( make -j1 lib all install || ( make -j1 && make -j1 install )) &&
 ( make -j1 lib all install CC=${CC:-gcc} || ( make -j1 && make -j1 install CC=${CC:-gcc} )) &&
 #make -j1 lib all install LIBS="-Wl,--as-needed -lfl" &&
 ## fix hard coded paths (version >= 1.6.0)
 #sed -i -e "s?$INSTALLPREFIX?\$MINGWPREFIX?g" $INSTALLPREFIX/sbin/unbound-control-setup &&
 for F in $(grep -l $INSTALLPREFIX $INSTALLPREFIX/share/man/*/*); do
  sed -i -e "s?$INSTALLPREFIX??g" $F
 done &&
 wl-makepackage -c -d && wl-install -d $BASENAME-$VERSION && cd .. && wl-showstatus cleanup && rm -rf $BASENAME-$VERSION



