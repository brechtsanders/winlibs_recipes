export NAME="RocksDB"
export STATUS=
export URL=http://rocksdb.org/
export BASENAME=rocksdb
export DESCRIPTION="RocksDB is an embeddable persistent key-value store for fast storage."
export CATEGORY=database
export TYPE=library
#export VERSION=5.9.2
#export VERSIONDATE=20180107
##export VERSION=5.10.2
#export VERSIONDATE=20180206
####CMakeFiles/rocksdb-shared.dir/objects.a(clock_cache.cc.obj):clock_cache.cc:(.text+0x285): undefined reference to `tbb::spin_rw_mutex_v3::internal_acquire_reader()'
#export VERSION=5.10.3
#export VERSIONDATE=20180222
#export VERSION=5.10.4
#export VERSIONDATE=20180302
####cache/clock_cache.cc:(.text+0x285): undefined reference to `tbb::spin_rw_mutex_v3::internal_acquire_reader()'
#export VERSION=5.11.2
#export VERSIONDATE=20180313
#export VERSION=5.11.3
#export VERSIONDATE=20180313
#export VERSION=5.12.2
#export VERSIONDATE=20180404
#export VERSION=5.12.4
#export VERSIONDATE=20180424
#export VERSION=5.12.5
#export VERSIONDATE=20180619
#export VERSION=5.13.1
#export VERSIONDATE=20180515
#export VERSION=5.13.2
#export VERSIONDATE=20180526
#export VERSION=5.13.3
#export VERSIONDATE=20180608
#export VERSION=5.13.4
#export VERSIONDATE=20180619
#export VERSION=5.14.2
#export VERSIONDATE=20180705
#export VERSION=5.14.3
#export VERSIONDATE=20180822
#export VERSION=5.15.10
#export VERSIONDATE=20180915
#export VERSION=5.16.6
#export VERSIONDATE=20181113
#export VERSION=5.17.2
#export VERSIONDATE=20181113
#export VERSION=5.18.3
#export VERSIONDATE=20190214
#export VERSION=5.18.4
#export VERSIONDATE=20200212
#export VERSION=6.0.1
#export VERSIONDATE=20190417
#export VERSION=6.0.2
#export VERSIONDATE=20190424
#export VERSION=6.1.1
#export VERSIONDATE=20190604
#export VERSION=6.1.2
#export VERSIONDATE=20190605
#export VERSION=6.2.2
#export VERSIONDATE=20190803
#export VERSION=6.2.4
#export VERSIONDATE=20190920
#export VERSION=6.3.6
#export VERSIONDATE=20191008
#export VERSION=6.4.6
#export VERSIONDATE=20191101
#export VERSION=6.5.2
#export VERSIONDATE=20191213
#export VERSION=6.5.3
#export VERSIONDATE=20200111
#export VERSION=6.6.3
#export VERSIONDATE=20200129
#export VERSION=6.6.4
#export VERSIONDATE=20200201
#export VERSION=6.7.3
#export VERSIONDATE=20200319
#export VERSION=6.8.1
#export VERSIONDATE=20200425
#export VERSION=6.10.1
#export VERSIONDATE=20200528
#export VERSION=6.10.2
#export VERSIONDATE=20200612
#export VERSION=6.11.4
#export VERSIONDATE=20200720
#export VERSION=6.11.6
#export VERSIONDATE=20201013
#export VERSION=6.12.6
#export VERSIONDATE=20201014
#export VERSION=6.12.7
#export VERSIONDATE=20201015
#export VERSION=6.13.3
#export VERSIONDATE=20201014
#export VERSION=6.14.5
#export VERSIONDATE=20201117
#export VERSION=6.14.6
#export VERSIONDATE=20201202
#export VERSION=6.15.2
#export VERSIONDATE=20201230
#export VERSION=6.15.4
#export VERSIONDATE=20210122
#export VERSION=6.15.5
#export VERSIONDATE=20210206
#export VERSION=6.16.3
#export VERSIONDATE=20210515
#export VERSION=6.16.4
#export VERSIONDATE=20210331
#export VERSION=6.17.3
#export VERSIONDATE=20210215
#export VERSION=6.19.3
#export VERSIONDATE=20210421
#export VERSION=6.20.3
#export VERSIONDATE=20210504
#export VERSION=6.22.1
#export VERSIONDATE=20210723
#export VERSION=6.23.2
#export VERSIONDATE=20210806
#export VERSION=6.23.3
#export VERSIONDATE=20210812
#export VERSION=6.24.2
#export VERSIONDATE=20211014
#export VERSION=6.25.1
#export VERSIONDATE=20211014
#export VERSION=6.25.3
#export VERSIONDATE=20211016
#export VERSION=6.26.0
#export VERSIONDATE=20211111
#export VERSION=6.26.1
#export VERSIONDATE=20211119
#export VERSION=6.27.3
#export VERSIONDATE=20211221
#export VERSION=6.28.2
#export VERSIONDATE=20220202
#export VERSION=6.29.3
#export VERSIONDATE=20220219
#export VERSION=6.29.4
#export VERSIONDATE=20220323
#export VERSION=7.0.1
#export VERSIONDATE=20220312
#export VERSION=7.0.2
#export VERSIONDATE=20220315
#export VERSION=7.0.3
#export VERSIONDATE=20220326
#export VERSION=7.1.1
#export VERSIONDATE=20220414
#export VERSION=7.1.2
#export VERSIONDATE=20220420
#export VERSION=7.2.2
#export VERSIONDATE=20220506
#export VERSION=7.3.1
#export VERSIONDATE=20220611
#export VERSION=7.4.3
#export VERSIONDATE=20220719
####util/filter_bench.cc:(.text+0x634): undefined reference to `__gxx_personality_sj0'
####util/filter_bench.cc:(.text+0x6a6): undefined reference to `_Unwind_SjLj_Register'
####util/filter_bench.cc:(.text+0x14ba): undefined reference to `_Unwind_SjLj_Unregister'
####util/filter_bench.cc:(.text+0x1c83): undefined reference to `_Unwind_SjLj_Resume'
#export VERSION=7.4.4
#export VERSIONDATE=20220729
#export VERSION=7.4.5
#export VERSIONDATE=20220803
#export VERSION=7.5.3
#export VERSIONDATE=20220825
#export VERSION=7.6.0
#export VERSIONDATE=20220921
#export VERSION=7.7.2
#export VERSIONDATE=20221008
#export VERSION=7.7.3
#export VERSIONDATE=20221014
#export VERSION=7.7.8
#export VERSIONDATE=20221216
#export VERSION=7.8.3
#export VERSIONDATE=20221216
#export VERSION=7.9.2
#export VERSIONDATE=20230118
#export VERSION=7.10.2
#export VERSIONDATE=20230302
#export VERSION=8.0.0
#export VERSIONDATE=20230318
#export VERSION=8.1.1
#export VERSIONDATE=20230421
#export VERSION=8.3.2
#export VERSIONDATE=20230624
#export VERSION=8.3.3
#export VERSIONDATE=20230902
#export VERSION=8.4.4
#export VERSIONDATE=20230902
#export VERSION=8.5.3
#export VERSIONDATE=20230902
#export VERSION=8.5.4
#export VERSIONDATE=20230927
#export VERSION=8.6.7
#export VERSIONDATE=20231006
#export VERSION=8.7.3
#export VERSIONDATE=20231121
#export VERSION=8.8.1
#export VERSIONDATE=20231123
#export VERSION=8.9.1
#export VERSIONDATE=20231212
#export VERSION=8.10.0
#export VERSIONDATE=20240111
#export VERSION=8.10.2
#export VERSIONDATE=20240221
#export VERSION=8.11.4
#export VERSIONDATE=20240410
#export VERSION=9.0.0
#export VERSIONDATE=20240320
#export VERSION=9.0.1
#export VERSIONDATE=20240418
#export VERSION=9.1.0
#export VERSIONDATE=20240419
#export VERSION=9.1.1
#export VERSIONDATE=20240423
#export VERSION=9.2.1
#export VERSIONDATE=20240524
#export VERSION=9.3.1
#export VERSIONDATE=20240629
#export VERSION=9.4.0
#export VERSIONDATE=20240713
#export VERSION=9.5.2
#export VERSIONDATE=20240822
#export VERSION=9.6.1
#export VERSIONDATE=20240907
#export VERSION=9.6.2
#export VERSIONDATE=20241102
#export VERSION=9.7.2
#export VERSIONDATE=20241015
#export VERSION=9.7.3
#export VERSIONDATE=20241018
#export VERSION=9.7.4
#export VERSIONDATE=20241102
#export VERSION=9.8.4
#export VERSIONDATE=20241204
#export VERSION=9.9.3
#export VERSIONDATE=20241218
#export VERSION=9.10.0
#export VERSIONDATE=20250103
#export VERSION=9.11.1
#export VERSIONDATE=20250307
#export VERSION=9.11.2
#export VERSIONDATE=20250330
#export VERSION=10.0.1
#export VERSIONDATE=20250401
#export VERSION=10.1.3
#export VERSIONDATE=20250415
#export VERSION=10.2.1
#export VERSIONDATE=20250430
#export VERSION=10.4.2
#export VERSIONDATE=20250711
#export VERSION=10.5.1
#export VERSIONDATE=20250812
#export VERSION=10.6.2
#export VERSIONDATE=20251023
#export VERSION=10.7.5
#export VERSIONDATE=20251023
#export VERSION=10.8.3
#export VERSIONDATE=20260106
export VERSION=10.9.1
export VERSIONDATE=20260106
wl-showstatus --package-version
export DEPENDENCIES=zlib,libbz2,zstd,liblz4,snappy,tbb
export OPTIONALDEPENDENCIES=liburing
#export BUILDDEPENDENCIES=cmake
export BUILDDEPENDENCIES=cmake,ninja
export OPTIONALBUILDDEPENDENCIES=
export LICENSEFILE=COPYING
#export LICENSEFILE=LICENSE.Apache
#export LICENSEFILE=LICENSE.leveldb
export LICENSETYPE=GPL
export DOWNLOADURL="https://github.com/facebook/rocksdb/releases"
export INSTALLPREFIX=`pwd`/inst_$BASENAME-$VERSION
#export DOWNLOADSOURCEURL=https://github.com/facebook/rocksdb/archive/rocksdb-$VERSION.tar.gz
export DOWNLOADSOURCEURL=https://github.com/facebook/rocksdb/archive/v$VERSION.tar.gz
wl-showstatus download
wl-download -v -d $TARBALLDIR/$BASENAME $DOWNLOADSOURCEURL
#mv $TARBALLDIR/$BASENAME/v$VERSION.tar.gz $TARBALLDIR/$BASENAME/$BASENAME-$VERSION.tar.gz
wl-wait4deps
wl-showstatus extract
#tar xz --force-local -f $TARBALLDIR/$BASENAME/$BASENAME-$VERSION.tar.gz
tar xz --force-local -f $TARBALLDIR/$BASENAME/v$VERSION.tar.gz
#cd rocksdb-rocksdb-$VERSION
cd $BASENAME-$VERSION
# fix missing int64_t in include/rocksdb/rocksdb_namespace.h (version >= 8.9.1)
mv include/rocksdb/rocksdb_namespace.h include/rocksdb/rocksdb_namespace.h.bak &&
echo "#include <cstdint>" > include/rocksdb/rocksdb_namespace.h &&
cat include/rocksdb/rocksdb_namespace.h.bak >> include/rocksdb/rocksdb_namespace.h &&
rm -f include/rocksdb/rocksdb_namespace.h.bak
## fix include/rocksdb/options.h (version >= 8.9.1)
#patch -ulbf include/rocksdb/options.h << EOF
#@@ -33,2 +33,3 @@
# #include "rocksdb/write_buffer_manager.h"
#+#include "rocksdb/c.h"
#
#@@ -465,2 +466,3 @@
#   // out of a change on upgrade should be deliberate and considered.
#+  ROCKSDB_LIBRARY_API
#   DBOptions* OldDefaults(int rocksdb_major_version = 4,
#EOF
#mkdir -p build_win &&
# wl-showstatus configure &&
# #cmake.exe -G"MSYS Makefiles" -DCMAKE_INSTALL_PREFIX:PATH=$INSTALLPREFIX -DCMAKE_BUILD_TYPE:STRING=Release -DFAIL_ON_WARNINGS:BOOL=OFF -DPORTABLE:BOOL=ON -DFORCE_SSE42:BOOL=ON -DWITH_ZLIB:BOOL=ON -DWITH_BZ2:BOOL=ON -DWITH_ZSTD:BOOL=ON -DWITH_LZ4:BOOL=ON -DWITH_MD_LIBRARY:BOOL=ON -DWITH_TESTS:BOOL=OFF -S. -Bbuild_win &&
# #cmake.exe -G"MSYS Makefiles" -DCMAKE_INSTALL_PREFIX:PATH=$INSTALLPREFIX -DCMAKE_BUILD_TYPE:STRING=Release -DFAIL_ON_WARNINGS:BOOL=OFF -DPORTABLE:BOOL=ON -DFORCE_SSE42:BOOL=OFF -DWITH_ZLIB:BOOL=ON -DWITH_BZ2:BOOL=ON -DWITH_ZSTD:BOOL=ON -DWITH_LZ4:BOOL=ON -DWITH_MD_LIBRARY:BOOL=ON -DWITH_TOOLS:BOOL=OFF -DWITH_TESTS:BOOL=OFF -S. -Bbuild_win &&
# cmake.exe -G"MSYS Makefiles" -DCMAKE_INSTALL_PREFIX:PATH=$INSTALLPREFIX -DCMAKE_BUILD_TYPE:STRING=Release -DFAIL_ON_WARNINGS:BOOL=OFF -DPORTABLE:BOOL=ON -DFORCE_SSE42:BOOL=$(if ( echo $RUNPLATFORM | grep -q x86_64 ); then echo ON; else echo OFF; fi) -DWITH_ZLIB:BOOL=ON -DWITH_BZ2:BOOL=ON -DWITH_ZSTD:BOOL=ON -DWITH_LZ4:BOOL=ON -DWITH_MD_LIBRARY:BOOL=ON -DWITH_TOOLS:BOOL=OFF -DWITH_TESTS:BOOL=OFF -S. -Bbuild_win &&
# #cmake.exe -G"MSYS Makefiles" -DCMAKE_INSTALL_PREFIX:PATH=$INSTALLPREFIX -DCMAKE_BUILD_TYPE:STRING=Release -DROCKSDB_BUILD_SHARED:BOOL=ON -DWITH_RUNTIME_DEBUG:BOOL=OFF -DFAIL_ON_WARNINGS:BOOL=OFF -DPORTABLE:BOOL=ON -DFORCE_SSE42:BOOL=$(if ( echo $RUNPLATFORM | grep -q x86_64 ); then echo ON; else echo OFF; fi) -DWITH_WINDOWS_UTF8_FILENAMES:BOOL=ON -DWITH_ZLIB:BOOL=ON -DWITH_BZ2:BOOL=ON -DWITH_ZSTD:BOOL=ON -DWITH_LZ4:BOOL=ON -DWITH_SNAPPY:BOOL=ON -DWITH_MD_LIBRARY:BOOL=ON -DWITH_TOOLS:BOOL=OFF -DWITH_BENCHMARK_TOOLS:BOOL=OFF -DWITH_TESTS:BOOL=OFF -S. -Bbuild_win &&
# wl-showstatus build &&
# make -Cbuild_win &&
# wl-showstatus build-install &&
# #make -Cbuild_win install/strip &&
# strip build_win/librocksdb-shared.dll &&
# mkdir -p $INSTALLPREFIX/include $INSTALLPREFIX/lib $INSTALLPREFIX/bin &&
# cp -rf include/rocksdb $INSTALLPREFIX/include/ &&
# cp -f build_win/*.a $INSTALLPREFIX/lib/ &&
# cp -f build_win/librocksdb-shared.dll.a $INSTALLPREFIX/lib/librocksdb.dll.a &&
# cp -f build_win/*.dll $INSTALLPREFIX/bin/ &&
# #wl-makepackage -c -d && wl-install -d $BASENAME-$VERSION && cd .. && wl-showstatus cleanup && rm -rf rocksdb-rocksdb-$VERSION
# wl-makepackage -c -d && wl-install -d $BASENAME-$VERSION && cd .. && wl-showstatus cleanup && rm -rf $BASENAME-$VERSION
mkdir -p build_win &&
 wl-showstatus configure &&
 #cmake.exe -GNinja -DCMAKE_INSTALL_PREFIX:PATH=$INSTALLPREFIX -DCMAKE_BUILD_TYPE:STRING=Release -DFAIL_ON_WARNINGS:BOOL=OFF -DPORTABLE:BOOL=ON -DFORCE_SSE42:BOOL=ON -DWITH_ZLIB:BOOL=ON -DWITH_BZ2:BOOL=ON -DWITH_ZSTD:BOOL=ON -DWITH_LZ4:BOOL=ON -DWITH_MD_LIBRARY:BOOL=ON -DWITH_TESTS:BOOL=OFF -S. -Bbuild_win &&
 #cmake.exe -GNinja -DCMAKE_INSTALL_PREFIX:PATH=$INSTALLPREFIX -DCMAKE_BUILD_TYPE:STRING=Release -DFAIL_ON_WARNINGS:BOOL=OFF -DPORTABLE:BOOL=ON -DFORCE_SSE42:BOOL=OFF -DWITH_ZLIB:BOOL=ON -DWITH_BZ2:BOOL=ON -DWITH_ZSTD:BOOL=ON -DWITH_LZ4:BOOL=ON -DWITH_MD_LIBRARY:BOOL=ON -DWITH_TOOLS:BOOL=OFF -DWITH_TESTS:BOOL=OFF -S. -Bbuild_win &&
 #cmake.exe -GNinja -DCMAKE_INSTALL_PREFIX:PATH=$INSTALLPREFIX -DCMAKE_BUILD_TYPE:STRING=Release -DFAIL_ON_WARNINGS:BOOL=OFF -DPORTABLE:BOOL=ON -DFORCE_SSE42:BOOL=$(if ( echo $RUNPLATFORM | grep -q x86_64 ); then echo ON; else echo OFF; fi) -DWITH_ZLIB:BOOL=ON -DWITH_BZ2:BOOL=ON -DWITH_ZSTD:BOOL=ON -DWITH_LZ4:BOOL=ON -DWITH_MD_LIBRARY:BOOL=ON -DWITH_TOOLS:BOOL=OFF -DWITH_BENCHMARK_TOOLS:BOOL=OFF -DWITH_ALL_TESTS:BOOL=OFF -DWITH_TESTS:BOOL=OFF -DCMAKE_CXX_FLAGS:STRING="-fpermissive" -S. -Bbuild_win &&
 cmake.exe -GNinja -DCMAKE_INSTALL_PREFIX:PATH=$INSTALLPREFIX -DCMAKE_BUILD_TYPE:STRING=Release -DROCKSDB_BUILD_SHARED:BOOL=ON -DWITH_RUNTIME_DEBUG:BOOL=OFF -DFAIL_ON_WARNINGS:BOOL=OFF -DPORTABLE:BOOL=ON -DFORCE_SSE42:BOOL=$(if ( echo $RUNPLATFORM | grep -q x86_64 ); then echo ON; else echo OFF; fi) -DWITH_ZLIB:BOOL=ON -DWITH_BZ2:BOOL=ON -DWITH_ZSTD:BOOL=ON -DZSTD_INCLUDE_DIRS:PATH=$MINGWPREFIX/include -DWITH_LZ4:BOOL=ON -DWITH_SNAPPY:BOOL=ON -DWITH_MD_LIBRARY:BOOL=ON -DWITH_TBB:BOOL=ON -DTBB_LIBRARIES:STRING="$MINGWPREFIX/lib/$(${PKG_CONFIG:-pkg-config} --libs-only-l tbb|sed -e "s/^-l\(.*\)$/lib\1.dll.a/")" -DWITH_TOOLS:BOOL=ON -DWITH_BENCHMARK_TOOLS:BOOL=OFF -DWITH_ALL_TESTS:BOOL=OFF -DWITH_TESTS:BOOL=OFF -DCMAKE_CXX_FLAGS:STRING="-fpermissive" -S. -Bbuild_win &&
 ## fix invalid flag -march=ON (version >= 8.3.2)
 #sed -i.bak -e "s/-march=ON //" build_win/build.ninja &&
 wl-showstatus build &&
 ninja -Cbuild_win &&
 wl-showstatus build-install &&
 #make -Cbuild_win install/strip &&
 strip build_win/librocksdb-shared.dll &&
 mkdir -p $INSTALLPREFIX/include $INSTALLPREFIX/lib $INSTALLPREFIX/bin &&
 cp -rf include/rocksdb $INSTALLPREFIX/include/ &&
 cp -f build_win/*.a $INSTALLPREFIX/lib/ &&
 cp -f build_win/librocksdb-shared.dll.a $INSTALLPREFIX/lib/librocksdb.dll.a &&
 cp -f build_win/*.dll $INSTALLPREFIX/bin/ &&
 #wl-makepackage -c -d && wl-install -d $BASENAME-$VERSION && cd .. && wl-showstatus cleanup && rm -rf rocksdb-rocksdb-$VERSION
 wl-makepackage -c -d && wl-install -d $BASENAME-$VERSION && cd .. && wl-showstatus cleanup && rm -rf $BASENAME-$VERSION
####Note: in case of build issues uninstall the old version first: wl-uninstall rocksdb



