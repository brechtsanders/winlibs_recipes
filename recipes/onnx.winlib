export NAME="ONNX"
export STATUS=
export URL=https://onnx.ai/
export BASENAME=onnx
export DESCRIPTION="Open Neural Network Exchange (ONNX) is an open ecosystem that empowers AI developers to choose the right tools as their project evolves. ONNX provides an open source format for AI models, both deep learning and traditional ML. It defines an extensible computation graph model, as well as definitions of built-in operators and standard data types."
export CATEGORY=dataprocessing
export TYPE=library
#export VERSION=1.11.0
#export VERSIONDATE=20220323
#export VERSION=12.0.0
#export VERSIONDATE=20220618
export VERSION=1.12.0
export VERSIONDATE=20220619
wl-showstatus --package-version
export DEPENDANCIES=protobuf
export OPTIONALDEPENDANCIES=
export BUILDDEPENDANCIES=cmake,ninja
export LICENSEFILE=LICENSE
export LICENSETYPE=Apache
export DOWNLOADURL="https://github.com/onnx/onnx/releases"
export INSTALLPREFIX=`pwd`/inst_$BASENAME-$VERSION
export DOWNLOADSOURCEURL=https://github.com/onnx/onnx/archive/refs/tags/v$VERSION.tar.gz
wl-showstatus download
wl-download -v -d $TARBALLDIR/$BASENAME $DOWNLOADSOURCEURL
wl-wait4deps
wl-showstatus extract
tar xfz $TARBALLDIR/$BASENAME/v$VERSION.tar.gz
cd $BASENAME-$VERSION
# fix missing stat::stat in onnx/checker.cc (version >= 1.11.0)
patch -ulbf onnx/checker.cc << EOF
@@ -18,5 +18,4 @@
 #include <direct.h>
-#else // POSIX
-#include <sys/stat.h>
 #endif
+#include <sys/stat.h>

EOF
mkdir -p build_static build_shared &&
 wl-showstatus configure &&
 cmake.exe -Wno-dev -GNinja -DCMAKE_INSTALL_PREFIX:PATH=$INSTALLPREFIX -DCMAKE_BUILD_TYPE:STRING=Release -DBUILD_SHARED_LIBS:BOOL=OFF -DONNX_USE_PROTOBUF_SHARED_LIBS:BOOL=OFF -DONNX_COVERAGE:BOOL=OFF -DONNX_BUILD_BENCHMARKS:BOOL=OFF -DONNX_BUILD_TESTS:BOOL=OFF -DPYTHON_EXECUTABLE:FILEPATH=$PYDIR/python.exe -S. -Bbuild_static &&
 #-DPKG_CONFIG_EXECUTABLE:FILEPATH=$(which pkg-config.exe) 
 wl-showstatus configure &&
 cmake.exe -Wno-dev -GNinja -DCMAKE_INSTALL_PREFIX:PATH=$INSTALLPREFIX -DCMAKE_BUILD_TYPE:STRING=Release -DBUILD_SHARED_LIBS:BOOL=ON -DONNX_USE_PROTOBUF_SHARED_LIBS:BOOL=ON -DONNX_COVERAGE:BOOL=OFF -DONNX_BUILD_BENCHMARKS:BOOL=OFF -DONNX_BUILD_TESTS:BOOL=OFF -DPYTHON_EXECUTABLE:FILEPATH=$PYDIR/python.exe -S. -Bbuild_shared &&
 wl-showstatus build-install &&
 ninja -Cbuild_static install/strip &&
 wl-showstatus build-install &&
 ninja -Cbuild_shared install/strip &&
 # move .dll files to bin folder
 mkdir -p $INSTALLPREFIX/bin &&
 mv -f $INSTALLPREFIX/lib/*.dll $INSTALLPREFIX/bin/ &&
 sed -i -e "s?lib\(/[^ /]*\.dll\)\"?bin\1?" $INSTALLPREFIX/lib/cmake/ONNX/ONNXTargets-release.cmake &&
 wl-makepackage -c -d && wl-install -d $BASENAME-$VERSION && cd .. && wl-showstatus cleanup && rm -rf $BASENAME-$VERSION



