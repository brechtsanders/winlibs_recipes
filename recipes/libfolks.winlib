#export NAME="folks"
#export STATUS=
#export URL=http://telepathy.freedesktop.org/wiki/Folks
#export BASENAME=libfolks
#export DESCRIPTION="Libfolks pulls together contacts from any number of accounts supported by the libfolks backends. This release includes a Telepathy backend complete enough to power Empathy and a key file backend to allow contact linking."
#export CATEGORY=communication
#export TYPE=library
##export VERSION=0.2.1
##export VERSIONDATE=20101213
##export VERSION=0.4.0
##export VERSIONDATE=20110315
##export VERSION=0.4.1
##export VERSIONDATE=20110319
#####checking for gobject-introspection... configure: error: gobject-introspection-1.0 is not installed
##export VERSION=0.4.2
##export VERSIONDATE=20110324
##export DEPENDENCIES=glib2,gobject-introspection,libgee,libxml2,gettext,telepathy-glib
#export VERSION=0.4.3
#export VERSIONDATE=20110427
#####configure: error: Package requirements (gee-1.0 < 0.7) were not met:
#####No package 'gee-1.0' found
#export DEPENDENCIES=glib2,libgee,libxml2,gettext,telepathy-glib,dbus-glib
#export OPTIONALDEPENDENCIES=gobject-introspection
##export VERSION=0.5.0
##export VERSIONDATE=20110412
##export VERSION=0.5.1
##export VERSIONDATE=20110514
##export VERSION=0.5.2
##export VERSIONDATE=20110602
#####checking for gobject-introspection... configure: error: gobject-introspection-1.0 is not installed
##export VERSION=0.6.0
##export VERSIONDATE=20110814
##export VERSION=0.6.1
##export VERSIONDATE=20110829
##export VERSION=0.6.2
##export VERSIONDATE=20110908
##export VERSION=0.6.2.1
##export VERSIONDATE=20110909
##export VERSION=0.6.3
##export VERSIONDATE=20110919
##export VERSION=0.6.3.1
##export VERSIONDATE=20110924
##export VERSION=0.6.3.2
##export VERSIONDATE=20110927
##export VERSION=0.6.4
##export VERSIONDATE=20111018
##export VERSION=0.6.4.1
##export VERSIONDATE=20111019
##export VERSION=0.6.5
##export VERSIONDATE=20111111
##export VERSION=0.6.6
##export VERSIONDATE=20120116
##export VERSION=0.6.7
##export VERSIONDATE=20120223
##export VERSION=0.6.8
##export VERSIONDATE=20120327
##export VERSION=0.6.9
##export VERSIONDATE=20120417
##export VERSION=0.7.0
##export VERSIONDATE=20120417
##export VERSION=0.7.1
##export VERSIONDATE=20120615
##export VERSION=0.7.2.1
##export VERSIONDATE=20120629
##export VERSION=0.7.2.2
##export VERSIONDATE=20120703
#####Requested 'libebook-1.2 >= 3.0.1' but version of libebook is 2.32.2
##export VERSION=0.7.3
##export VERSIONDATE=20120730
##export VERSION=0.7.4.1
##export VERSIONDATE=20120912
#####Requested 'telepathy-glib >= 0.19.0' but version of Telepathy-GLib is 0.18.2
##export DEPENDENCIES=glib2,gobject-introspection,libgee,libxml2,gettext,telepathy-glib,dbus-glib,evolution-data-server
##export VERSION=0.8.0
##export VERSIONDATE=20121004
##export VERSION=0.9.1
##export VERSIONDATE=20130218
#####No package 'libebook-1.2' found
##export VERSION=0.9.2
##export VERSIONDATE=20130608
##export VERSION=0.9.3
##export VERSIONDATE=20130625
##export VERSION=0.9.4
##export VERSIONDATE=20130803
##export VERSION=0.9.5
##export VERSIONDATE=20130827
##export VERSION=0.9.6
##export VERSIONDATE=20131107
#####Requested 'libebook-1.2 >= 3.8.1' but version of libebook is 2.32.3
#####No package 'libebook-contacts-1.2' found
##export VERSION=0.9.7
##export VERSIONDATE=20140622
##export VERSION=0.9.7.1
##export VERSIONDATE=20140624
##export VERSION=0.9.8
##export VERSIONDATE=20140813
#####configure: error: Package requirements (libebook-1.2 >= 3.9.1  libebook-contacts-1.2 >= 3.9.1) were not met
##export VERSION=0.10.0
##export VERSIONDATE=20140913
##export VERSION=0.10.1
##export VERSIONDATE=20150120
##export VERSION=0.11.0
##export VERSIONDATE=20150213
##export VERSION=0.11.1
##export VERSIONDATE=20150526
##export VERSION=0.11.2
##export VERSIONDATE=20151128
##export VERSION=0.11.3
##export VERSIONDATE=20160921
##export VERSION=0.11.4
##export VERSIONDATE=20170703
##export DEPENDENCIES=glib2,gobject-introspection,libgee,libxml2,gettext,telepathy-glib,dbus-glib,evolution-data-server,libzeitgeist
##export OPTIONALDEPENDENCIES=
#export BUILDDEPENDENCIES=
#export OPTIONALBUILDDEPENDENCIES=
##export VERSION=0.12.1
##export VERSIONDATE=20190424
#####No package 'libebook-1.2' found
#####No package 'libebook-contacts-1.2' found
##export VERSION=0.13.1
##export VERSIONDATE=20190621
##export VERSION=0.13.2
##export VERSIONDATE=20200205
##export VERSION=0.14.0
##export VERSIONDATE=20200311
#####meson.build:80:0: ERROR: Program(s) ['g-ir-compiler'] not found or not executable
#wl-showstatus --package-version
##export DEPENDENCIES=glib2,gobject-introspection,libgee,libxml2,gettext,telepathy-glib,dbus-glib,evolution-data-server,libzeitgeist
##export OPTIONALDEPENDENCIES=
##export BUILDDEPENDENCIES=meson
##export OPTIONALBUILDDEPENDENCIES=
#export LICENSEFILE=COPYING
#export LICENSETYPE=LGPL
#export DOWNLOADURL="http://ftp.gnome.org/pub/GNOME/sources/folks/ folks-"
#export INSTALLPREFIX=`pwd`/inst_folks-$VERSION
#export DOWNLOADSOURCEURL=http://ftp.gnome.org/pub/gnome/sources/folks/`echo $VERSION|sed 's/^\([0-9]*\.[0-9]*\)\..*$/\1/'`/folks-$VERSION.tar.bz2
##export DOWNLOADSOURCEURL=http://ftp.gnome.org/pub/gnome/sources/folks/`echo $VERSION|sed 's/^\([0-9]*\.[0-9]*\)\..*$/\1/'`/folks-$VERSION.tar.xz
#wl-showstatus download
#wl-download -v -d $TARBALLDIR/$BASENAME $DOWNLOADSOURCEURL
#wl-wait4deps
#tar xj --force-local -f $TARBALLDIR/$BASENAME/folks-$VERSION.tar.bz2
##tar xJ --force-local -f $TARBALLDIR/$BASENAME/folks-$VERSION.tar.xz
#cd folks-$VERSION
## fix missing strnlen in folks/persona.c (version >= 0.4.0)
#if ( echo $RUNPLATFORM | grep -qv x86_64 ); then
#mv folks/persona.c folks/persona.c.bak
#cat > folks/persona.c << EOF
#int strnlen (const char* s, int maxlen) 
#{
#  int i;
#  for (i = 0; i < maxlen; i++)
#    if (s[i] == '\0')
#      return i;
#  return -1;
#}
#EOF
#cat folks/persona.c.bak >> folks/persona.c
#fi
## fix tests/tools/manager-file.py
#mv tests/tools/manager-file.py tests/tools/manager-file.py.bak
##sed -e "s?#\!/usr/bin/python?#\!/bin/env PATH=\$PYDIR:$PATH python.exe?" tests/tools/manager-file.py.bak > tests/tools/manager-file.py
#sed -e "s?#\!/usr/bin/python?#\!/bin/env PATH=\$PY2DIR:$PATH python.exe?" tests/tools/manager-file.py.bak > tests/tools/manager-file.py
## skip making tests/lib/telepathy/contactlist, tests/telepathy and tests/folks
#cat > tests/lib/telepathy/contactlist/Makefile.in << EOF
#clean:
#all:
#install:
#install-strip:
#EOF
#cp -f tests/lib/telepathy/contactlist/Makefile.in tests/lib/telepathy/contactlist/Makefile.am
#cp -f tests/lib/telepathy/contactlist/Makefile.in tests/telepathy/Makefile.in
#cp -f tests/telepathy/Makefile.in tests/telepathy/Makefile.am
#cp -f tests/lib/telepathy/contactlist/Makefile.in tests/folks/Makefile.in
#cp -f tests/folks/Makefile.in tests/folks/Makefile.am
## fix problem detecting GNU gettext tools on 64-bit
#if ( echo $RUNPLATFORM | grep -q x86_64 ); then
# mv configure configure.bak
# sed -e "s/as_fn_error\(.*GNU gettext tools not found; required for intltool\)/as_echo\1/" configure.bak > configure
#fi
## force using newer libgee
#sed -i.bak2 -e "s/gee-1\.0 < 0\.7/gee-0.8/" configure
#wl-showstatus configure &&
##INTLTOOL_PERL="$PERLDIR/bin/perl.exe" ./configure --prefix=$INSTALLPREFIX --build=$BUILDPLATFORM --host=$RUNPLATFORM LDFLAGS="-no-undefined -Wl,-no-undefined" &&
#INTLTOOL_PERL="$PERLDIR/bin/perl.exe" ./configure --prefix=$INSTALLPREFIX --build=$BUILDPLATFORM --host=$RUNPLATFORM LDFLAGS="-Wl,-no-undefined" &&
##INTLTOOL_PERL="$PERLDIR/bin/perl.exe" ./configure --prefix=$INSTALLPREFIX --build=$BUILDPLATFORM --host=$RUNPLATFORM --enable-static --enable-shared LDFLAGS="-Wl,-no-undefined" &&
# wl-showstatus build-install &&
# # fix building DLLs
# mv libtool libtool.bak &&
# sed -e "s/\(allow_undefined=\)yes/\1no/" libtool.bak > libtool &&
# make install-strip &&
# wl-makepackage -c -d && wl-install -d $BASENAME-$VERSION && cd .. && wl-showstatus cleanup && rm -rf folks-$VERSION



export NAME="folks"
export STATUS=
export URL=http://telepathy.freedesktop.org/wiki/Folks
export BASENAME=libfolks
export DESCRIPTION="Libfolks pulls together contacts from any number of accounts supported by the libfolks backends. This release includes a Telepathy backend complete enough to power Empathy and a key file backend to allow contact linking."
export CATEGORY=communication
export TYPE=library
#export VERSION=0.14.0
#export VERSIONDATE=20200311
#export VERSION=0.15.1
#export VERSIONDATE=20210215
#export VERSION=0.15.2
#export VERSIONDATE=20210215
#export VERSION=0.15.3
#export VERSIONDATE=20210719
#export VERSION=0.15.4
#export VERSIONDATE=20220118
#export VERSION=0.15.5
#export VERSIONDATE=20220323
#export VERSION=0.15.6
#export VERSIONDATE=20230306
export VERSION=0.15.7
export VERSIONDATE=20240109
wl-showstatus --package-version
#export DEPENDENCIES=glib2,gobject-introspection,libgee,libxml2,gettext,dbus-glib,libzeitgeist,evolution-data-server
export DEPENDENCIES=glib2,gobject-introspection,libgee,libxml2,gettext,dbus-glib,libzeitgeist
#export DEPENDENCIES=glib2,gobject-introspection,libgee,libxml2,gettext,dbus-glib,libzeitgeist,telepathy-glib
export OPTIONALDEPENDENCIES=
export BUILDDEPENDENCIES=meson
export OPTIONALBUILDDEPENDENCIES=
export LICENSEFILE=COPYING
export LICENSETYPE=LGPL
export DOWNLOADURL="http://ftp.gnome.org/pub/GNOME/sources/folks/ folks-"
export INSTALLPREFIX=`pwd`/inst_folks-$VERSION
export DOWNLOADSOURCEURL=http://ftp.gnome.org/pub/gnome/sources/folks/$(echo $VERSION|sed 's/^\([0-9]*\.[0-9]*\)\..*$/\1/')/folks-$VERSION.tar.xz
wl-showstatus download
wl-download -v -d $TARBALLDIR/$BASENAME $DOWNLOADSOURCEURL
wl-wait4deps
tar xJ --force-local -f $TARBALLDIR/$BASENAME/folks-$VERSION.tar.xz
cd folks-$VERSION
# fix MSVC issue
mkdir -p winfix
cp -rf $PYDIR/lib/distutils winfix/
patch -ulbf winfix/distutils/cygwinccompiler.py << EOF
@@ -85,3 +85,3 @@
         else:
-            raise ValueError("Unknown MS Compiler version %s " % msc_ver)
+            return None

EOF
# don't build tests
sed -i.bak -e "s/subdir('tests')/#&/" meson.build
## fix building both static and shared libraries (not working)
#sed -i.bak2 -e "s/\(static_library\|shared_library\)\(\s*(\)/both_libraries\2/" $(grep -l "static_library\|shared_library" $(find -name meson.build))
#mkdir -p build_both &&
# wl-showstatus configure &&
# #PKG_CONFIG= PYTHONPATH=${PYTHONPATH:+$PYTHONPATH:}$MINGWPREFIX/lib $PYDIR/python.exe $(which meson.py) --prefix $INSTALLPREFIX --backend ninja --buildtype release --strip --default-library both -Dbluez_backend=false -Deds_backend=false -Dlibsocialweb_backend=false -Dofono_backend=false -Dtelepathy_backend=false -Dtracker_backend=false -Dzeitgeist=true -Dimport_tool=true -Dinspect_tool=false -Ddocs=false -Dinstalled_tests=false . build_both &&
# PKG_CONFIG= PYTHONPATH=${PYTHONPATH:+$PYTHONPATH:}$MINGWPREFIX/lib $PYDIR/python.exe $(which meson.py) --prefix $INSTALLPREFIX --backend ninja --buildtype release --strip --default-library both -Dbluez_backend=false -Deds_backend=false -Dofono_backend=false -Dtelepathy_backend=false -Dzeitgeist=true -Dimport_tool=true -Dinspect_tool=false -Ddocs=false -Dinstalled_tests=false . build_both &&
# #-Dtelepathy_backend=true 
# # fix slash/backslash path issue when calling Python from Ninja
# sed -i.bak -e "s?\(COMMAND\|POST_BUILD\)\(\s*=\s*\)\(\"python\.exe\"\)?\1\2\"$(echo $PYDIR/python.exe|sed -e "s?^/\([a-zA-Z]\)/?\1:\\\\\\\\?; s?/?\\\\\\\\?g")\"?" build_*/build.ninja &&
# ## fix Python path issues in meson_exe
# #sed -i.bak -e "s?$PYDIR?$(echo $PYDIR|sed -e "s?^/\([a-zA-Z]\)/?\1:/?")?" build_both/meson-private/meson_exe_python.exe_*.dat &&
# ## fix missing Folks-0.6.gir (version = 0.15.1)
# #####Bug report: https://gitlab.gnome.org/GNOME/folks/-/issues/128
# #sed -i.bak "s/\(Folks.*\)0\.6/\10.7/" Build_both/backends/dummy/lib/FolksDummy-0.7.gir &&
# wl-showstatus build-install &&
# PKG_CONFIG= PATH=$PYDIR:$PATH PYTHONPATH=$(pwd)/winfix:$PYTHONPATH:$MINGWPREFIX/lib ninja -Cbuild_both install &&
# wl-makepackage -c -d && wl-install -d $BASENAME-$VERSION && cd .. && wl-showstatus cleanup && rm -rf folks-$VERSION
#####TO DO: build static library
# also allow building static library
sed -i.bak2 -e "s/shared_\(library(\)/\1/" folks/meson.build backends/*/meson.build
mkdir -p build_static build_shared &&
 wl-showstatus configure &&
 #PKG_CONFIG= PYTHONPATH=${PYTHONPATH:+$PYTHONPATH:}$MINGWPREFIX/lib $PYDIR/python.exe $(which meson.py) --prefix $INSTALLPREFIX --backend ninja --buildtype release --strip --default-library static -Dbluez_backend=false -Deds_backend=false -Dofono_backend=false -Dtelepathy_backend=false -Dzeitgeist=true -Dimport_tool=true -Dinspect_tool=false -Ddocs=false -Dinstalled_tests=false . build_static &&
 PYTHONPATH=${PYTHONPATH:+$PYTHONPATH:}$MINGWPREFIX/lib $PYDIR/python.exe $(which meson.py) --prefix $INSTALLPREFIX --backend ninja --buildtype release --strip --default-library static -Dbluez_backend=false -Deds_backend=false -Dofono_backend=false -Dtelepathy_backend=false -Dzeitgeist=true -Dimport_tool=true -Dinspect_tool=false -Ddocs=false -Dinstalled_tests=false . build_static &&
 #-Dtelepathy_backend=true 
 wl-showstatus configure &&
 #PKG_CONFIG= PYTHONPATH=${PYTHONPATH:+$PYTHONPATH:}$MINGWPREFIX/lib $PYDIR/python.exe $(which meson.py) --prefix $INSTALLPREFIX --backend ninja --buildtype release --strip --default-library shared -Dbluez_backend=false -Deds_backend=false -Dofono_backend=false -Dtelepathy_backend=false -Dzeitgeist=true -Dimport_tool=true -Dinspect_tool=false -Ddocs=false -Dinstalled_tests=false . build_shared &&
 PYTHONPATH=${PYTHONPATH:+$PYTHONPATH:}$MINGWPREFIX/lib $PYDIR/python.exe $(which meson.py) --prefix $INSTALLPREFIX --backend ninja --buildtype release --strip --default-library shared -Dbluez_backend=false -Deds_backend=false -Dofono_backend=false -Dtelepathy_backend=false -Dzeitgeist=true -Dimport_tool=true -Dinspect_tool=false -Ddocs=false -Dinstalled_tests=false . build_shared &&
 wl-showstatus build-install &&
 #PKG_CONFIG= PATH=$PYDIR:$PATH PYTHONPATH=$(pwd)/winfix:$PYTHONPATH:$MINGWPREFIX/lib ninja -Cbuild_static install &&
 PATH=$PYDIR:$PATH PYTHONPATH=$(pwd)/winfix:$PYTHONPATH:$MINGWPREFIX/lib ninja -Cbuild_static install &&
 wl-showstatus build-install &&
 #PKG_CONFIG= PATH=$PYDIR:$PATH PYTHONPATH=$(pwd)/winfix:$PYTHONPATH:$MINGWPREFIX/lib ninja -Cbuild_shared install &&
 PATH=$PYDIR:$PATH PYTHONPATH=$(pwd)/winfix:$PYTHONPATH:$MINGWPREFIX/lib ninja -Cbuild_shared install &&
 wl-makepackage -c -d && wl-install -d $BASENAME-$VERSION && cd .. && wl-showstatus cleanup && rm -rf folks-$VERSION
#####TO DO: build with -Dtelepathy_backend=true



