export NAME="ACPICA"
export STATUS=
export URL=https://acpica.org/
export BASENAME=acpica
export DESCRIPTION="The ACPI Component Architecture (ACPICA) project provides an operating system (OS)-independent reference implementation of the Advanced Configuration and Power Interface Specification (ACPI)."
export CATEGORY=system,programming
export TYPE=application
#export VERSION=20130927
#export VERSIONDATE=
#export VERSION=20140424
#export VERSIONDATE=20140426
#export VERSION=20140627
#export VERSIONDATE=20140627
#export VERSION=20140724
#export VERSIONDATE=20140725
####source/os_specific/service_layers/osunixmap.c:118:22: fatal error: sys/mman.h: No such file or directory
#export VERSION=20140828
#export VERSIONDATE=20140828
#export VERSION=20140926
#export VERSIONDATE=20140926
#export VERSION=20141107
#export VERSIONDATE=20141108
####/include/stdio.h:543:7: error: static declaration of 'vsnprintf' follows non-static declaration
#export VERSION=20150204
#export VERSIONDATE=20150205
#export VERSION=20150408
#export VERSIONDATE=20150411
#export VERSION=20150515
#export VERSIONDATE=20150516
#export VERSION=20150616
#export VERSIONDATE=20150517
#export VERSION=20150619_0
#export VERSIONDATE=20150619
#export VERSION=20150619_1
#export VERSIONDATE=20150620
#export VERSION=20150717
#export VERSIONDATE=20150720
#export VERSION=20150818
#export VERSIONDATE=20150819
#export VERSION=20150930
#export VERSIONDATE=20151001
#export VERSION=20151124
#export VERSIONDATE=20151127
#export VERSION=20151218
#export VERSIONDATE=20151219
#export VERSION=20160108
#export VERSIONDATE=20160109
#export VERSION=20160212
#export VERSIONDATE=20160213
#export VERSION=20160108
#export VERSIONDATE=20160226
#export VERSION=20160318
#export VERSIONDATE=20160319
#export VERSION=20160422
#export VERSIONDATE=20160423
#export VERSION=20160527
#export VERSIONDATE=20160528
#export VERSION=20160729
#export VERSIONDATE=20160730
####generate/unix/acpibin/utmath.c:(.text+0x5e): undefined reference to `ACPI_DIV_64_BY_32'
#export VERSION=20160831
#export VERSIONDATE=20160901
#export VERSION=20160930
#export VERSIONDATE=20161001
#export VERSION=20161117
#export VERSIONDATE=20161118
#export VERSION=20161222
#export VERSIONDATE=20161223
#export VERSION=20170119
#export VERSIONDATE=20170120
#export VERSION=20170224
#export VERSIONDATE=20170225
#export VERSION=20170303
#export VERSIONDATE=20170304
#export VERSION=20170531
#export VERSIONDATE=20170601
#export VERSION=20170629
#export VERSIONDATE=20170630
#export VERSION=20170728
#export VERSIONDATE=20170814
#export VERSION=20170831
#export VERSIONDATE=20170901
#export VERSION=20170929
#export VERSIONDATE=20170930
#export VERSION=20171110
#export VERSIONDATE=20171111
#export VERSION=20171214
#export VERSIONDATE=20171215
#export VERSION=20171215
#export VERSIONDATE=20171216
#export VERSION=20180105
#export VERSIONDATE=20180106
#export VERSION=20180209
#export VERSIONDATE=20180210
#export VERSION=20180313
#export VERSIONDATE=20180314
#export VERSION=20180427
#export VERSIONDATE=20180427
#export VERSION=20180508
#export VERSIONDATE=20180509
#export VERSION=20180531
#export VERSIONDATE=20180601
#export VERSION=20180629
#export VERSIONDATE=20180630
#export VERSION=20180810
#export VERSIONDATE=20180811
#export VERSION=20180927
#export VERSIONDATE=20180928
#export VERSION=20181003
#export VERSIONDATE=20181004
#export VERSION=20181031
#export VERSIONDATE=20181101
#export VERSION=20181213
#export VERSIONDATE=20181214
#export VERSION=20190108
#export VERSIONDATE=20190109
#export VERSION=20190215
#export VERSIONDATE=20190216
#export VERSION=20190329
#export VERSIONDATE=20190330
#export VERSION=20190405
#export VERSIONDATE=20190406
#export VERSION=20190509
#export VERSIONDATE=20190510
#export VERSION=20190703
#export VERSIONDATE=20190710
#export VERSION=20191018
#export VERSIONDATE=20191019
#export VERSION=20191213
#export VERSIONDATE=20191214
#export VERSION=20200110
#export VERSIONDATE=20200111
#export VERSION=20200214
#export VERSIONDATE=20200215
#export VERSION=20200326
#export VERSIONDATE=20200327
#export VERSION=20200430
#export VERSIONDATE=20200501
#export VERSION=20200528
#export VERSIONDATE=20200529
#export VERSION=20200717
#export VERSIONDATE=20200719
#export VERSION=20200925
#export VERSIONDATE=20201009
#export VERSION=20201113
#export VERSIONDATE=20201114
#export VERSION=20201217
#export VERSIONDATE=20201218
#export VERSION=20210105
#export VERSIONDATE=20210106
#export VERSION=20210331
#export VERSIONDATE=20210401
#export VERSION=20210604
#export VERSIONDATE=20210605
#export VERSION=20210730
#export VERSIONDATE=20210731
#export VERSION=20210930
#export VERSIONDATE=20211001
#export VERSION=20211217
#export VERSIONDATE=20211218
#export VERSION=20220331
#export VERSIONDATE=20220401
#export VERSION=20221020
#export VERSIONDATE=20221028
export VERSION=20230331
export VERSIONDATE=20230401
wl-showstatus --package-version
export DEPENDENCIES=
export OPTIONALDEPENDENCIES=
export BUILDDEPENDENCIES=
export OPTIONALBUILDDEPENDENCIES=
#export LICENSEFILE=COPYING
export LICENSEFILE=
export LICENSETYPE=
#export DOWNLOADURL="https://acpica.org/downloads acpica-unix2-"
#export DOWNLOADURL="https://acpica.org/downloads iasl-win-"
export DOWNLOADURL="https://acpica.org/downloads/windows-source acpica-win-"
#export DOWNLOADURL="https://github.com/acpica/acpica/releases"
export INSTALLPREFIX=`pwd`/inst_$BASENAME-$VERSION
#export DOWNLOADSOURCEURL=https://acpica.org/sites/acpica/files/acpica-unix2-$VERSION.tar.gz
#export DOWNLOADSOURCEURL=https://acpica.org/sites/acpica/files/iasl-win-$VERSION.tar.gz
export DOWNLOADSOURCEURL=https://acpica.org/sites/acpica/files/acpica-win-$VERSION.zip
#export DOWNLOADSOURCEURL=https://github.com/acpica/acpica/archive/refs/tags/R$(echo $VERSION|sed -e "s/^20\([0-9][0-9]\)\([0-9][0-9]\)\([0-9][0-9]\)$/\2_\3_\1/").tar.gz
wl-showstatus download
wl-download -v -d $TARBALLDIR/$BASENAME $DOWNLOADSOURCEURL
wl-wait4deps
#tar xz --force-local -f $TARBALLDIR/$BASENAME/acpica-unix2-$VERSION.tar.gz
#cd acpica-unix2-$VERSION
#cat > generate/unix/Makefile.config << EOF
#HOST = WIN$(if ( echo $RUNPLATFORM | grep -qv x86_64 ); then echo 32; else echo 64; fi)
#CC = ${CC:-gcc}
#ACPICA_SRC = ../../../source
#EOF
#mv generate/release/build.sh generate/release/build.sh.bak
#sed -e "s?/cygdrive/c/windows/pkzip25.exe?`which zip`?; s?documents/changes?changes?g" generate/release/build.sh.bak > generate/release/build.sh
#cd generate/release
#mkdir -p current
#wl-showstatus build &&
##./build.sh source win &&
#./build.sh source unix &&
#    echo OK
# wl-showstatus build-install &&
# wl-makepackage -c -d && wl-install -d $BASENAME-$VERSION && cd .. && rm -rf acpica-unix2-$VERSION

#wl-showstatus build-install &&
#mkdir -p $INSTALLPREFIX/bin
#unzip -oq $TARBALLDIR/$BASENAME/iasl-win-$VERSION.zip *.exe -d $INSTALLPREFIX/bin &&
# wl-makepackage -c -d && wl-install -d $BASENAME-$VERSION

wl-showstatus extract
#mkdir -p $BASENAME-$VERSION
unzip -oq $TARBALLDIR/$BASENAME/acpica-win-$VERSION.zip -d $BASENAME-$VERSION
cd $BASENAME-$VERSION
#tar xz --force-local -f $TARBALLDIR/$BASENAME/R$(echo $VERSION|sed -e "s/^20\([0-9][0-9]\)\([0-9][0-9]\)\([0-9][0-9]\)$/\2_\3_\1/").tar.gz
#cd $BASENAME-R$(echo $VERSION|sed -e "s/^20\([0-9][0-9]\)\([0-9][0-9]\)\([0-9][0-9]\)$/\2_\3_\1/")
# fix missing sleep in source/os_specific/service_layers/osunixxf.c (version >= 20140424)
if ( echo -e "#include<_mingw.h>\nint v=__MINGW64_VERSION_MAJOR;" | ${CC:-gcc} -c -xc - -o /dev/null &> /dev/null ); then
mv source/os_specific/service_layers/osunixxf.c source/os_specific/service_layers/osunixxf.c.bak
echo "#define sleep(t) _sleep((t) * 1000)" > source/os_specific/service_layers/osunixxf.c
cat source/os_specific/service_layers/osunixxf.c.bak >> source/os_specific/service_layers/osunixxf.c
fi
# use source/os_specific/service_layers/oswindir.c instead of source/os_specific/service_layers/osunixdir.c (version >= 20140424)
mv -f source/os_specific/service_layers/osunixdir.c source/os_specific/service_layers/osunixdir.c.bak
cp -f source/os_specific/service_layers/oswindir.c source/os_specific/service_layers/osunixdir.c
## fix missing ACPI_DIV_64_BY_32 and ACPI_SHIFT_RIGHT_64
#cat >> source/include/platform/acwin.h << EOF
##ifndef do_div
##define do_div(a,b) ((a)/(b))
##endif
#EOF
#grep -A7 "#ifndef ACPI_DIV_64_BY_32" source/include/platform/aclinuxex.h >> source/include/platform/acwin.h
#grep -A7 "#ifndef ACPI_SHIFT_RIGHT_64" source/include/platform/aclinuxex.h >> source/include/platform/acwin.h
#####To do: same for source/include/platform/acwin64.h
# fix redefinition of AcpiOsGetLine
mv source/common/acgetline.c source/common/acgetline.c.bak
touch source/common/acgetline.c
# fix for MinGW
patch -ulbf source/include/platform/acenv.h << EOF
--- source/include/platform/acenv.h  2015-12-18 09:54:00.000000000 +0100
+++ source/include/platform/acenv.h  2015-12-19 14:43:40.216234300 +0100
@@ -268,3 +268,4 @@

-#elif defined(_CYGWIN)
+#elif defined(_CYGWIN) || defined(__MINGW32__)
+#include <stdio.h>
 #include "accygwin.h"
EOF
# fix invalid #pragma in source/compiler/aslcompiler.h (version >= 20160831)
mv source/compiler/aslcompiler.h source/compiler/aslcompiler.h.bak &&
grep -v "#pragma" source/compiler/aslcompiler.h.bak > source/compiler/aslcompiler.h
# fix redefinition of types in source/include/actypes.h (version >= 20160831)
if ${CC:-gcc} --version | grep -q x86_64; then
 mv source/include/actypes.h source/include/actypes.h.bak &&
 echo "#include <windows.h>" > source/include/actypes.h &&
 echo "#define ACPI_USE_SYSTEM_INTTYPES 1" >> source/include/actypes.h &&
 cat source/include/actypes.h.bak >> source/include/actypes.h
fi
# fix missing GetTickCount64 in source/os_specific/service_layers/oswinxf.c (version >= 20191018)
mv source/os_specific/service_layers/oswinxf.c source/os_specific/service_layers/oswinxf.c.bak
cat > source/os_specific/service_layers/oswinxf.c << EOF
#if _WIN32_WINNT < 0x0600 
#undef _WIN32_WINNT
#define _WIN32_WINNT 0x0600 
#endif
EOF
cat source/os_specific/service_layers/oswinxf.c.bak >> source/os_specific/service_layers/oswinxf.c
# fix osunix build stuff
for F in generate/unix/acpidump generate/unix/acpidump generate/unix/acpidump generate/unix/acpiexamples generate/unix/acpiexec generate/unix/acpihelp generate/unix/acpinames generate/unix/acpisrc generate/unix/acpisrc generate/unix/acpixtract generate/unix/iasl; do
 mv $F/Makefile $F/Makefile.bak &&
 sed -e "s/os\(unix\|linux\)/oswin/g; s/-lrt//" $F/Makefile.bak > $F/Makefile
done
# workaround for missing oswinmap.c
touch source/os_specific/service_layers/oswinmap.c
wl-showstatus build &&
 #make -j1 CWARNINGFLAGS= HOST=$(if ( echo $RUNPLATFORM | grep -vq x86_64 ); then echo WIN32; else echo WIN64; fi) OPT_CFLAGS="-DWIN32" &&
 #make -j1 CWARNINGFLAGS= HOST=$(if ( echo $RUNPLATFORM | grep -vq x86_64 ); then echo WIN32; else echo WIN64; fi) &&
 #make -j1 CC=${CC:-gcc} CWARNINGFLAGS= HOST=$(if ( echo $RUNPLATFORM | grep -vq x86_64 ); then echo WIN32; else echo WIN64; fi) &&
 #make CC=${CC:-gcc} CWARNINGFLAGS= HOST=$(if ( echo $RUNPLATFORM | grep -vq x86_64 ); then echo WIN32; else echo WIN64; fi) OPT_LDFLAGS="-Wl,--as-needed -lssp" &&
 make CC=${CC:-gcc} CWARNINGFLAGS= HOST=$(if ( echo $RUNPLATFORM | grep -vq x86_64 ); then echo WIN32; else echo WIN64; fi) OPT_CFLAGS="-D_FORTIFY_SOURCE=2" OPT_LDFLAGS="-Wl,--as-needed -lssp" &&
 wl-showstatus build-install &&
 make -j1 PREFIX=$INSTALLPREFIX CWARNINGFLAGS= HOST=$(if ( echo $RUNPLATFORM | grep -vq x86_64 ); then echo WIN32; else echo WIN64; fi) install &&
 for F in $INSTALLPREFIX/bin/*; do
  attrib -r $F &&
  basename $F | grep -q "^[^.]*$" && mv -f $F $F.exe
 done &&
 wl-makepackage -c -d && wl-install -d $BASENAME-$VERSION && cd .. && rm -rf $BASENAME-$VERSION




