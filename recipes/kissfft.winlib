#export NAME="Kiss FFT"
#export STATUS=
#export URL=http://kissfft.sourceforge.net/
##export URL=https://sourceforge.net/projects/kissfft/
#export BASENAME=kissfft
#export DESCRIPTION="A Fast Fourier Transform based up on the principle, \"Keep It Simple, Stupid.\" Kiss FFT is a very small, reasonably efficient, mixed radix FFT library that can use either fixed or floating point data types."
#export CATEGORY=math
#export TYPE=library
#export VERSION=1.3.0
#export VERSIONDATE=20160410
#wl-showstatus --package-version
##export DEPENDENCIES=mman-win32
#export DEPENDENCIES=
#export OPTIONALDEPENDENCIES=
#export BUILDDEPENDENCIES=
#export OPTIONALBUILDDEPENDENCIES=
#export LICENSEFILE=COPYING
#export LICENSETYPE=
#export DOWNLOADURL="https://sourceforge.net/projects/kissfft/files/kissfft/ v"
#export INSTALLPREFIX=`pwd`/inst_$BASENAME-$VERSION
#export DOWNLOADSOURCEURL=http://downloads.sourceforge.net/project/kissfft/kissfft/v$(echo $VERSION|tr . _)/kiss_fft$(echo $VERSION|sed -e "s/\.//g").tar.gz
#wl-showstatus download
#wl-download -v -d $TARBALLDIR/$BASENAME $DOWNLOADSOURCEURL
#wl-wait4deps
#wl-showstatus extract
#tar xz --force-local -f $TARBALLDIR/$BASENAME/kiss_fft$(echo $VERSION|sed -e "s/\.//g").tar.gz
#cd kiss_fft$(echo $VERSION|sed -e "s/\.//g")
##mv kiss_fft.h kiss_fft.h.bak &&
##echo "#include <stdint.h>" > kiss_fft.h &&
##cat kiss_fft.h.bak >> kiss_fft.h
##mkdir -p winfix/sys
##touch winfix/sys/times.h
##wl-showstatus build &&
## make asm &&
## make testall CC="${CC:-gcc} -I$(pwd)/winfix -I$MINGWPREFIX/include/mman-win32" &&
##    echo OK
## avoid missing sys/mman.h tools/kiss_fastfir.c (version >= 1.3.0)
#sed -i.bak -e "s?^#include <sys/mman\.h>?//&?" tools/kiss_fastfir.c
## fix undefined int16_t/int32_t in kiss_fft.h (version >= 1.3.0)
#patch -ulbf kiss_fft.h << EOF
#@@ -38,2 +38,3 @@
# #include <sys/types.h>
#+#include <stdint.h>
# # if (FIXED_POINT == 32)
#EOF
#wl-showstatus build &&
# ${CC:-gcc} -O3 -c -ffast-math -fomit-frame-pointer -dA -fverbose-asm -o kiss_fft.o kiss_fft.c &&
# ${AR:-ar} cru libkiss_fft.a kiss_fft.o &&
# ( echo "EXPORTS" && ${NM:-nm} -f posix --defined-only -p libkiss_fft.a | sed -n -e "s/^_\{0,1\}\([^ ]*\) T .*$/\1/p" ) > kiss_fft.def &&
# ${CC:-gcc} -s -shared -ffast-math -fomit-frame-pointer -dA -fverbose-asm -def kiss_fft.def -Wl,--out-implib,libkiss_fft.dll.a -o kiss_fft.dll libkiss_fft.a &&
# ${CC:-gcc} -O3 -c -ffast-math -fomit-frame-pointer -dA -fverbose-asm -o kiss_fft_simd.o kiss_fft.c -DUSE_SIMD &&
# ${AR:-ar} cru libkiss_fft_simd.a kiss_fft_simd.o &&
# ( echo "EXPORTS" && ${NM:-nm} -f posix --defined-only -p libkiss_fft_simd.a | sed -n -e "s/^_\{0,1\}\([^ ]*\) T .*$/\1/p" ) > kiss_fft_simd.def &&
# ${CC:-gcc} -s -shared -ffast-math -fomit-frame-pointer -dA -fverbose-asm -o kiss_fft_simd.def -Wl,--out-implib,libkiss_fft_simd.dll.a -o kiss_fft_simd.dll libkiss_fft_simd.a &&
# make -Ctools CC="${CC:-gcc}" CFLAGS="-s" DATATYPE=float &&
# #make -Ctools CC="${CC:-gcc}" CFLAGS="-s" DATATYPE=int16_t &&
# #make -Ctools CC="${CC:-gcc}" CFLAGS="-s" DATATYPE=int32_t &&
# make -Ctools CC="${CC:-gcc}" CFLAGS="-s" DATATYPE=simd &&
# wl-showstatus install &&
# mkdir -p $INSTALLPREFIX/include $INSTALLPREFIX/lib $INSTALLPREFIX/bin $INSTALLPREFIX/src/kiss_fft_tools &&
# cp -f kiss_fft.h kissfft.hh $INSTALLPREFIX/include/ &&
# cp -f *.a $INSTALLPREFIX/lib/ &&
# cp -f *.dll $INSTALLPREFIX/bin/ &&
# cp -f tools/*.exe $INSTALLPREFIX/bin/ &&
# cp -f _kiss_fft_guts.h tools/*.{h,c} $INSTALLPREFIX/src/kiss_fft_tools/ &&
# wl-makepackage -c -d && wl-install -d $BASENAME-$VERSION && cd .. && wl-showstatus cleanup && rm -rf kiss_fft$(echo $VERSION|sed -e "s/\.//g")
#####To do: besides floating point version also build with FIXED_POINT=16 and maybe even FIXED_POINT=32



export NAME="KISS FFT"
export STATUS=
export URL=https://github.com/mborgerding/kissfft
export BASENAME=kissfft
export DESCRIPTION="KISS FFT - A mixed-radix Fast Fourier Transform based up on the principle, \"Keep It Simple, Stupid.\""
export CATEGORY=math
export TYPE=library
export VERSION=131.2.0
export VERSIONDATE=20260208
wl-showstatus --package-version
export DEPENDENCIES=libpng,fftw,mman-win32
export OPTIONALDEPENDENCIES=
export BUILDDEPENDENCIES=cmake,ninja
export OPTIONALBUILDDEPENDENCIES=
export LICENSEFILE=LICENSES/BSD-3-Clause
export LICENSETYPE=BSD
export DOWNLOADURL="https://github.com/mborgerding/kissfft/releases"
export INSTALLPREFIX=`pwd`/inst_$BASENAME-$VERSION
export DOWNLOADSOURCEURL=https://github.com/mborgerding/kissfft/archive/refs/tags/$VERSION.tar.gz
wl-showstatus download
wl-download -v -d $TARBALLDIR/$BASENAME $DOWNLOADSOURCEURL
wl-wait4deps
wl-showstatus extract
tar xz --force-local -f $TARBALLDIR/$BASENAME/$VERSION.tar.gz
cd $BASENAME-$VERSION
# fix CMakeLists.txt (version >= 131.2.0)
patch -ulbf CMakeLists.txt << EOF
@@ -328,3 +328,3 @@
     join_paths(PKGCONFIG_KISSFFT_LIBDIR "\\\${prefix}" "\${CMAKE_INSTALL_LIBDIR}")
-    join_paths(PKGCONFIG_KISSFFT_INCLUDEDIR "\\\${prefix}" "\${CMAKE_INSTALL_INCLUDEDIR}")
+    join_paths(PKGCONFIG_KISSFFT_INCLUDEDIR "\\\${prefix}" "\${CMAKE_INSTALL_INCLUDEDIR}/kissfft")
     if(KISSFFT_DATATYPE MATCHES "^simd\$")
EOF
touch SUCCESS &&
 for O in ON OFF; do
  for I in double int32_t int16_t simd float; do
   echo mkdir -p build_$I\_static build_$I\_shared 
   mkdir -p build_static build_shared &&
   wl-showstatus configure-static $I OMP_$O &&
   cmake.exe -Wno-dev -GNinja -DCMAKE_INSTALL_PREFIX:PATH=$INSTALLPREFIX -DCMAKE_BUILD_TYPE:STRING=Release -DBUILD_SHARED_LIBS:BOOL=OFF -DKISSFFT_STATIC:BOOL=ON -DKISSFFT_DATATYPE:STRING=$I -DKISSFFT_OPENMP:BOOL=$O -DKISSFFT_USE_ALLOCA:BOOL=OFF -DKISSFFT_PKGCONFIG:BOOL=ON -DCMAKE_INSTALL_INCLUDEDIR:FILEPATH=$INSTALLPREFIX/include -DCMAKE_INSTALL_LIBDIR:FILEPATH=$INSTALLPREFIX/lib -DKISSFFT_TOOLS:BOOL=ON -DKISSFFT_TEST:BOOL=OFF -DCMAKE_C_FLAGS:STRING="-I$MINGWPREFIX/include/mman-win32" -S. -Bbuild_static &&
   wl-showstatus configure-shared $I OMP_$O &&
   cmake.exe -Wno-dev -GNinja -DCMAKE_INSTALL_PREFIX:PATH=$INSTALLPREFIX -DCMAKE_BUILD_TYPE:STRING=Release -DBUILD_SHARED_LIBS:BOOL=ON -DKISSFFT_STATIC:BOOL=OFF -DKISSFFT_DATATYPE:STRING=$I -DKISSFFT_OPENMP:BOOL=$O -DKISSFFT_USE_ALLOCA:BOOL=OFF -DKISSFFT_PKGCONFIG:BOOL=ON -DCMAKE_INSTALL_INCLUDEDIR:FILEPATH=$INSTALLPREFIX/include -DCMAKE_INSTALL_LIBDIR:FILEPATH=$INSTALLPREFIX/lib -DKISSFFT_TOOLS:BOOL=ON -DKISSFFT_TEST:BOOL=OFF -DCMAKE_C_FLAGS:STRING="-I$MINGWPREFIX/include/mman-win32" -S. -Bbuild_shared &&
   wl-showstatus build-install-static $I OMP_$O &&
   ninja -Cbuild_static install/strip &&
   wl-showstatus build-install-shared $I OMP_$O &&
   ninja -Cbuild_shared install/strip &&
   touch SUCCESS_$I\_OMP_$O
   rm SUCCESS_$I\_OMP_$O || ( rm -f SUCCESS; false ) || break
  done
 done &&
 rm SUCCESS &&
 mkdir -p $INSTALLPREFIX/src/kiss_fft_tools/ &&
 cp -f _kiss_fft_guts.h kiss_fft_log.h tools/*.c $INSTALLPREFIX/src/kiss_fft_tools/ &&
 cp -u $INSTALLPREFIX/lib/pkgconfig/kissfft-float.pc $INSTALLPREFIX/lib/pkgconfig/kissfft.pc &&
 wl-makepackage -c -d && wl-install -d $BASENAME-$VERSION && cd .. && wl-showstatus cleanup && rm -rf $BASENAME-$VERSION



