export NAME="Ruby"
export STATUS=
export URL=http://www.ruby-lang.org/en/
export BASENAME=ruby
export DESCRIPTION="A dynamic, open source programming language with a focus on simplicity and productivity. It has an elegant syntax that is natural to read and easy to write."
export CATEGORY=development
export TYPE=application
#export VERSION=1.8.5
#export VERSIONDATE=20121014
#export VERSION=1.8.7
#export VERSIONDATE=20121014
#export VERSION=1.8.7-p371
#export VERSIONDATE=20121015
#export VERSION=1.9.3-p194
#export VERSIONDATE=20120625
#export VERSION=1.9.3-p286 
#export VERSIONDATE=20121014
#export VERSION=2.0.0-preview1
#export VERSIONDATE=20121102
#export VERSION=2.0.0-p247
#export VERSIONDATE=20130710
#export VERSION=2.1.0
#export VERSIONDATE=20131225
#export VERSION=2.1.1
#export VERSIONDATE=20140224
#export VERSION=2.1.2
#export VERSIONDATE=20140509
#export VERSION=2.1.3
#export VERSIONDATE=20140919
#export VERSION=2.1.4
#export VERSIONDATE=20141027
#export VERSION=2.1.5
#export VERSIONDATE=20141113
#export VERSION=2.2.1
#export VERSIONDATE=20150304
####i386-mingw32-fake.rb:28:in `read': No such file or directory @ rb_sysopen - /home/win32/ruby-2.2.1/tool/fake.rb (Errno::ENOENT)
#export VERSION=2.2.2
#export VERSIONDATE=20150413
#export VERSION=2.2.3
#export VERSIONDATE=20150819
#export VERSION=2.2.4
#export VERSIONDATE=20151218
#export VERSION=2.3.0
#export VERSIONDATE=20160406
#export VERSION=2.3.1
#export VERSIONDATE=20160426
#export VERSION=2.3.2
#export VERSIONDATE=20161115
#export VERSION=2.3.3
#export VERSIONDATE=20161121
####win32ole.c:1452:17: warning: implicit declaration of function 'V_RECORDINFO' [-Wimplicit-function-declaration]
#export VERSION=2.3.4
#export VERSIONDATE=20170330
####win32/win32.c:7577:28: error: expected ',' or ';' before '_gmtime64_s'
####This application has requested the Runtime to terminate it in an unusual way.
#export VERSION=2.3.5
#export VERSIONDATE=20170914
#export VERSION=2.3.6
#export VERSIONDATE=20171515
#export VERSION=2.3.7
#export VERSIONDATE=20180329
#export VERSION=2.3.8
#export VERSIONDATE=20181018
#export VERSION=2.4.5
#export VERSIONDATE=20181018
#export VERSION=2.4.7
#export VERSIONDATE=20190828
#export VERSION=2.4.8
#export VERSIONDATE=20191001
#export VERSION=2.4.9
#export VERSIONDATE=20191002
#export VERSION=2.4.10
#export VERSIONDATE=20200331
#export VERSION=2.5.1
#export VERSIONDATE=20181015
#export VERSION=2.5.2
#export VERSIONDATE=20181018
#export VERSION=2.5.3
#export VERSIONDATE=20181018
#export VERSION=2.5.4
#export VERSIONDATE=20190313
#export VERSION=2.5.5
#export VERSIONDATE=20190315
#export VERSION=2.5.6
#export VERSIONDATE=20190827
#export VERSION=2.5.7
#export VERSIONDATE=20191001
#export VERSION=2.5.8
#export VERSIONDATE=20200331
#export VERSION=2.5.9
#export VERSIONDATE=20210406
#export VERSION=2.6.0
#export VERSIONDATE=20181226
#export VERSION=2.6.1
#export VERSIONDATE=20190130
#export VERSION=2.6.2
#export VERSIONDATE=20190313
#export VERSION=2.6.3
#export VERSIONDATE=20190418
#export VERSION=2.6.4
#export VERSIONDATE=20190828
#export VERSION=2.6.5
#export VERSIONDATE=20191001
#export VERSION=2.6.6
#export VERSIONDATE=20200331
#export VERSION=2.6.7
#export VERSIONDATE=20210406
#export VERSION=2.6.8
#export VERSIONDATE=20210707
#export VERSION=2.6.9
#export VERSIONDATE=20201225
#export VERSION=2.7.0
#export VERSIONDATE=20191225
#export VERSION=2.7.1
#export VERSIONDATE=20200331
#export VERSION=2.7.2
#export VERSIONDATE=20201003
#export VERSION=2.7.3
#export VERSIONDATE=20210406
#export VERSION=2.7.4
#export VERSIONDATE=20210707
#export VERSION=3.0.0
#export VERSIONDATE=20201225
#export VERSION=3.0.1
#export VERSIONDATE=20210406
#export VERSION=3.0.2
#export VERSIONDATE=20210707
#export VERSION=3.0.3
#export VERSIONDATE=20211124
#export VERSION=3.1.0
#export VERSIONDATE=20211225
#export VERSION=3.1.1
#export VERSIONDATE=20220218
#export VERSION=3.1.2
#export VERSIONDATE=20220412
#export VERSION=3.1.3
#export VERSIONDATE=20221124
export VERSION=3.2.0
export VERSIONDATE=20221225
####when building against UCRT: win32/win32.c:2479:35: error: 'FILE' {aka 'struct _iobuf'} has no member named '_file'
wl-showstatus --package-version
#export DEPENDANCIES=libffi,openssl,gdbm,qdbm,zlib,pdcurses,readline,libyaml,tcl,tk
export DEPENDANCIES=libffi,openssl,gdbm,qdbm,zlib,readline,libyaml,tcl,tk
export OPTIONALDEPENDANCIES=
export BUILDDEPENDANCIES=
export LICENSEFILE=COPYING
export LICENSETYPE="2-clause BSDL"
#export DOWNLOADURL="http://www.ruby-lang.org/en/downloads/"
#export DOWNLOADURL="http://ftp.ruby-lang.org/pub/ruby/"
#export DOWNLOADURL="http://ftp.ruby-lang.org/pub/ruby/stable/"
export DOWNLOADURL="https://cache.ruby-lang.org/pub/ruby/"
export INSTALLPREFIX=`pwd`/inst_$BASENAME-$VERSION
#export DOWNLOADSOURCEURL=http://ftp.ruby-lang.org/pub/ruby/`echo $VERSION|sed -e "s/^\([0-9]*\.[0-9]*\)\..*/\1/"`/$BASENAME-$VERSION.tar.gz
#export DOWNLOADSOURCEURL=http://ftp.ruby-lang.org/pub/ruby/`echo $VERSION|sed -e "s/^\([0-9]*\.[0-9]*\)\..*/\1/"`/$BASENAME-$VERSION.tar.bz2
#export DOWNLOADSOURCEURL=http://ftp.ruby-lang.org/pub/ruby/stable/$BASENAME-$VERSION.tar.bz2
export DOWNLOADSOURCEURL=https://cache.ruby-lang.org/pub/ruby/$(echo $VERSION|sed -e "s/^\([0-9]*\.[0-9]*\)\..*/\1/")/$BASENAME-$VERSION.tar.xz
wl-showstatus download
wl-download -v -d $TARBALLDIR/$BASENAME $DOWNLOADSOURCEURL
wl-wait4deps
#tar xfz $TARBALLDIR/$BASENAME/$BASENAME-$VERSION.tar.gz
#tar xfj $TARBALLDIR/$BASENAME/$BASENAME-$VERSION.tar.bz2
tar xfJ $TARBALLDIR/$BASENAME/$BASENAME-$VERSION.tar.xz
cd $BASENAME-$VERSION
## fix missing const in win32/win32.h (version <= 1.8.7)
#patch -ulbf win32/win32.h << EOF
#--- win32/win32.h  2008-04-15 05:35:56 +0200
#+++ win32/win32.h  2012-10-14 10:53:02 +0200
#@@ -161,3 +161,3 @@
# extern int    rb_w32_cmdvector(const char *, char ***);
#-extern rb_pid_t pipe_exec(char *, int, FILE **, FILE **);
#+extern rb_pid_t pipe_exec(const char *, int, FILE **, FILE **);
# extern int    flock(int fd, int oper);
#EOF
## fix missing const in win32/win32.c (version <= 1.8.7)
#patch -ulbf win32/win32.c << EOF
#--- win32/win32.c  2008-05-18 17:02:36 +0200
#+++ win32/win32.c  2012-10-14 10:53:00 +0200
#@@ -667,3 +667,3 @@
# rb_pid_t
#-pipe_exec(char *cmd, int mode, FILE **fpr, FILE **fpw)
#+pipe_exec(const char *cmd, int mode, FILE **fpr, FILE **fpw)
# {
#EOF
## fix math.c (version <= 1.8.7)
#patch -ulbf math.c << EOF
#--- math.c  2008-01-25 14:34:14 +0100
#+++ math.c  2012-10-14 10:55:54 +0200
#@@ -36,3 +36,3 @@
#            errno = EDOM;
#-#elif define(ERANGE)
#+#elif defined(ERANGE)
#            errno = ERANGE;
#EOF
## fix redefinition of NET_LUID in win32/win32.c (version >= 2.1.5)
#mv win32/win32.c win32/win32.c.bak
#echo "#define HAVE_TYPE_NET_LUID 1" > win32/win32.c
#cat win32/win32.c.bak >> win32/win32.c
# fix DLL extension in configure
patch -ulbf configure << EOF
--- configure  2013-06-27 13:16:18 +0200
+++ configure  2013-07-10 16:51:32 +0200
@@ -17832,7 +17832,7 @@
   cygwin*|mingw*|*djgpp*) :

        LOAD_RELATIVE=1
-       DLEXT=so ;; #(
+       DLEXT=dll ;; #(
   *) :

        DLEXT=so ;;
EOF
## fix redefinition of struct timespec in include/ruby/missing.h (version >= 2.2.2)
#mv include/ruby/missing.h include/ruby/missing.h.bak
#echo "#define HAVE_STRUCT_TIMESPEC" > include/ruby/missing.h
#cat include/ruby/missing.h.bak >> include/ruby/missing.h
# fix missing SSLV23_PADDING in ext/openssl/ossl_pkey_rsa.c (version >= 3.0.2)
patch -ulbf ext/openssl/ossl_pkey_rsa.c << EOF
@@ -949,3 +949,5 @@
     DefRSAConst(PKCS1_PADDING);
+#ifdef RSA_SSLV23_PADDING
     DefRSAConst(SSLV23_PADDING);
+#endif
     DefRSAConst(NO_PADDING);
EOF
# fix redefinition of TS_VERIFY_CTS_set_certs in ext/openssl/openssl_missing.h (version >= 3.0.2)
patch -ulbf ext/openssl/openssl_missing.h << EOF
@@ -237,3 +237,3 @@

-#if !defined(HAVE_TS_VERIFY_CTS_SET_CERTS)
+#if !defined(HAVE_TS_VERIFY_CTS_SET_CERTS) && !defined(TS_VERIFY_CTS_set_certs)
 #  define TS_VERIFY_CTS_set_certs(ctx, crts) ((ctx)->certs=(crts))
EOF
# fix conflicting types for NET_LUID on MinGW-W64
if echo -e "#include<_mingw.h>\nint v=__MINGW64_VERSION_MAJOR;" | ${CC:-gcc} -c -xc - -o /dev/null &> /dev/null; then
 sed -i.bak -e "s/iphlpapi\.h/ifdef.h/" configure
fi
## determine Windows installation path
#mkdir -p $INSTALLPREFIX
#pushd $INSTALLPREFIX > /dev/null
#INSTALLPREFIXWIN=$(pwd -W)
#popd > /dev/null
wl-showstatus configure &&
 #./configure --prefix=$INSTALLPREFIXWIN --build=$BUILDPLATFORM --host=$RUNPLATFORM --enable-shared --enable-load-relative &&
 #./configure --prefix=$INSTALLPREFIXWIN --build=$BUILDPLATFORM --host=$RUNPLATFORM --enable-shared --enable-load-relative LIBS="-Wl,--as-needed -lssp" &&
 #./configure --prefix=$INSTALLPREFIXWIN --build=$BUILDPLATFORM --host=$RUNPLATFORM --enable-shared --enable-load-relative CFLAGS="-fcommon" LIBS="-Wl,--as-needed -lssp" &&
 #./configure --prefix=$(cygpath -m $INSTALLPREFIX) --build=$BUILDPLATFORM --host=$RUNPLATFORM --enable-shared --enable-load-relative CFLAGS="-fcommon" LIBS="-Wl,--as-needed -lssp" &&
 PKG_CONFIG=$(which pkg-config.exe) ./configure --prefix=$(cygpath -m $INSTALLPREFIX) --build=$BUILDPLATFORM --host=$RUNPLATFORM --enable-shared --enable-load-relative CFLAGS="-fcommon" LIBS="-Wl,--as-needed -lssp" &&
 #wl-showstatus build &&
 #make -j1 &&
 #wl-showstatus build-install &&
 #make -j1 install &&
 #make &&
 #wl-showstatus build-install &&
 #make miniruby all install &&
 wl-showstatus build &&
 make miniruby all &&
 wl-showstatus build-install &&
 ( make install || make install optflags="-O3" || make install DOCTARGETS=nodoc || (
  # fix read error (version >= 2.2.1)
  FAKEFILE=$(ls -1 *mingw*.rb|head -n1)
  mv $FAKEFILE $FAKEFILE.bak &&
  sed -e "s/^\(eval.*fake.*\)$/#\1/" $FAKEFILE.bak > $FAKEFILE &&
  cat tool/fake.rb >> $FAKEFILE &&
  make install
 ) || make install DOCTARGETS=nodoc ) &&
 find $INSTALLPREFIX -iname \*.exe -or -iname \*.dll -exec strip {} \; &&
 wl-makepackage -c -d && wl-install -d $BASENAME-$VERSION && cd .. && wl-showstatus cleanup && rm -rf $BASENAME-$VERSION
#../inst_ruby-2.0.0-preview1/bin/ruby -e 'puts "Test"'
#ruby -e 'puts "Test"'
####gc.c:1961: undefined reference to `___sync_or_and_fetch_4'
#make clean; make CFLAGS="-march=i686" CXXFLAGS="-march=i686" && echo OK



