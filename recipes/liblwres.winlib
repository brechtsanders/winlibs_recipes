export NAME="liblwres"
export STATUS=
export URL=http://www.isc.org/downloadables/11
export BASENAME=liblwres
export DESCRIPTION="Lightweight Resolver Library used by BIND"
export CATEGORY=communication
export TYPE=library
#export VERSION=9.5.2
#export VERSION=9.6.3
#export VERSIONDATE=20110205
#export VERSION=9.7.2-P2
#export VERSIONDATE=
#export VERSION=9.7.3
#export VERSIONDATE=20110215
#export VERSION=9.7.4
#export VERSIONDATE=20110802
#export VERSION=9.7.5
#export VERSIONDATE=20120405
#export VERSION=9.7.7
#export VERSIONDATE=20121010
#export VERSION=9.8.0
#export VERSIONDATE=20110302
#export VERSION=9.8.1
#export VERSIONDATE=20110901
#export VERSION=9.8.2
#export VERSIONDATE=20120405
#export VERSION=9.8.3
#export VERSIONDATE=20120522
#export VERSION=9.8.4
#export VERSIONDATE=20121010
#export VERSION=9.8.5
#export VERSIONDATE=20130529
#export VERSION=9.8.6
#export VERSIONDATE=20130920
#export VERSION=9.8.7
#export VERSIONDATE=20140131
#export VERSION=9.8.8
#export VERSIONDATE=20140924
#export VERSION=9.9.0
#export VERSIONDATE=20120301
#export VERSION=9.9.1
#export VERSIONDATE=20120522
####checking type of rlim_cur... configure: error: unable to determine sizeof rlim_cur
#export VERSION=9.9.2
#export VERSIONDATE=20121010
#export VERSION=9.9.3
#export VERSIONDATE=20130529
#export VERSION=9.9.4
#export VERSIONDATE=20130920
#export VERSION=9.9.5
#export VERSIONDATE=20140131
#export VERSION=9.9.6
#export VERSIONDATE=20140924
#export VERSION=9.9.7
#export VERSIONDATE=20150226
#export VERSION=9.9.8
#export VERSIONDATE=20150916
#export VERSION=9.9.9
#export VERSIONDATE=20160429
#export VERSION=9.9.10
#export VERSIONDATE=20170420
#export VERSION=9.9.11
#export VERSIONDATE=20170814
#export VERSION=9.9.12
#export VERSIONDATE=20170815
#export VERSION=9.9.13
#export VERSIONDATE=20180711
export VERSION=9.10.0
export VERSIONDATE=20140501
#export VERSION=9.10.1
#export VERSIONDATE=20140924
#export VERSION=9.10.2
#export VERSIONDATE=20150226
#export VERSION=9.10.3
#export VERSIONDATE=20150916
#export VERSION=9.10.4
#export VERSIONDATE=20160429
#export VERSION=9.10.5
#export VERSIONDATE=20170420
#export VERSION=9.10.6
#export VERSIONDATE=20170814
#export VERSION=9.10.7
#export VERSIONDATE=20170815
#export VERSION=9.10.8
#export VERSIONDATE=20180711
#export VERSION=9.11.0
#export VERSIONDATE=20161005
####lib/isc/unix/app.c:952:2: error: unknown type name 'sigset_t'
#export VERSION=9.11.1
#export VERSIONDATE=20170420
#export VERSION=9.11.2
#export VERSIONDATE=20170814
#export VERSION=9.11.4
#export VERSIONDATE=20180711
#export VERSION=9.11.5
#export VERSIONDATE=20181019
#export VERSION=9.11.6
#export VERSIONDATE=20190301
#export VERSION=9.11.7
#export VERSIONDATE=20190516
#export VERSION=9.11.8
#export VERSIONDATE=20190620
#export VERSION=9.11.9
#export VERSIONDATE=20190718
#export VERSION=9.11.10
#export VERSIONDATE=20190822
#export VERSION=9.11.11
#export VERSIONDATE=20190919
#export VERSION=9.11.12
#export VERSIONDATE=20191017
#export VERSION=9.11.13
#export VERSIONDATE=20191121
#export VERSION=9.11.14
#export VERSIONDATE=20191219
#export VERSION=9.11.16
#export VERSIONDATE=20200220
#export VERSION=9.11.17
#export VERSIONDATE=20200318
#export VERSION=9.11.18
#export VERSIONDATE=20200416
#export VERSION=9.11.19
#export VERSIONDATE=20200519
#export VERSION=9.11.20
#export VERSIONDATE=20200618
#export VERSION=9.11.21
#export VERSIONDATE=20200708
#export VERSION=9.11.22
#export VERSIONDATE=20200821
#export VERSION=9.11.23
#export VERSIONDATE=20200917
#export VERSION=9.11.24
#export VERSIONDATE=20201022
#export VERSION=9.11.25
#export VERSIONDATE=20201026
#export VERSION=9.11.26
#export VERSIONDATE=20201217
#export VERSION=9.11.27
#export VERSIONDATE=20210121
#export VERSION=9.11.28
#export VERSIONDATE=20210218
#export VERSION=9.11.29
#export VERSIONDATE=20210318
#export VERSION=9.11.31
#export VERSIONDATE=20210429
#export VERSION=9.12.0
#export VERSIONDATE=20180124
#export VERSION=9.12.1
#export VERSIONDATE=20180315
#export VERSION=9.12.2
#export VERSIONDATE=20180711
#export VERSION=9.12.3
#export VERSIONDATE=20181019
#export VERSION=9.12.4
#export VERSIONDATE=20190301
#export VERSION=9.13.0
#export VERSIONDATE=20180526
#export VERSION=9.13.1
#export VERSIONDATE=20180615
#export VERSION=9.13.2
#export VERSIONDATE=20180711
#export VERSION=9.13.3
#export VERSIONDATE=20180920
####lib/isc/unix/app.c:289:25: error: 'SIGPIPE' undeclared (first use in this function)
#export VERSION=9.13.4
#export VERSIONDATE=20181122
#export VERSION=9.13.5
#export VERSIONDATE=20181213
#export VERSION=9.13.6
#export VERSIONDATE=20190208
#export VERSION=9.13.7
#export VERSIONDATE=20190222
#export VERSION=9.14.0
#export VERSIONDATE=20190322
#export VERSION=9.14.1
#export VERSIONDATE=20190425
#export VERSION=9.14.2
#export VERSIONDATE=20190516
#export VERSION=9.14.3
#export VERSIONDATE=20190620
#export VERSION=9.14.4
#export VERSIONDATE=20190718
#export VERSION=9.14.5
#export VERSIONDATE=20190822
#export VERSION=9.14.6
#export VERSIONDATE=20190919
#export VERSION=9.14.7
#export VERSIONDATE=20191017
#export VERSION=9.14.8
#export VERSIONDATE=20191121
#export VERSION=9.14.9
#export VERSIONDATE=20191219
#export VERSION=9.14.11
#export VERSIONDATE=20200220
#export VERSION=9.14.12
#export VERSIONDATE=20200519
#export VERSION=9.15.0
#export VERSIONDATE=20190516
#export VERSION=9.15.1
#export VERSIONDATE=20190620
#export VERSION=9.15.2
#export VERSIONDATE=20190718
#export VERSION=9.15.3
#export VERSIONDATE=20190822
####checking python module 'ply'... configure: error: not found
#export VERSION=9.15.4
#export VERSIONDATE=20190919
#export VERSION=9.15.5
#export VERSIONDATE=20191017
#export VERSION=9.15.6
#export VERSIONDATE=20191121
#export VERSION=9.15.7
#export VERSIONDATE=20191219
#export VERSION=9.15.8
#export VERSIONDATE=20200123
#export VERSION=9.16.0
#export VERSIONDATE=20200220
#export VERSION=9.16.1
#export VERSIONDATE=20200318
#export VERSION=9.16.2
#export VERSIONDATE=20200416
#export VERSION=9.16.3
#export VERSIONDATE=20200519
#export VERSION=9.16.4
#export VERSIONDATE=20200618
#export VERSION=9.16.5
#export VERSIONDATE=20200708
#export VERSION=9.16.6
#export VERSIONDATE=20200821
#export VERSION=9.16.7
#export VERSIONDATE=20200917
#export VERSION=9.16.8
#export VERSIONDATE=20201022
#export VERSION=9.16.9
#export VERSIONDATE=20201026
#export VERSION=9.16.10
#export VERSIONDATE=20201217
#export VERSION=9.16.11
#export VERSIONDATE=20210121
#export VERSION=9.16.12
#export VERSIONDATE=20210218
#export VERSION=9.16.13
#export VERSIONDATE=20210318
#export VERSION=9.16.15
#export VERSIONDATE=20210429
#export VERSION=9.17.0
#export VERSIONDATE=20200318
#export VERSION=9.17.1
#export VERSIONDATE=20200416
#export VERSION=9.17.2
#export VERSIONDATE=20200618
#export VERSION=9.17.3
#export VERSIONDATE=20200708
#export VERSION=9.17.4
#export VERSIONDATE=20200821
#export VERSION=9.17.5
#export VERSIONDATE=20200917
#export VERSION=9.17.6
#export VERSIONDATE=20201022
#export VERSION=9.17.7
#export VERSIONDATE=20201026
#export VERSION=9.17.8
#export VERSIONDATE=20201217
#export VERSION=9.17.9
#export VERSIONDATE=20210121
#export VERSION=9.17.10
#export VERSIONDATE=20210218
#export VERSION=9.17.11
#export VERSIONDATE=20210318
#export VERSION=9.17.12
#export VERSIONDATE=20210429
#export VERSION=9.17.13
#export VERSIONDATE=20210520
#export VERSION=9.17.14
#export VERSIONDATE=20210617
#export VERSION=9.17.15
#export VERSIONDATE=20210618
#export VERSION=9.17.16
#export VERSIONDATE=20210722
#export VERSION=9.17.17
#export VERSIONDATE=20210819
#export VERSION=9.17.18
#export VERSIONDATE=20210915
#export VERSION=9.17.19
#export VERSIONDATE=20211028
#export VERSION=9.17.20
#export VERSIONDATE=20211118
#export VERSION=9.17.21
#export VERSIONDATE=20211215
#export VERSION=9.17.22
#export VERSIONDATE=20220122
#export VERSION=9.18.0
#export VERSIONDATE=20220126
#export VERSION=9.18.1
#export VERSIONDATE=20220317
#export VERSION=9.18.2
#export VERSIONDATE=20220420
#export VERSION=9.19.0
#export VERSIONDATE=20220420
#export VERSION=9.19.1
#export VERSIONDATE=20220519
#export VERSION=9.19.2
#export VERSIONDATE=20220615
#export VERSION=9.19.3
#export VERSIONDATE=20220721
#export VERSION=9.19.4
#export VERSIONDATE=20220818
#export VERSION=9.19.5
#export VERSIONDATE=20220921
#export VERSION=9.19.6
#export VERSIONDATE=20221019
#export VERSION=9.19.7
#export VERSIONDATE=20221116
#export VERSION=9.19.8
#export VERSIONDATE=20221221
#export VERSION=9.19.9
#export VERSIONDATE=20230125
#export VERSION=9.19.10
#export VERSIONDATE=20230216
#export VERSION=9.19.11
#export VERSIONDATE=20230316
#export VERSION=9.19.12
#export VERSIONDATE=20230418
#export VERSION=9.19.13
#export VERSIONDATE=20230517
#export VERSION=9.19.14
#export VERSIONDATE=20230622
#export VERSION=9.19.15
#export VERSIONDATE=20230719
#export VERSION=9.19.16
#export VERSIONDATE=20230816
#export VERSION=9.19.17
#export VERSIONDATE=20230920
####configure: error: IPv6 support is mandatory
wl-showstatus --package-version
export DEPENDENCIES=openssl
export OPTIONALDEPENDENCIES=
export BUILDDEPENDENCIES=
export OPTIONALBUILDDEPENDENCIES=
export LICENSEFILE=COPYRIGHT
export LICENSETYPE=
#export DOWNLOADURL="http://www.isc.org/downloadables/11"
#export DOWNLOADURL="http://ftp.isc.org/isc/bind9/ bind-"
export DOWNLOADURL="https://ftp.isc.org/isc/bind/ bind-"
#export DOWNLOADURL="https://gitlab.isc.org/isc-projects/bind9/-/tags"
export INSTALLPREFIX=`pwd`/inst_$BASENAME-$VERSION
export DOWNLOADSOURCEURL=http://ftp.isc.org/isc/bind9/$VERSION/bind-$VERSION.tar.gz
#export DOWNLOADSOURCEURL=http://ftp.isc.org/isc/bind9/$VERSION/bind-$VERSION.tar.xz
#export DOWNLOADSOURCEURL=https://ftp.isc.org/isc/bind9/$VERSION/bind-$VERSION.tar.xz
wl-showstatus download
wl-download -v -d $TARBALLDIR/$BASENAME $DOWNLOADSOURCEURL
wl-wait4deps
tar xz --force-local -f $TARBALLDIR/$BASENAME/bind-$VERSION.tar.gz
#tar xJ --force-local -f $TARBALLDIR/$BASENAME/bind-$VERSION.tar.xz
cd bind-$VERSION
# fix missing files
mkdir -p winfix/sys winfix/netinet winfix/arpa winfix/net
echo "struct rlimit { int rlim_cur; };" > winfix/sys/resource.h
echo "#include <winsock2.h>" > winfix/sys/socket.h
echo "#include <ws2tcpip.h>" >> winfix/sys/socket.h
touch winfix/sys/ioctl.h winfix/sys/un.h winfix/netinet/in.h winfix/arpa/inet.h winfix/net/if.h
# fix configure
patch -ulbf configure << EOF
--- configure  Thu Aug 13 04:02:46 2009
+++ configure  Fri Oct 16 16:54:34 2009
@@ -21818,4 +21818,5 @@
 #include <sys/types.h> /* Ultrix */
 #include <unistd.h>
+#include <winsock2.h>
 int
 main ()
EOF
# fix lib/lwres/context.c
patch -ulbf lib/lwres/context.c << EOF
--- lib/lwres/context.c  2009-09-03 01:48:04 +0200
+++ lib/lwres/context.c  2011-09-01 08:20:08 +0200
@@ -120,2 +120,3 @@
 #ifndef MAKE_NONBLOCKING
+#ifndef _WIN32
 #define MAKE_NONBLOCKING(sd, retval) \\
@@ -128,6 +129,13 @@
 } while (0)
+#else
+#define MAKE_NONBLOCKING(sd, retval) \\
+{ \\
+       unsigned long flags = 1; \\
+       ioctlsocket (sd, FIONBIO, &flags); \\
+}
+#endif
 #endif

-LIBLWRES_EXTERNAL_DATA lwres_uint16_t lwres_udp_port = LWRES_UDP_PORT;
-LIBLWRES_EXTERNAL_DATA const char *lwres_resolv_conf = LWRES_RESOLV_CONF;
+lwres_uint16_t lwres_udp_port = LWRES_UDP_PORT;
+const char *lwres_resolv_conf = LWRES_RESOLV_CONF;

EOF
## fix lib/lwres/context.c (version >= 9.9.5)
#patch -ulbf lib/lwres/context.c << EOF
#--- lib/lwres/context.c  2014-01-27 19:58:24 +0100
#+++ lib/lwres/context.c  2014-01-31 15:24:56 +0100
#@@ -184,3 +184,3 @@
#        ctx->timeout = LWRES_DEFAULT_TIMEOUT;
#-#ifndef WIN32
#+#if !defined(WIN32) || defined(__MINGW32__)
#        ctx->serial = time(NULL); /* XXXMLG or BEW */
#EOF
# fix missing _time32 in lib/lwres/context.c (version >= 9.10.0)
patch -ulbf lib/lwres/context.c << EOF
--- lib/lwres/context.c  2014-05-01 08:17:42 +0200
+++ lib/lwres/context.c  2014-05-01 08:40:24 +0200
@@ -191,3 +191,3 @@
        ctx->timeout = LWRES_DEFAULT_TIMEOUT;
-#ifndef WIN32
+#if !defined(WIN32) || defined(__MINGW32__)
        ctx->serial = time(NULL); /* XXXMLG or BEW */
EOF
# fix wrong dllimport in lib/lwres/getipnode.c
mv lib/lwres/getipnode.c lib/lwres/getipnode.c.bak
sed -e "s/^LIBLWRES_EXTERNAL_DATA //" lib/lwres/getipnode.c.bak > lib/lwres/getipnode.c
# fix missing LWRES_PLATFORM_QUADFORMAT in lib/lwres/print.c
mv lib/lwres/print.c lib/lwres/print.c.bak
echo "#define LWRES_PLATFORM_QUADFORMAT \"ll\"" > lib/lwres/print.c
cat lib/lwres/print.c.bak >> lib/lwres/print.c
## fix platform
#cp -rf lib/lwres/win32/* lib/lwres/unix/
# fix building of win32 instead of unix in lib/lwres/Makefile.in
patch -ulbf lib/lwres/Makefile.in << EOF
--- lib/lwres/Makefile.in  2012-09-27 02:35:20 +0200
+++ lib/lwres/Makefile.in  2012-10-10 14:10:18 +0200
@@ -26,5 +26,5 @@
 @BIND9_MAKE_INCLUDES@

-CINCLUDES =    -I\${srcdir}/unix/include \\
+CINCLUDES =    -I\${srcdir}/win32/include \\
                -I. -I./include -I\${srcdir}/include \${ISC_INCLUDES}
 CDEFINES =
@@ -37,5 +37,5 @@
                lwres_gabn.@O@ lwres_gnba.@O@ lwres_grbn.@O@ lwres_noop.@O@ \\
                lwinetaton.@O@ lwinetpton.@O@ lwinetntop.@O@ print.@O@ \\
-               strtoul.@O@
+`printf "\\t"`strtoul.@O@ win32/socket.@O@

 # Alphabetically
@@ -45,9 +45,9 @@
                lwres_gabn.c lwres_gnba.c lwres_grbn.c lwres_noop.c \\
                lwinetaton.c lwinetpton.c lwinetntop.c print.c \\
-               strtoul.c
+`printf "\\t"`strtoul.c win32/socket.c

 LIBS =         @LIBS@

-SUBDIRS =      include man unix
+SUBDIRS =      include man win32
 TARGETS =      timestamp

@@ -62,4 +62,7 @@
                -c \${srcdir}/version.c

+win32/socket.o: win32/socket.c
+`printf "\\t"`\${LIBTOOL_MODE_COMPILE} \${CC} \${ALL_CFLAGS} -o \$@ -c \$<
+
 liblwres.@SA@: \${OBJS} version.@O@
        \${AR} \${ARFLAGS} \$@ \${OBJS} version.@O@
EOF
# fix excessive EXPORTS line in lib/lwres/win32/liblwres.def
mv lib/lwres/win32/liblwres.def lib/lwres/win32/liblwres.def.bak
sed -e "6,9999s/EXPORTS//" lib/lwres/win32/liblwres.def.bak > lib/lwres/win32/liblwres.def
# fix missing uintptr_t in lib/lwres/gethost.c (version >= 9.9.5)
mv lib/lwres/gethost.c lib/lwres/gethost.c.bak
echo "#include <stdint.h>" > lib/lwres/gethost.c
cat lib/lwres/gethost.c.bak >> lib/lwres/gethost.c
# fix missing lib/lwres/unix/Makefile (version >= 9.10.1)
cat > lib/lwres/unix/Makefile << EOF
clean:
all:
install:
install-strip:
EOF
## fix building DLLs on 64-bit
#if ( echo $RUNPLATFORM | grep -q x86_64 ); then
# autoreconf -f -i -I $MINGWPREFIX/share/aclocal
#fi
# fix building of win32 instead of unix in configure
sed -i.bak -e "s?lib/lwres/unix?lib/lwres/win32?g" configure
# fix OpenSSL 3 issue detecting dynamic loading (version >= 9.10.0)
sed -i.bak2 -e "s/as_fn_error\(.*OpenSSL has unsupported dynamic loading\)/echo\1/" configure
wl-showstatus configure &&
 #./configure --prefix=$INSTALLPREFIX --build=$BUILDPLATFORM --host=$RUNPLATFORM --without-openssl --with-make-clean=no CFLAGS="-I`pwd`/winfix" LDFLAGS="-no-undefined -Wl,-no-undefined" &&
 #./configure --prefix=$INSTALLPREFIX --build=$BUILDPLATFORM --host=$RUNPLATFORM --with-openssl=$MINGWPREFIX --with-make-clean=no CFLAGS="-I`pwd`/winfix" LDFLAGS="-no-undefined -Wl,-no-undefined" &&
 #./configure --prefix=$INSTALLPREFIX --build=$BUILDPLATFORM --host=$RUNPLATFORM --with-openssl=$MINGWPREFIX --with-make-clean=no CFLAGS="-I`pwd`/winfix" LDFLAGS="-Wl,-no-undefined" &&
 ./configure --prefix=$INSTALLPREFIX --build=$BUILDPLATFORM --host=$RUNPLATFORM --with-openssl=$MINGWPREFIX --with-make-clean=no CFLAGS="-DLIBLWRES_EXPORTS -I`pwd`/winfix" LDFLAGS="-Wl,-no-undefined" &&
 #./configure --prefix=$INSTALLPREFIX --build=$BUILDPLATFORM --host=$RUNPLATFORM --with-openssl=$MINGWPREFIX --with-make-clean=no --with-python=$PYDIR/python.exe CFLAGS="-DLIBLWRES_EXPORTS -I`pwd`/winfix" LDFLAGS="-Wl,-no-undefined" &&
 #./configure --prefix=$INSTALLPREFIX --build=$BUILDPLATFORM --host=$RUNPLATFORM --with-openssl=$MINGWPREFIX --without-python CFLAGS="-DLIBLWRES_EXPORTS -I`pwd`/winfix" LDFLAGS="-Wl,-no-undefined" &&
 # avoid using soft links
 sed -i.bak -e "s/\(\s\)ln /\1cp -f /" bin/named/Makefile &&
 sed -i.bak -e "s/\(\s\)ln /\1cp -f /" lib/lwres/man/Makefile &&
 ## fix building DLLs
 #sed -i.bak -e "s/\(allow_undefined=\)yes/\1no/" libtool &&
 wl-showstatus build-install &&
 make -C lib/lwres install &&
 # manually create and install shared library
 mkdir -p $INSTALLPREFIX/bin &&
 #dlltool -D lwres.dll -l $INSTALLPREFIX/lib/liblwres.dll.a -d lib/lwres/win32/liblwres.def $INSTALLPREFIX/lib/liblwres.a &&
 #gcc -shared -s -mwindows -def lib/lwres/win32/liblwres.def -o $INSTALLPREFIX/bin/liblwres.dll $INSTALLPREFIX/lib/liblwres.a -lws2_32 &&
 ${CC:-gcc} -shared -s -mwindows -def lib/lwres/win32/liblwres.def -o $INSTALLPREFIX/bin/liblwres.dll -Wl,--out-implib,$INSTALLPREFIX/lib/liblwres.a $INSTALLPREFIX/lib/liblwres.a -lws2_32 &&
 wl-makepackage -c -d && wl-install -d $BASENAME-$VERSION && cd .. && wl-showstatus cleanup && rm -rf bind-$VERSION
####TO DO: build lib/isc/win32 instead of lib/isc/unix



