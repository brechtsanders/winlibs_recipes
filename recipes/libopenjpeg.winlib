export NAME="libopenjpeg"
export STATUS=
export URL=http://www.openjpeg.org/
export BASENAME=libopenjpeg
export DESCRIPTION="The OpenJPEG library is an open-source JPEG 2000 codec written in C language."
export CATEGORY=graphics
export TYPE=library
#export VERSION=1.3
#export DEPENDENCIES=libucommon
#export VERSION=1.5.0
#export VERSIONDATE=20120303
#export VERSION=1.5.1
#export VERSIONDATE=20120913
#export VERSION=2.0.0
#export VERSIONDATE=20121119
#export VERSION=2.1.0
#export VERSIONDATE=20141122
#export VERSION=2.1.2
#export VERSIONDATE=20170109
#export VERSION=2.2.0
#export VERSIONDATE=20170815
#export VERSION=2.3.0
#export VERSIONDATE=20171005
#export VERSION=2.3.1
#export VERSIONDATE=20190402
#export VERSION=2.4.0
#export VERSIONDATE=20201229
#export VERSION=2.5.0
#export VERSIONDATE=20220514
#export VERSION=2.5.1
#export VERSIONDATE=20240227
#export VERSION=2.5.2
#export VERSIONDATE=20240228
#export VERSION=2.5.3
#export VERSIONDATE=20241210
export VERSION=2.5.4
export VERSIONDATE=20250921
wl-showstatus --package-version
export DEPENDENCIES=zlib,libpng,libtiff,lcms2
export OPTIONALDEPENDENCIES=
#export BUILDDEPENDENCIES=cmake,pexports
#export OPTIONALBUILDDEPENDENCIES=
#export BUILDDEPENDENCIES=cmake
#export OPTIONALBUILDDEPENDENCIES=
export BUILDDEPENDENCIES=cmake,ninja
export OPTIONALBUILDDEPENDENCIES=
#export LICENSEFILE=license.txt
export LICENSEFILE=LICENSE
export LICENSETYPE=
#export DOWNLOADURL="http://www.openjpeg.org/index.php?menu=download openjpeg_v"
#export DOWNLOADURL="http://code.google.com/p/openjpeg/downloads/list openjpeg-"
#export DOWNLOADURL="http://sourceforge.net/projects/openjpeg.mirror/files/ openjpeg-"
export DOWNLOADURL="https://github.com/uclouvain/openjpeg/releases"
export INSTALLPREFIX=`pwd`/inst_$BASENAME-$VERSION
#export DOWNLOADSOURCEURL=http://www.openjpeg.org/openjpeg_v`echo $VERSION|sed -e "s/\./_/g"`_win32.zip
#export DOWNLOADSOURCEURL=http://downloads.sourceforge.net/project/openjpeg.mirror/$VERSION/openjpeg-$VERSION.tar.gz
export DOWNLOADSOURCEURL=https://github.com/uclouvain/openjpeg/archive/v$VERSION.tar.gz
wl-showstatus download
wl-download -v -d $TARBALLDIR/$BASENAME $DOWNLOADSOURCEURL
#mv $TARBALLDIR/$BASENAME/v$VERSION.tar.gz $TARBALLDIR/$BASENAME/openjpeg-$VERSION.tar.gz
wl-wait4deps
#export DOWNLOADSOURCEURL=http://www.openjpeg.org/openjpeg_v`echo $VERSION|sed -e "s/\./_/g"`.tar.gz
#wl-download -v -d $TARBALLDIR/$BASENAME $DOWNLOADSOURCEURL
#tar xz --force-local -f $TARBALLDIR/$BASENAME/openjpeg_v`echo $VERSION|sed -e "s/\./_/g"`.tar.gz
#cd OpenJPEG_v`echo $VERSION|sed -e "s/\./_/g"`
#patch -ulbf Makefile << EOF
#--- Makefile  2007-12-21 11:39:42 +0100
#+++ Makefile  2010-07-13 15:55:02 +0200
#@@ -20,4 +20,4 @@
#
#-COMPILERFLAGS = -Wall -O3 -ffast-math -std=c99 -fPIC
#-LIBRARIES = -lstdc++
#+COMPILERFLAGS = -Wall -O3 -ffast-math -std=c99 -DWIN32
#+LIBRARIES = -lucommon
#
#@@ -28,4 +28,4 @@
# STATICLIB = lib\$(TARGET).a
#-SHAREDLIB = lib\$(TARGET)-\$(VER_MAJOR).\$(VER_MINOR).so
#-LIBNAME = lib\$(TARGET).so.\$(VER_MAJOR)
#+SHAREDLIB = lib\$(TARGET).dll
#+LIBNAME = lib\$(TARGET).dll.a
#
#@@ -41,2 +41,3 @@
#        install -m 755 \$(SHAREDLIB) dist
#+`printf "\\t"`install -m 644 \$(SHAREDLIB).a dist
#        ln -sf \$(SHAREDLIB) dist/\$(LIBNAME)
#@@ -56,3 +57,4 @@
# \$(SHAREDLIB): \$(MODULES)
#-        \$(CC) -s -shared -Wl,-soname,\$(LIBNAME) -o \$@ \$(MODULES) \$(LIBRARIES)
#+`printf "\\t"`\$(CC) -s -shared -Wl,--output-def,\$(SHAREDLIB).def -Wl,--out-implib,\$(LIBNAME) -Wl,-Bsymbolic -o \$@ \$(MODULES) \$(LIBRARIES)
#+`printf "\\t"`#lib.exe /machine:i386 /def:\$(SHAREDLIB).def /out:\$(SHAREDLIB).lib
#EOF
## manually create .la file
#mkdir -p $INSTALLPREFIX/include $INSTALLPREFIX/lib $INSTALLPREFIX/bin
#cat > $INSTALLPREFIX/lib/libopenjpeg.la << EOF
## -lz - a libtool library file
## Generated by hand - GNU libtool 0.0.0
#dlname='libopenjpeg.dll'
#library_names='libopenjpeg.dll.a'
#old_library='libopenjpeg.a'
#dependency_libs=''
#current=0
#age=0
#revision=1
#installed=yes
#shouldnotlink=no
#dlopen=''
#dlpreopen=''
#libdir='$INSTALLPREFIX/lib'
#EOF
#make -j1 PREFIX=$INSTALLPREFIX CFLAGS="-DWIN32 -DOPJ_STATIC $CFLAGS" &&
# cp libopenjpeg/openjpeg.h $INSTALLPREFIX/include/ &&
# cp *.a $INSTALLPREFIX/lib/ &&
# cp *.dll $INSTALLPREFIX/bin/ &&
# wl-makepackage -c -d && wl-install -d $BASENAME-$VERSION && cd .. && ( rm -rf openjpeg-$VERSION || rm -rf OpenJPEG_v`echo $VERSION|sed -e "s/\./_/g"` )

#export DOWNLOADSOURCEURL=http://openjpeg.googlecode.com/files/openjpeg-$VERSION.tar.gz
#wl-showstatus download
#wl-download -v -d $TARBALLDIR/$BASENAME $DOWNLOADSOURCEURL
#tar xz --force-local -f $TARBALLDIR/$BASENAME/openjpeg-$VERSION.tar.gz
#cd openjpeg-$VERSION
## fix redefinition of DllMain in libopenjpeg/openjpeg.c
#patch -ulbf libopenjpeg/openjpeg.c << EOF
#--- libopenjpeg/openjpeg.c  2012-09-13 09:58:40 +0200
#+++ libopenjpeg/openjpeg.c  2013-11-16 17:03:04 +0100
#@@ -38 +38 @@
#-DllMain(HANDLE hModule, DWORD ul_reason_for_call, LPVOID lpReserved) {
#+DllMain(HINSTANCE hModule, DWORD ul_reason_for_call, LPVOID lpReserved) {
#EOF
## fix building DLLs on 64-bit
#if ( echo $RUNPLATFORM | grep -q x86_64 ); then
# autoreconf -f -i -I m4 -I $MINGWPREFIX/share/aclocal
#fi
#wl-showstatus configure &&
#./configure --prefix=$INSTALLPREFIX --build=$BUILDPLATFORM --host=$RUNPLATFORM --enable-shared --enable-mj2 --enable-jpwl --enable-jpip LDFLAGS="-Wl,--as-needed -lws2_32" &&
# wl-showstatus build-install &&
# make install-strip &&
# wl-makepackage -c -d && wl-install -d $BASENAME-$VERSION && cd .. && wl-showstatus cleanup && rm -rf openjpeg-$VERSION

#export DOWNLOADSOURCEURL=http://openjpeg.googlecode.com/files/openjpeg_v1_4_sources_r697.tgz
#wl-download -v -d $TARBALLDIR/$BASENAME $DOWNLOADSOURCEURL
#tar xz --force-local -f $TARBALLDIR/$BASENAME/openjpeg_v1_4_sources_r697.tgz
#cd openjpeg_v1_4_sources_r697
## avoid error in libopenjpeg/CMakeLists.txt: set_target_properties called with incorrect number of arguments
#patch -ulbf libopenjpeg/CMakeLists.txt << EOF
#--- libopenjpeg/CMakeLists.txt  Tue Sep 25 16:54:50 2007
#+++ libopenjpeg/CMakeLists.txt  Wed Jul 15 09:16:14 2009
#@@ -34,4 +34,4 @@
# ADD_LIBRARY(\${OPENJPEG_LIBRARY_NAME} \${OPENJPEG_SRCS})
#-SET_TARGET_PROPERTIES(\${OPENJPEG_LIBRARY_NAME} PROPERTIES
#-       \${OPENJPEG_LIBRARY_PROPERTIES})
#+#SET_TARGET_PROPERTIES(\${OPENJPEG_LIBRARY_NAME} PROPERTIES
#+#      \${OPENJPEG_LIBRARY_PROPERTIES})
#EOF
#cmake.exe -Wno-dev -G"MSYS Makefiles" -DCMAKE_INSTALL_PREFIX=$INSTALLPREFIX `pwd`/libopenjpeg . &&
# make &&
# mkdir -p $INSTALLPREFIX/lib $INSTALLPREFIX/include &&
# cp libbio.c.a $INSTALLPREFIX/lib/libopenjpeg.a &&
# cp libopenjpeg/openjpeg.h $INSTALLPREFIX/include/ &&
# mkdir -p $INSTALLPREFIX/bin &&
# unzip -oq -d $INSTALLPREFIX/bin -j $TARBALLDIR/$BASENAME/openjpeg_v`echo $VERSION|sed -e "s/\./_/g"`_win32.zip "*.dll" &&
# pexports -o $INSTALLPREFIX/bin/OpenJPEG.dll > libopenjpeg.def &&
# dlltool --def libopenjpeg.def --dllname $INSTALLPREFIX/bin/OpenJPEG.dll --output-lib $INSTALLPREFIX/lib/libopenjpeg.dll.a &&
# wl-makepackage -c -d && wl-install -d $BASENAME-$VERSION && cd .. && rm -rf OpenJPEG_v`echo $VERSION|sed -e "s/\./_/g"`
# configure and build (version >= 2.0.0)
#cmake.exe -Wno-dev -G"MSYS Makefiles" -DCMAKE_INSTALL_PREFIX=$INSTALLPREFIX -DBUILD_SHARED_LIBS:BOOL=OFF -DCMAKE_BUILD_TYPE:STRING=Release -DBUILD_TESTING:BOOL=OFF -DBUILD_CODEC:BOOL=ON -DBUILD_JPWL:BOOL=OFF -DBUILD_MJ2:BOOL=OFF -DBUILD_JPIP:BOOL=OFF -DBUILD_JPIP_SERVER:BOOL=OFF . &&
# make install/strip &&
# rm -f CMakeCache.txt &&
# cmake.exe -Wno-dev -G"MSYS Makefiles" -DCMAKE_INSTALL_PREFIX=$INSTALLPREFIX -DBUILD_SHARED_LIBS:BOOL=ON -DCMAKE_BUILD_TYPE:STRING=Release -DBUILD_TESTING:BOOL=OFF -DBUILD_CODEC:BOOL=ON -DBUILD_JPWL:BOOL=OFF -DBUILD_MJ2:BOOL=OFF -DBUILD_JPIP:BOOL=OFF -DBUILD_JPIP_SERVER:BOOL=OFF . &&
# make install/strip &&
# wl-makepackage -c -d && wl-install -d $BASENAME-$VERSION && cd .. && rm -rf openjpeg-$VERSION

#tar xz --force-local -f $TARBALLDIR/$BASENAME/openjpeg-$VERSION.tar.gz
tar xz --force-local -f $TARBALLDIR/$BASENAME/v$VERSION.tar.gz
cd openjpeg-$VERSION
patch -ulbf python/libxml_wrap.h << EOF
--- src/lib/openjpip/sock_manager.c  2014-04-29 09:15:02.000000000 +0200
+++ src/lib/openjpip/sock_manager.c  2014-11-22 16:40:02.000000000 +0100
@@ -32,3 +32,5 @@
 #include <windows.h>
+#ifndef __MINGW32__
 typedef SSIZE_T ssize_t;
+#endif
 #else
EOF
# fix missing DBL_EPSILON in src/lib/openjp2/tcd.c (version >= 2.3.1)
patch -ulbf src/lib/openjp2/tcd.c << EOF
@@ -297,4 +297,7 @@
                                     continue;
                                 }
+#ifndef DBL_EPSILON
+#define DBL_EPSILON __DBL_EPSILON__
+#endif
                                 if (thresh - (dd / dr) <
                                         DBL_EPSILON) { /* do not rely on float equality, check with DBL_EPSILON margin */
EOF
# fix detection of libtiff in thirdparty/CMakeLists.txt (version >= 2.5.0)
patch -ulbf thirdparty/CMakeLists.txt << EOF
@@ -74,3 +74,8 @@
 else(BUILD_THIRDPARTY)
+  include(FindPkgConfig)
+ if(PKG_CONFIG_FOUND)
+  pkg_check_modules(TIFF REQUIRED libtiff-4)
+ else()
   find_package(TIFF)
+ endif()
   # Static only build:
EOF
#mkdir -p build_static build_shared &&
# wl-showstatus configure &&
# cmake.exe -Wno-dev -G"MSYS Makefiles" -DCMAKE_INSTALL_PREFIX=$INSTALLPREFIX -DBUILD_SHARED_LIBS:BOOL=OFF -DBUILD_PKGCONFIG_FILES:BOOL=OFF -S. -Bbuild_static &&
# wl-showstatus configure &&
# cmake.exe -Wno-dev -G"MSYS Makefiles" -DCMAKE_INSTALL_PREFIX=$INSTALLPREFIX -DBUILD_SHARED_LIBS:BOOL=ON -DBUILD_PKGCONFIG_FILES:BOOL=ON -S. -Bbuild_shared &&
# wl-showstatus build-install &&
# make -Cbuild_static install/strip &&
# wl-showstatus build-install &&
# make -Cbuild_shared install/strip &&
# # fix absolute link in .cmake file(s)
# sed -i -e "s?$(echo $INSTALLPREFIX|sed -e "s?^/\([a-zA-Z]\)/?\1:/?")?\${CMAKE_CURRENT_LIST_FILE}/../../..?g" $INSTALLPREFIX/lib/openjpeg-*/OpenJPEGConfig.cmake &&
# wl-makepackage -c -d && wl-install -d $BASENAME-$VERSION && cd .. && rm -rf openjpeg-$VERSION
mkdir -p build_static build_shared &&
 wl-showstatus configure &&
 cmake.exe -Wno-dev -GNinja -DCMAKE_INSTALL_PREFIX=$INSTALLPREFIX -DBUILD_SHARED_LIBS:BOOL=OFF -DBUILD_PKGCONFIG_FILES:BOOL=OFF -S. -Bbuild_static &&
 wl-showstatus configure &&
 cmake.exe -Wno-dev -GNinja -DCMAKE_INSTALL_PREFIX=$INSTALLPREFIX -DBUILD_SHARED_LIBS:BOOL=ON -DBUILD_PKGCONFIG_FILES:BOOL=ON -S. -Bbuild_shared &&
 wl-showstatus build-install &&
 ninja -Cbuild_static install/strip &&
 wl-showstatus build-install &&
 ninja -Cbuild_shared install/strip &&
 ## fix absolute link in .cmake file(s) (version <= 2.5.0)
 #sed -i -e "s?$(echo $INSTALLPREFIX|sed -e "s?^/\([a-zA-Z]\)/?\1:/?")?\${CMAKE_CURRENT_LIST_FILE}/../../..?g" $INSTALLPREFIX/lib/openjpeg-*/OpenJPEGConfig.cmake &&
 wl-makepackage -c -d && wl-install -d $BASENAME-$VERSION && cd .. && rm -rf openjpeg-$VERSION



