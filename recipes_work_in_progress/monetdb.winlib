export NAME="MonetDB"
export STATUS=
export URL=https://www.monetdb.org/
export BASENAME=monetdb
export DESCRIPTION="MonetDB is an open-source column-oriented database management system."
export CATEGORY=database
export TYPE=library
#export VERSION=11.33.11
#export VERSIONDATE=20191125
#export VERSION=11.35.3
#export VERSIONDATE=20191128
#export VERSION=11.35.9
#export VERSIONDATE=20191220
#export VERSION=11.35.15
#export VERSIONDATE=20200221
#export VERSION=11.35.19
#export VERSIONDATE=20200224
#export VERSION=11.37.7
#export VERSIONDATE=20200604
#export VERSION=11.37.11
#export VERSIONDATE=20200727
#export VERSION=11.37.13
#export VERSIONDATE=20220511
#export VERSION=11.39.5
#export VERSIONDATE=20201019
#export VERSION=11.39.7
#export VERSIONDATE=20201124
#export VERSION=11.39.11
#export VERSIONDATE=20210125
#export VERSION=11.39.13
#export VERSIONDATE=20210219
#export VERSION=11.39.15
#export VERSIONDATE=20210413
#export VERSION=11.39.17
#export VERSIONDATE=20210510
#export VERSION=11.41.5
#export VERSIONDATE=20210809
#export VERSION=11.41.11
#export VERSIONDATE=20211005
#export DEPENDANCIES=pthreads,pcre,liblz4,xz,snappy,readline,libiconv,libuuid,libcurl,proj,gdal,geos
#export OPTIONALDEPENDANCIES=
#export BUILDDEPENDANCIES=
#export VERSION=11.41.13
#export VERSIONDATE=20211222
#export VERSION=11.41.15
#export VERSIONDATE=20220304
#export VERSION=11.41.19
#export VERSIONDATE=20220315
#export VERSION=11.41.21
#export VERSIONDATE=20220325
#export VERSION=11.41.23
#export VERSIONDATE=20220503
#export VERSION=11.41.25
#export VERSIONDATE=20220811
#export VERSION=11.41.27
#export VERSIONDATE=20220901
#export VERSION=11.43.5
#export VERSIONDATE=20211222
#export VERSION=11.43.9
#export VERSIONDATE=20220214
#export VERSION=11.43.13
#export VERSIONDATE=20220408
#export VERSION=11.43.15
#export VERSIONDATE=20220531
export VERSION=11.43.21
export VERSIONDATE=20220823
wl-showstatus --package-version
export DEPENDANCIES=pthreads,pcre,liblz4,xz,snappy,readline,libiconv,libuuid,libcurl,proj,gdal,geos
export OPTIONALDEPENDANCIES=
export BUILDDEPENDANCIES=cmake,ninja
export LICENSEFILE=COPYING
export LICENSETYPE=
export DOWNLOADURL="https://www.monetdb.org/downloads/sources/archive/"
export INSTALLPREFIX=`pwd`/inst_$BASENAME-$VERSION
export DOWNLOADSOURCEURL=https://www.monetdb.org/downloads/sources/archive/MonetDB-$VERSION.tar.xz
wl-showstatus download
wl-download -v -d $TARBALLDIR/$BASENAME $DOWNLOADSOURCEURL
wl-wait4deps
wl-showstatus extract
tar xfJ $TARBALLDIR/$BASENAME/MonetDB-$VERSION.tar.xz
cd MonetDB-$VERSION
# fix missing socklen_t in common/stream/socket_stream.c (version >= 11.41.21)
mv common/stream/socket_stream.c common/stream/socket_stream.c.bak &&
echo "#include <ws2tcpip.h>" > common/stream/socket_stream.c &&
cat common/stream/socket_stream.c.bak >> common/stream/socket_stream.c
## fix already defined uuid_t in common/utils/muuid.c
#patch -ulbf common/utils/muuid.c << EOF
#@@ -15,2 +15,3 @@
# #ifdef HAVE_UUID_UUID_H
#+#undef uuid_t
# # include <uuid/uuid.h>
#EOF
#sed -i.bak -e "0,/#ifdef NATIVE_WIN32/s/#ifdef NATIVE_WIN32/#if defined(NATIVE_WIN32) \&\& \!defined(__MINGW32__)/" common/utils/mutils.h common/utils/mutils.c
## fix missing socklen_t in common/stream/socket_stream.c (version >= 11.39.7)
#mv common/stream/socket_stream.c common/stream/socket_stream.c.bak &&
#echo "#include <ws2tcpip.h>" > common/stream/socket_stream.c &&
#cat common/stream/socket_stream.c.bak >> common/stream/socket_stream.c
#wl-showstatus configure &&
# # mkdir -p m4 &&
# # autoreconf -f -i -I m4 -I $MINGWPREFIX/share/aclocal &&
# #./autogen.sh &&
# #    echo OK
# ## fix building DLLs on 64-bit
# #if ( echo $RUNPLATFORM | grep -q x86_64 ); then
# # echo "AM_GNU_GETTEXT_VERSION([$(gettext --version|head -n1|sed -e "s/^.* \([0-9\.]*\) *$/\1/")])" >> configure.ac &&
# # autoreconf -f -i -I m4 -I $MINGWPREFIX/share/aclocal
# #fi
# #INTLTOOL_PERL="$PERLDIR/bin/perl.exe" 
# #PERL="$PERLDIR/bin/perl.exe -I$PERLDIR/lib" 
# #PYTHON=$PYDIR/python.exe 
# #PYTHON=$PYDIR/python.exe C_INCLUDE_PATH=$PYDIR/include${C_INCLUDE_PATH:+:$C_INCLUDE_PATH} 
# #./configure --prefix=$INSTALLPREFIX --build=$BUILDPLATFORM --host=$RUNPLATFORM LDFLAGS="-Wl,--as-needed -Wl,-no-undefined" &&
# ./configure --prefix=$INSTALLPREFIX --build=$BUILDPLATFORM --host=$RUNPLATFORM --enable-static --enable-shared --disable-rpath CFLAGS="-I$MINGWPREFIX/include/portable-uuid" LDFLAGS="-Wl,--as-needed -lportable-uuid" &&
# #./configure --prefix=$INSTALLPREFIX --build=$BUILDPLATFORM --host=$RUNPLATFORM --enable-static --enable-shared --disable-rpath CFLAGS="-I$MINGWPREFIX/include/portable-uuid" LDFLAGS="-Wl,--as-needed -lportable-uuid -lws2_32 -lz -lbz2 -llzma -llz4 -lcurl" &&
# sed -i.bak -e "s/^#define socklen_t int$/#include <ws2tcpip.h>/" monetdb_config.h &&
# echo "#define HAVE_LOCKF 1" >> monetdb_config.h &&
# echo "#include <pthread.h>" >> monetdb_config.h &&
# echo "#undef HAVE_POPEN" >> monetdb_config.h &&
# echo "#define NATIVE_WIN32 1" >> monetdb_config.h &&
# echo "#define _MSC_EXTENSIONS 1" >> monetdb_config.h &&
# echo "#include <ws2tcpip.h>" >> monetdb_config.h &&
# # fix building DLLs
# sed -i.bak -e "s/\(allow_undefined=\)yes/\1no/" libtool &&
# #wl-showstatus build &&
# #make &&
# wl-showstatus build-install &&
# make install-strip &&
#    ls -l $INSTALLPREFIX/lib/pkgconfig $INSTALLPREFIX/share/pkgconfig
#    make install-pkgconfigDATA
## wl-makepackage -c -d && wl-install -d $BASENAME-$VERSION && cd .. && wl-showstatus cleanup && rm -rf MonetDB-$VERSION
mkdir -p build_win &&
 wl-showstatus configure &&
 cmake.exe -Wno-dev -GNinja -DCMAKE_INSTALL_PREFIX:PATH=$INSTALLPREFIX -DCMAKE_BUILD_TYPE:STRING=Release -DBUILD_SHARED_LIBS:BOOL=OFF -DRELEASE_VERSION:BOOL=ON -DNETCDF:BOOL=ON -DODBC:BOOL=ON -DBUILD_TESTING:BOOL=OFF -DTESTING:BOOL=OFF -DCMAKE_UNITTESTS:BOOL=OFF -DHAVE_GETOPT_H:PATH=$(find $MINGWDIR -name getopt.h|head -n1) -DPython3_EXECUTABLE:FILEPATH=$PYDIR/python.exe -S. -Bbuild_win &&
 sed -i.bak -e "s?^#define SOCKET .*\$?//&?; s?^#define closesocket .*\$?//&?" build_win/monetdb_config.h &&
 wl-showstatus build-install &&
 ninja -Cbuild_win install/strip &&
    echo OK
# wl-makepackage -c -d && wl-install -d $BASENAME-$VERSION && cd .. && wl-showstatus cleanup && rm -rf MonetDB-$VERSION



