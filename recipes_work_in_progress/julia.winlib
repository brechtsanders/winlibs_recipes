export NAME="Julia"
export STATUS=
export URL=http://julialang.org/
export BASENAME=julia
export DESCRIPTION="Julia is a high-level, high-performance dynamic programming language for technical computing, with syntax that is familiar to users of other technical computing environments."
export CATEGORY=math,programming
export TYPE=application
#export VERSION=0.2.1
#export VERSIONDATE=20140603
####fatal: Not a git repository (or any of the parent directories): .git
#export VERSION=0.3.0
#export VERSIONDATE=20140821
####git: 'submodule' is not a git command. See 'git --help'.
#export VERSION=0.3.1
#export VERSIONDATE=20140911
#export VERSION=0.3.2
#export VERSIONDATE=20141022
#export VERSION=0.3.3
#export VERSIONDATE=20141124
#export VERSION=0.3.4
#export VERSIONDATE=20141226
#export VERSION=0.3.5
#export VERSIONDATE=20150109
####git: 'submodule' is not a git command. See 'git --help'.
####which: sha512sum: unknown command
#export VERSION=0.3.6
#export VERSIONDATE=20150219
####Local NTFS volumes are required to complete the operation.
#export VERSION=0.3.7
#export VERSIONDATE=20150324
#export VERSION=0.3.8
#export VERSIONDATE=20150501
#export VERSION=0.3.9
#export VERSIONDATE=20150530
#export VERSION=0.3.10
#export VERSIONDATE=20150624
#export VERSION=0.3.11
#export VERSIONDATE=20150727
#export VERSION=0.3.12
#export VERSIONDATE=20151030
#export VERSION=0.4.0
#export VERSIONDATE=20151008
#export VERSION=0.4.1
#export VERSIONDATE=20151108
#export VERSION=0.4.2
#export VERSIONDATE=20151207
#export VERSION=0.4.3
#export VERSIONDATE=20160114
####fatal: Not a git repository (or any of the parent directories): .git
#export VERSION=0.4.4
#export VERSIONDATE=20160316
#export VERSION=0.4.5
#export VERSIONDATE=20160317
#export VERSION=0.4.6
#export VERSIONDATE=20160620
#export VERSION=0.4.7
#export VERSIONDATE=20160919
#export VERSION=0.5.0
#export VERSIONDATE=20160920
####checking for python >= 2.5... ../configure: line 12390: -c: command not found
#export VERSION=0.5.1
#export VERSIONDATE=20170305
#export VERSION=0.5.2
#export VERSIONDATE=20170507
#export VERSION=0.6.0
#export VERSIONDATE=20170620
#export VERSION=0.6.1
#export VERSIONDATE=20171025
#export VERSION=0.6.2
#export VERSIONDATE=20171214
#export VERSION=0.6.3
#export VERSIONDATE=20180529
#export VERSION=0.6.4
#export VERSIONDATE=20180710
#export VERSION=0.7.0
#export VERSIONDATE=20180808
#export VERSION=1.0.0
#export VERSIONDATE=20180809
#export VERSION=1.0.1
#export VERSIONDATE=20180930
#export VERSION=1.0.2
#export VERSIONDATE=20181109
#export VERSION=1.0.3
#export VERSIONDATE=20181217
#export VERSION=1.0.4
#export VERSIONDATE=20190516
#export VERSION=1.0.5
#export VERSIONDATE=20190910
#export VERSION=1.1.0
#export VERSIONDATE=20190122
#export VERSION=1.1.1
#export VERSIONDATE=20190516
#export VERSION=1.2.0
#export VERSIONDATE=20190820
#export VERSION=1.3.0
#export VERSIONDATE=20191126
#export VERSION=1.3.1
#export VERSIONDATE=20191231
#export VERSION=1.4.0
#export VERSIONDATE=20200322
#export VERSION=1.4.1
#export VERSIONDATE=20200415
####make[2]: *** No rule to make target 'src/support/hashing.o', needed by 'src/support/libsupport.a'.  Stop.
#export VERSION=1.4.2
#export VERSIONDATE=20200524
#export VERSION=1.5.0
#export VERSIONDATE=20200802
#export VERSION=1.5.1
#export VERSIONDATE=20200826
#export VERSION=1.5.2
#export VERSIONDATE=20200924
####src/init.c:436:58: error: 'UV_STDIN_FD' undeclared (first use in this function)
#export VERSION=1.5.3
#export VERSIONDATE=20201110
#export VERSION=1.5.4
#export VERSIONDATE=20210312
#export VERSION=1.6.0
#export VERSIONDATE=20210325
#export VERSION=1.6.1
#export VERSIONDATE=20210424
#export VERSION=1.6.2
#export VERSIONDATE=20210715
#export VERSION=1.6.3
#export VERSIONDATE=20210924
#export VERSION=1.6.4
#export VERSIONDATE=20211120
#export VERSION=1.6.5
#export VERSIONDATE=20211221
#export VERSION=1.6.6
#export VERSIONDATE=20220330
#export VERSION=1.6.7
#export VERSIONDATE=20220720
#export VERSION=1.7.0
#export VERSIONDATE=20211201
#export VERSION=1.7.1
#export VERSIONDATE=20211223
#export VERSION=1.7.2
#export VERSIONDATE=20220208
#export VERSION=1.7.3
#export VERSIONDATE=20220526
#export VERSION=1.8.0
#export VERSIONDATE=20220818
#export VERSION=1.8.1
#export VERSIONDATE=20220907
#export VERSION=1.8.2
#export VERSIONDATE=20220930
#export VERSION=1.8.3
#export VERSIONDATE=20221115
#export VERSION=1.8.4
#export VERSIONDATE=20221224
#export VERSION=1.8.5
#export VERSIONDATE=20230108
#export VERSION=1.9.0
#export VERSIONDATE=20230508
#export VERSION=1.9.1
#export VERSIONDATE=20230607
#export VERSION=1.9.2
#export VERSIONDATE=20230706
#export VERSION=1.9.3
#export VERSIONDATE=20230825
#export VERSION=1.9.4
#export VERSIONDATE=20231115
#export VERSION=1.10.0
#export VERSIONDATE=20231227
####make[1]: *** [sysimage.mk:61: /R/winlibs64-10.2.0-8.0.0/julia-1.5.1/usr/lib/julia/corecompiler.ji] Error 127
#export VERSION=1.10.1
#export VERSIONDATE=20240215
#export VERSION=1.10.3
#export VERSIONDATE=20240501
#export VERSION=1.10.4
#export VERSIONDATE=20240605
#export VERSION=1.10.5
#export VERSIONDATE=20240829
#export VERSION=1.10.6
#export VERSIONDATE=20241029
#export VERSION=1.10.7
#export VERSIONDATE=20241127
#export VERSION=1.10.8
#export VERSIONDATE=20250123
#export VERSION=1.10.9
#export VERSIONDATE=20250311
#export VERSION=1.10.10
#export VERSIONDATE=20250701
#export VERSION=1.11.0
#export VERSIONDATE=20241009
#export VERSION=1.11.1
#export VERSIONDATE=20241017
#export VERSION=1.11.2
#export VERSIONDATE=20241203
#export VERSION=1.11.3
#export VERSIONDATE=20250122
#export VERSION=1.11.4
#export VERSIONDATE=20250311
#export VERSION=1.11.5
#export VERSIONDATE=20250415
#export VERSION=1.11.6
#export VERSIONDATE=20250711
#export VERSION=1.11.7
#export VERSIONDATE=20250716
#export VERSION=1.12.0
#export VERSIONDATE=20251009
export VERSION=1.12.1
export VERSIONDATE=20251019
wl-showstatus --package-version
export DEPENDENCIES=openblas,lapack,libutf8proc,libuv
export OPTIONALDEPENDENCIES=
#export BUILDDEPENDENCIES=
#export OPTIONALBUILDDEPENDENCIES=
export BUILDDEPENDENCIES=llvm-project
export OPTIONALBUILDDEPENDENCIES=
export LICENSEFILE=LICENSE.md
export LICENSETYPE=MIT
#export DOWNLOADURL="http://julialang.org/downloads/"
export DOWNLOADURL="https://github.com/JuliaLang/julia/releases v"
export INSTALLPREFIX=`pwd`/inst_$BASENAME-$VERSION
#export DOWNLOADSOURCEURL=https://github.com/JuliaLang/julia/archive/v$VERSION.tar.gz
#export DOWNLOADSOURCEURL=https://github.com/JuliaLang/julia/archive/v$VERSION.tar.gz
export DOWNLOADSOURCEURL=https://github.com/JuliaLang/julia/releases/download/v$VERSION/$BASENAME-$VERSION-full.tar.gz
#export DOWNLOADSOURCEURL=https://github.com/JuliaLang/julia/archive/refs/tags/v$VERSION.tar.gz
wl-showstatus download
wl-download -v -d $TARBALLDIR/$BASENAME $DOWNLOADSOURCEURL
#mv $TARBALLDIR/$BASENAME/v$VERSION $TARBALLDIR/$BASENAME/$BASENAME-$VERSION.tar.gz
#mv -f $TARBALLDIR/$BASENAME/v$VERSION.tar.gz $TARBALLDIR/$BASENAME/$BASENAME-$VERSION.tar.gz
wl-wait4deps
wl-showstatus extract
# note: make sure you are on an NTFS volume before proceeding
#tar xz --force-local -f $TARBALLDIR/$BASENAME/v$VERSION
#tar xz --force-local -f $TARBALLDIR/$BASENAME/$BASENAME-$VERSION.tar.gz
#tar xz --force-local -f $TARBALLDIR/$BASENAME/v$VERSION.tar.gz
tar xz --force-local -f $TARBALLDIR/$BASENAME/$BASENAME-$VERSION-full.tar.gz
cd $BASENAME-$VERSION

echo "override CMAKE=$(which cmake.exe)" > Make.user
echo "override PYTHON=$PYDIR/python.exe" >> Make.user

cat > Make.user << EOF
CMAKE=$(which cmake.exe)
PYTHON=$PYDIR/python.exe
OS=WINNT
#LLVM_CONFIG=$(which llvm-config.exe)
USE_SYSTEM_LLVM=0
USE_SYSTEM_LIBUNWIND=1
USE_SYSTEM_PCRE=1
USE_SYSTEM_LIBM=1
USE_SYSTEM_OPENLIBM=1
USE_SYSTEM_OPENSPECFUN=1
USE_SYSTEM_DSFMT=1
USE_SYSTEM_BLAS=1
USE_SYSTEM_LAPACK=1
USE_SYSTEM_FFTW=1
USE_SYSTEM_GMP=1
USE_SYSTEM_MPFR=1
USE_SYSTEM_ARPACK=1
#USE_SYSTEM_SUITESPARSE=1
USE_SYSTEM_LIBUV=1
USE_SYSTEM_UTF8PROC=1
USE_SYSTEM_LIBGIT2=1
USE_SYSTEM_PATCHELF=1
EOF

#mkdir -p usr/include/uv; touch usr/include/uv/errno.h

mkdir -p include/uv
echo "#include_next <errno.h>" > include/uv/errno.h

## fix missing UV_STDIN_FD/UV_STDOUT_FD/UV_STDERR_FD in src/init.c (version >= 1.4.2)
#patch -ulbf src/init.c << EOF
#@@ -318,2 +318,11 @@
# #ifdef _OS_WINDOWS_
#+#ifndef UV_STDIN_FD
#+#define UV_STDIN_FD  STD_INPUT_HANDLE
#+#endif
#+#ifndef UV_STDOUT_FD
#+#define UV_STDOUT_FD  STD_OUTPUT_HANDLE
#+#endif
#+#ifndef UV_STDERR_FD
#+#define UV_STDERR_FD STD_ERROR_HANDLE
#+#endif
# int uv_dup(uv_os_fd_t fd, uv_os_fd_t* dupfd) {
#EOF
# fix missing UV_STDIN_FD/UV_STDOUT_FD/UV_STDERR_FD in src/init.c (version >= 1.6.6)
patch -ulbf src/init.c << EOF
@@ -310,2 +310,11 @@
 #ifdef _OS_WINDOWS_
+#ifndef UV_STDIN_FD
+#define UV_STDIN_FD  STD_INPUT_HANDLE
+#endif
+#ifndef UV_STDOUT_FD
+#define UV_STDOUT_FD  STD_OUTPUT_HANDLE
+#endif
+#ifndef UV_STDERR_FD
+#define UV_STDERR_FD STD_ERROR_HANDLE
+#endif
 static int uv_dup(uv_os_fd_t fd, uv_os_fd_t* dupfd) {
EOF
# fix missing UV_STDOUT_FD/UV_STDERR_FD in src/jl_uv.c (version >= 1.4.2)
patch -ulbf src/jl_uv.c << EOF
@@ -23,2 +23,10 @@
 #include "uv.h"
+#ifdef _OS_WINDOWS_
+#ifndef UV_STDOUT_FD
+#define UV_STDOUT_FD  STD_OUTPUT_HANDLE
+#endif
+#ifndef UV_STDERR_FD
+#define UV_STDERR_FD STD_ERROR_HANDLE
+#endif
+#endif

EOF
# fix missing uv_thread_setaffinity/uv_thread_detach in src/threading.c (version >= 1.4.2)
patch -ulbf src/threading.c << EOF
@@ -447,2 +447,3 @@
     // non-exclusive: no affinity settings; let the kernel move threads about
+#ifndef _WIN32
     if (exclusive) {
@@ -454,2 +455,3 @@
     }
+#endif

@@ -466,2 +468,3 @@
         uv_thread_create(&uvtid, jl_threadfun, t);
+#ifndef _WIN32
         if (exclusive) {
@@ -472,2 +475,3 @@
         uv_thread_detach(&uvtid);
+#endif
     }
EOF
# fix src/jl_uv.c (version >= 1.9.4)
patch -ulbf src/jl_uv.c << EOF
@@ -309,4 +309,6 @@
     //opts.gid = 0;
+#ifndef _WIN32
     opts.cpumask = cpumask;
     opts.cpumask_size = cpumask_size;
+#endif
     opts.cwd = cwd;
EOF
## avoid undefined reference to strtoll/strtoull in src/flisp/read.c (version >= 1.9.4)
#sed -i.bak -e "s/\(strtou*l\)l/\1/g" src/flisp/read.c
# fix missing files (version >= 1.4.2)
touch "src/flisp/-luv"
touch "src/-luv"
touch "src/flisp/-lutf8proc"
# fix src/support/Makefile (version >= 1.4.2)
cat >> src/support/Makefile << EOF
%.o: %.c
$(echo -e '\t')\$(CC) \$(JCPPFLAGS) \$(JCFLAGS) \$(SHIPFLAGS) \$(DISABLE_ASSERTIONS) -c \$< -o \$@
EOF
# fix src/flisp/Makefile (version >= 1.4.2)
cat >> src/flisp/Makefile << EOF
%.o: %.c
$(echo -e '\t')\$(CC) \$(JCPPFLAGS) \$(JCFLAGS) \$(SHIPFLAGS) \$(DISABLE_ASSERTIONS) -c \$< -o \$@
EOF
# fix ui/Makefile (version >= 1.4.2)
cat >> ui/Makefile << EOF
%.o: %.c
$(echo -e '\t')\$(CC) \$(CPPFLAGS) \$(CFLAGS) \$(SHIPFLAGS) -c \$< -o \$@
EOF
wl-showstatus build &&
 #make -j1 &&
 #make -j1 PYTHON=$PYDIR/python.exe USE_SYSTEM_LLVM=1 &&
 #PATH=$PYDIR:$PATH:$PERLDIR/bin make -j1 CC=${CC:-gcc} LOCALBASE=$PWD PYTHON=$PYDIR/python.exe LIBBLAS="-lopenblas" LIBLAPACK="-L$MINGWPREFIX/share/lapack/lib -llapack" LIBUV="$MINGWPREFIX/lib/libuv.dll.a" &&
 PATH=$PYDIR:$PATH:$PERLDIR/bin make -j1 CC=${CC:-gcc} LOCALBASE=$PWD PYTHON=$PYDIR/python.exe LIBBLAS="-lopenblas" LIBLAPACK="-L$MINGWPREFIX/share/lapack/lib -llapack" LIBUV="-luv" CXXLDFLAGS="-Wl,--as-needed -luv" &&
 #PATH=$PWD/usr/bin:$PYDIR:$PATH:$PERLDIR/bin make -j1 CC=${CC:-gcc} LOCALBASE=$PWD PYTHON=$PYDIR/python.exe LIBBLAS="-lopenblas" LIBLAPACK="-L$MINGWPREFIX/share/lapack/lib -llapack" LIBUV="-luv" CXXLDFLAGS="-Wl,--as-needed -luv" &&
 #CC=$(if ls -1 $(cygpath $(realpath ${CC:-gcc})) &> /dev/null; then echo $(cygpath $(realpath ${CC:-gcc})); else echo $(cygpath $(realpath ${CC:-gcc}.exe)); fi) 
    echo OK

rm -rf usr
wl-showstatus build &&
 make -Cbase CC=${CC:-gcc} LIBUV_INC=$MINGWPREFIX/include PYTHON=$PYDIR/python.exe PERL=$PERLDIR/bin/perl.exe &&
 make -Ccli CC=${CC:-gcc} PYTHON=$PYDIR/python.exe &&
 make -Cstdlib CC=${CC:-gcc} PYTHON=$PYDIR/python.exe &&
 #make -Cdoc PYTHON=$PYDIR/python.exe &&
    echo OK

# wl-makepackage -c -d && wl-install -d $BASENAME-$VERSION && cd .. && wl-showstatus cleanup && rm -rf $BASENAME-$VERSION



