export NAME="ghostscript"
export STATUS=
export URL=http://www.ghostscript.com/
export BASENAME=ghostscript
export DESCRIPTION="Ghostscript is a package of software that provides: * An interpreter for the PostScript (TM) language, with the ability to convert PostScript language files to many raster formats, view them on displays, and print them on printers that don't have PostScript language capability built in; * An interpreter for Portable Document Format (PDF) files, with the same abilities; * The ability to convert PostScript language files to PDF (with some limitations) and vice versa; and * A set of C procedures (the Ghostscript library) that implement the graphics and filtering (data compression / decompression / conversion) capabilities that appear as primitive operations in the PostScript language and in PDF."
export CATEGORY=graphics
export TYPE=library
#export VERSION=8.62
#export VERSION=8.64
####./obj/gdevpipe.o:gdevpipe.c:(.text+0x4b): undefined reference to `mswin_popen'
####./obj/gdevsgi.o:gdevsgi.c:(.text+0x7e4): undefined reference to `bzero'
####-> base/gp_mswin.c
#export VERSION=8.70
####configure hangs after: checking for X... disabled
#export VERSION=9.00
#export VERSION=9.01
#export VERSIONDATE=20110209
####./base/gp_psync.c:285: error: cannot convert to a pointer type
####./base/gp_psync.c:293: error: conversion to non-scalar type requested
#export VERSION=9.04
#export VERSIONDATE=20111229
####base/gp_unifs.c:157:5: error: unknown type name 'DIR'
#export VERSION=9.05
#export VERSIONDATE=20120208
#export VERSION=9.06
#export VERSIONDATE=20120808
####base/gp_psync.c:282: error: cannot convert to a pointer type
#export VERSION=9.07
#export VERSIONDATE=20130214
#export VERSION=9.09
#export VERSIONDATE=20130822
#export VERSION=9.10
#export VERSIONDATE=20130902
####soobj/gconfig_.h:24:2: error: #endif without #if
#export VERSION=9.14
#export VERSIONDATE=20140326
#export VERSION=9.15
#export VERSIONDATE=20140923
#export VERSION=9.16
#export VERSIONDATE=20150331
#export VERSION=9.18
#export VERSIONDATE=20151005
#export VERSION=9.21
#export VERSIONDATE=20170419
####base/gp_psync.c:284:5: error: cannot convert to a pointer type
#export VERSION=9.22
#export VERSIONDATE=20171005
#export VERSION=9.23
#export VERSIONDATE=20180322
#export VERSION=9.24
#export VERSIONDATE=20180904
#export VERSION=9.25
#export VERSIONDATE=20180914
#export VERSION=9.26
#export VERSIONDATE=20181121
#export VERSION=9.27
#export VERSIONDATE=20190404
#export VERSION=9.50
#export VERSIONDATE=20191015
#export VERSION=9.51
#export VERSIONDATE=20200313
#export VERSION=9.52
#export VERSIONDATE=20200320
#export VERSION=9.53.0
#export VERSIONDATE=20200911
#export VERSION=9.53.1
#export VERSIONDATE=20200915
#export VERSION=9.53.2
#export VERSIONDATE=20200926
#export VERSION=9.53.3
#export VERSIONDATE=20201001
#export VERSION=9.55.0
#export VERSIONDATE=20210927
export VERSION=9.56.0
export VERSIONDATE=20220329
####obj/gscdefs.c:90:41: error: incomplete universal character name \u
wl-showstatus --package-version
export DEPENDANCIES=libjpeg,zlib,libpng
export OPTIONALDEPENDANCIES=
export BUILDDEPENDANCIES=
export LICENSEFILE=LICENSE
export LICENSETYPE=GPL2
#export DOWNLOADURL="http://ghostscript.com/releases/ ghostscript-"
#export DOWNLOADURL="http://downloads.ghostscript.com/public/ ghostscript-"
#export DOWNLOADURL="https://github.com/ArtifexSoftware/ghostpdl-downloads/releases ghostscript-"
export DOWNLOADURL="https://github.com/ArtifexSoftware/ghostpdl-downloads/releases gs"
#export DOWNLOADURL="https://ghostscript.com/releases/gsdnld.html"
#export DOWNLOADSOURCEURL=http://ghostscript.com/releases/ghostscript-$VERSION.tar.bz2
#export DOWNLOADSOURCEURL=http://ghostscript.com/releases/ghostscript-$VERSION.tar.gz
#export DOWNLOADSOURCEURL=http://downloads.ghostscript.com/public/ghostscript-$VERSION.tar.bz2
export DOWNLOADSOURCEURL=https://github.com/ArtifexSoftware/ghostpdl-downloads/releases/download/gs$(echo $VERSION|sed -e "s/\.//g")/ghostscript-$VERSION.tar.xz
export INSTALLPREFIX=`pwd`/inst_$BASENAME-$VERSION
wl-showstatus download
wl-download -v -d $TARBALLDIR/$BASENAME $DOWNLOADSOURCEURL
wl-wait4deps
#tar xfj $TARBALLDIR/$BASENAME/ghostscript-$VERSION.tar.bz2
#tar xfz $TARBALLDIR/$BASENAME/ghostscript-$VERSION.tar.gz
#tar xfj $TARBALLDIR/$BASENAME/ghostscript-$VERSION.tar.bz2
tar xfJ $TARBALLDIR/$BASENAME/ghostscript-$VERSION.tar.xz
cd ghostscript-$VERSION
## fix pthread_t 0 assignment problem (pthread is a structure on Windows) (version >= 8.64)
#patch -ulbf base/gp_psync.c << EOF
#--- base/gp_psync.c  Thu May  8 21:10:40 2008
#+++ base/gp_psync.c  Mon Mar 30 13:56:21 2009
#@@ -153,3 +153,8 @@
#        return -1;              /* monitors are not movable */
#+#ifdef __MINGW32__
#+    ((gp_pthread_recursive_t *)mona)->self_id.p = NULL;        /* Not valid unless mutex is locked */
#+    ((gp_pthread_recursive_t *)mona)->self_id.x = 0;   /* Not valid unless mutex is locked */
#+#else
#     ((gp_pthread_recursive_t *)mona)->self_id = 0;     /* Not valid unless mutex is locked */
#+#endif
#     scode = pthread_mutex_init(mon, NULL);
#@@ -196,3 +201,8 @@
#     scode = pthread_mutex_unlock(mon);
#+#ifdef __MINGW32__
#+    ((gp_pthread_recursive_t *)mona)->self_id.p = NULL;        /* Not valid unless mutex is locked */
#+    ((gp_pthread_recursive_t *)mona)->self_id.x = 0;   /* Not valid unless mutex is locked */
#+#else
#     ((gp_pthread_recursive_t *)mona)->self_id = 0;     /* Not valid unless mutex is locked */
#+#endif
#     return SEM_ERROR_CODE(scode);
#EOF
# fix missing mswin_popen (version >= 8.71.1)
patch -ulbf base/pipe_.h << EOF
--- base/pipe_.h  2010-07-11 00:02:22 +0200
+++ base/pipe_.h  2010-09-09 10:36:42 +0200
@@ -22 +22 @@
-#ifdef __WIN32__
+#if defined(__WIN32__) && !defined(__MINGW32__)
EOF
# use Windows instead of Unix sources (version >= 9.52)
mv base/gp_unix.c base/gp_unix.c.bak &&
cat base/gp_win32.c base/gp_unix.c
#cat base/gp_mswin.c base/gp_win32.c > base/gp_unix.c
mv base/gp_unifs.c base/gp_unifs.c.bak &&
cat base/gp_wutf8.c base/gp_winfs.c base/gp_ntfs.c > base/gp_unifs.c
mv base/gp_unifn.c base/gp_unifn.c.bak &&
touch base/gp_unifn.c
## fix missing base/gp_unix.c (version >= 9.53.0)
#cp base/gp_win32.c base/gp_unix.c
# don't build included libraries
rm -rf zlib jpeg libpng tiff freetype jbig2dec openjpeg ijs
# fix error: Mixing local libtiff with shared libjpeg not supported
sed -i.bak -e "s/as_fn_error\( .*Mixing local libtiff with shared libjpeg not supported\)/echo \1/" configure
#./autogen
#./autogen.sh --prefix=$INSTALLPREFIX --build=$BUILDPLATFORM --host=$RUNPLATFORM --disable-cups --disable-gtk --without-ijs --without-jasper --without-x --with-drivers=FILES LDFLAGS="-Wl,--enable-auto-import" &&
wl-showstatus configure &&
 #./configure --prefix=$INSTALLPREFIX --build=$BUILDPLATFORM --host=$RUNPLATFORM --disable-cups --disable-gtk --without-ijs --without-jasper --without-x --with-drivers=FILES LDFLAGS="-Wl,--enable-auto-import" &&
 #./configure --prefix=$INSTALLPREFIX --build=$BUILDPLATFORM --host=$RUNPLATFORM --enable-threading --enable-gtk --enable-fontconfig --enable-freetype --enable-openjpeg --with-libtiff --with-system-libtiff --with-jbig2dec --with-libpaper --with-libidn --with-libiconv=native --disable-dbus --without-x --disable-cups --without-ijs --with-drivers=FILES LDFLAGS="-Wl,--enable-auto-import -Wl,--allow-multiple-definition" &&
 #./configure --prefix=$INSTALLPREFIX --build=$BUILDPLATFORM --host=$RUNPLATFORM --enable-threading --enable-gtk --enable-fontconfig --enable-freetype --enable-openjpeg --with-libtiff --with-system-libtiff --with-jbig2dec --with-libpaper --with-libidn --with-libiconv=native --disable-dbus --without-x --disable-cups --without-ijs --without-local-zlib --with-drivers=FILES LDFLAGS="-Wl,--enable-auto-import -Wl,--allow-multiple-definition" &&
 ./configure --prefix=$INSTALLPREFIX --build=$BUILDPLATFORM --host=$RUNPLATFORM --enable-threading --enable-gtk --enable-fontconfig --enable-freetype --enable-openjpeg --with-libtiff --with-system-libtiff --with-jbig2dec --with-libpaper --with-libidn --with-libiconv=native --disable-dbus --without-x --disable-cups --without-ijs --without-local-zlib --with-drivers=FILES --without-tesseract LDFLAGS="-Wl,--enable-auto-import -Wl,--allow-multiple-definition" &&
 ## remove static paths with backslashes from obj/gconfigd.h (version >= 9.52 <= 9.53.3)
 #sed -i.bak -e "s?^\(#define GS_LIB_DEFAULT \).*\$?\1\"\"?; s?^\(#define GS_CACHE_DIR \).*\$?\1\".ghostscript/cache/\"?; s?^\(#define GS_DOCDIR \).*\$?\1\"\"?" obj/gconfigd.h &&
 wl-showstatus build-install &&
 # redefine AUXDIR because aux is a reserved device name in Windows
 make all install AUXDIR=$(pwd)/obj/auxdir &&
 make so soinstall GS=gs GS_SOEXT=dll &&
    echo OK
# wl-makepackage -c -d && wl-install -d $BASENAME-$VERSION && cd .. && wl-showstatus cleanup && rm -rf ghostscript-$VERSION
####See also: gnu-ghostscript



# fix base/gscdef.c (version >= 9.55.0)
patch -ulbf base/gscdef.c << EOF
@@ -72,3 +72,7 @@
 /* Define the default library search path. */
+#ifdef _WIN32
+const char *const gs_lib_default_path = NULL;
+#else
 const char *const gs_lib_default_path = GS_LIB_DEFAULT;
+#endif

EOF
# fix missing base/gp_unix.c (version >= 9.55.0)
#cp -f base/gp_win32.c base/gp_unix.c
touch base/gp_unix.c

 make CCAUX="gcc -Wl,--allow-multiple-definition" &&
 make so soinstall GS=gs GS_SOEXT=dll CCAUX="gcc -Wl,--allow-multiple-definition" &&
    echo OK
