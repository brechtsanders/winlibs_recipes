export NAME="Filament"
export STATUS=
export URL=https://github.com/google/filament
export BASENAME=filament
export DESCRIPTION="Filament is a real-time physically based rendering engine for Android, iOS, Linux, macOS, Windows, and WebGL. It is designed to be as small as possible and as efficient as possible on Android."
export CATEGORY=graphics
export TYPE=library
#export VERSION=1.9.0
#export VERSIONDATE=20200918
#export VERSION=1.9.1
#export VERSIONDATE=20200922
#export VERSION=1.9.2
#export VERSIONDATE=20200929
#export VERSION=1.9.3
#export VERSIONDATE=20201006
#export VERSION=1.9.4
#export VERSIONDATE=20201013
#export VERSION=1.9.5
#export VERSIONDATE=20201020
#export VERSION=1.9.6
#export VERSIONDATE=20201027
#export VERSION=1.9.7
#export VERSIONDATE=20201103
#export VERSION=1.9.8
#export VERSIONDATE=20201110
#export VERSION=1.9.9
#export VERSIONDATE=20201116
#export VERSION=1.9.10
#export VERSIONDATE=20210202
#export VERSION=1.9.11
#export VERSIONDATE=20210209
#export VERSION=1.9.12
#export VERSIONDATE=20210217
#export VERSION=1.9.13
#export VERSIONDATE=20210223
####c++.exe: error: unrecognized command line option '-Wnewline-eof'
####c++.exe: error: unrecognized command line option '-Wgnu-conditional-omitted-operand'
####c++.exe: error: unrecognized command line option '-Wweak-vtables'
####c++.exe: error: unrecognized command line option '-Wclass-varargs'; did you mean '-Wno-varargs'?
####c++.exe: error: unrecognized command line option '-Wover-aligned'
####c++.exe: error: unrecognized command line option '-fstrict-vtable-pointers'
#export VERSION=1.9.14
#export VERSIONDATE=20210302
#export VERSION=1.9.15
#export VERSIONDATE=20210309
#export VERSION=1.9.16
#export VERSIONDATE=20210316
#export VERSION=1.9.17
#export VERSIONDATE=20210323
#export VERSION=1.9.18
#export VERSIONDATE=20210330
#export VERSION=1.9.19
#export VERSIONDATE=20210406
#export VERSION=1.9.20
#export VERSIONDATE=20210413
#export VERSION=1.9.21
#export VERSIONDATE=20210420
#export VERSION=1.9.22
#export VERSIONDATE=20210427
#export VERSION=1.9.23
#export VERSIONDATE=20210504
#export VERSION=1.9.24
#export VERSIONDATE=20210508
#export VERSION=1.9.25
#export VERSIONDATE=20210518
#export VERSION=1.10.0
#export VERSIONDATE=20210525
#export VERSION=1.10.1
#export VERSIONDATE=20210602
####add_library cannot create ALIAS target "SPIRV-Tools" because target "SPIRV-Tools-shared" does not already exist.
####filament/backend/include/private/backend/CommandStream.h:211:65: error: a reinterpret_cast is not a constant expression
#export VERSION=1.10.2
#export VERSIONDATE=20210608
#export VERSION=1.10.3
#export VERSIONDATE=20210615
#export VERSION=1.10.4
#export VERSIONDATE=20210622
#export VERSION=1.10.5
#export VERSIONDATE=20210629
#export VERSION=1.10.6
#export VERSIONDATE=20210708
#export VERSION=1.10.7
#export VERSIONDATE=20210713
#export VERSION=1.11.0
#export VERSIONDATE=20210720
#export VERSION=1.11.1
#export VERSIONDATE=20210727
#export VERSION=1.11.2
#export VERSIONDATE=20210804
#export VERSION=1.12.0
#export VERSIONDATE=20210810
#export VERSION=1.12.1
#export VERSIONDATE=20210824
#export VERSION=1.12.2
#export VERSIONDATE=20210831
#export VERSION=1.12.3
#export VERSIONDATE=20210909
#export VERSION=1.12.4
#export VERSIONDATE=20210914
#export VERSION=1.12.5
#export VERSIONDATE=20210921
#export VERSION=1.12.6
#export VERSIONDATE=20210928
#export VERSION=1.12.7
#export VERSIONDATE=20211005
#export VERSION=1.12.8
#export VERSIONDATE=20211012
#export VERSION=1.12.9
#export VERSIONDATE=20211021
#export VERSION=1.12.10
#export VERSIONDATE=20211026
#export VERSION=1.12.11
#export VERSIONDATE=20211102
#export VERSION=1.13.0
#export VERSIONDATE=20211109
#export VERSION=1.14.0
#export VERSIONDATE=20211116
#export VERSION=1.14.1
#export VERSIONDATE=20211123
#export VERSION=1.14.2
#export VERSIONDATE=20211130
#export VERSION=1.15.0
#export VERSIONDATE=20211207
#export VERSION=1.15.1
#export VERSIONDATE=20211214
#export VERSION=1.15.2
#export VERSIONDATE=20220105
#export VERSION=1.16.0
#export VERSIONDATE=20220111
#export VERSION=1.16.1
#export VERSIONDATE=20220119
#export VERSION=1.17.0
#export VERSIONDATE=20220125
#export VERSION=1.18.0
#export VERSIONDATE=20220209
#export VERSION=1.19.0
#export VERSIONDATE=20220215
#export VERSION=1.20.0
#export VERSIONDATE=20220225
#export VERSION=1.20.1
#export VERSIONDATE=20220303
#export VERSION=1.20.2
#export VERSIONDATE=20220308
#export VERSION=1.20.3
#export VERSIONDATE=20220315
#export VERSION=1.20.4
#export VERSIONDATE=20220322
#export VERSION=1.20.5
#export VERSIONDATE=20220329
#export VERSION=1.21.0
#export VERSIONDATE=20220405
#export VERSION=1.21.1
#export VERSIONDATE=20220414
#export VERSION=1.21.2
#export VERSIONDATE=20220426
#export VERSION=1.21.3
#export VERSIONDATE=20220503
#export VERSION=1.22.0
#export VERSIONDATE=20220510
#export VERSION=1.22.1
#export VERSIONDATE=20220518
#export VERSION=1.22.2
#export VERSIONDATE=20220525
#export VERSION=1.23.0
#export VERSIONDATE=20220602
#export VERSION=1.23.1
#export VERSIONDATE=20220607
#export VERSION=1.23.2
#export VERSIONDATE=20220616
#export VERSION=1.24.0
#export VERSIONDATE=20220702
#export VERSION=1.25.0
#export VERSIONDATE=20220707
#export VERSION=1.25.1
#export VERSIONDATE=20220712
#export VERSION=1.25.2
#export VERSIONDATE=20220719
#export VERSION=1.25.3
#export VERSIONDATE=20220727
#export VERSION=1.25.4
#export VERSIONDATE=20220803
#export VERSION=1.25.5
#export VERSIONDATE=20220817
#export VERSION=1.25.6
#export VERSIONDATE=20220824
#export VERSION=1.26.0
#export VERSIONDATE=20220901
#export VERSION=1.27.0
#export VERSIONDATE=20220914
#export VERSION=1.27.2
#export VERSIONDATE=20220930
#export VERSION=1.28.0
#export VERSIONDATE=20221014
export VERSION=1.28.1
export VERSIONDATE=20221026
wl-showstatus --package-version
export DEPENDANCIES=mman-win32
export OPTIONALDEPENDANCIES=
export BUILDDEPENDANCIES=cmake,ninja
export LICENSEFILE=LICENSE
export LICENSETYPE=Apache
export DOWNLOADURL="https://github.com/google/filament/releases"
export INSTALLPREFIX=`pwd`/inst_$BASENAME-$VERSION
#export DOWNLOADSOURCEURL=https://github.com/google/filament/archive/v$VERSION.tar.gz
export DOWNLOADSOURCEURL=https://github.com/google/filament/archive/refs/tags/v$VERSION.tar.gz
wl-showstatus download
wl-download -v -d $TARBALLDIR/$BASENAME $DOWNLOADSOURCEURL
wl-wait4deps
wl-showstatus extract
tar xfz $TARBALLDIR/$BASENAME/v$VERSION.tar.gz
cd $BASENAME-$VERSION
# fix libs/utils/src/ashmem.cpp (version >= 1.10.2)
patch -ulbf libs/utils/src/ashmem.cpp << EOF
@@ -153,3 +153,3 @@
     snprintf(template_path, sizeof(template_path), "%s/filament-ashmem-%lu-XXXXXXXXX",
-            Path::getTemporaryDirectory().c_str(), GetCurrentProcessId());
+            Path::getTemporaryDirectory().c_str(), ::GetCurrentProcessId());
     const char* tmpPath = _mktemp(template_path);
EOF
# fix CMakeLists.txt
#sed -i.bak -e "s/FATAL_ERROR \(\"Detected .* compiler .* is unsupported\)/\1/; s/if (WIN32)/if (MSVC)/; s/\(if (CCACHE_PROGRAM\)/& AND NOT MINGW/" CMakeLists.txt
# fix CMakeLists.txt (version >= 1.9.0)
patch -ulbf CMakeLists.txt << EOF
@@ -49,2 +49,3 @@
 # ==================================================================================================
+if (NOT MINGW)
 find_program(CCACHE_PROGRAM ccache)
@@ -72,2 +73,3 @@
 endif()
+endif()

@@ -102,3 +104,3 @@

-if (WIN32)
+if (MSVC)
     # Link statically against c/c++ lib to avoid missing redistriburable such as
@@ -178,3 +180,3 @@
 elseif (NOT MSVC)
-    message(FATAL_ERROR "Detected C compiler \${CMAKE_C_COMPILER_ID} is unsupported")
+    message("Detected C compiler \${CMAKE_C_COMPILER_ID} is unsupported")
 endif()
@@ -186,3 +188,3 @@
 elseif (NOT MSVC)
-    message(FATAL_ERROR "Detected CXX compiler \${CMAKE_CXX_COMPILER_ID} is unsupported")
+    message("Detected CXX compiler \${CMAKE_CXX_COMPILER_ID} is unsupported")
 endif()
@@ -214,3 +216,3 @@
 set(CXX_STANDARD "-std=c++17")
-if (WIN32)
+if (MSVC)
     set(CXX_STANDARD "/std:c++17")
@@ -449,3 +451,3 @@
 set(COMBINE_SCRIPT "\${CMAKE_CURRENT_SOURCE_DIR}/build/linux/combine-static-libs.sh")
-if (WIN32)
+if (MSVC)
     set(COMBINE_SCRIPT "\${CMAKE_CURRENT_SOURCE_DIR}/build/windows/combine-static-libs.bat")
@@ -525,3 +527,3 @@
     # the equivalent of .incbin, so on Windows we'll just tell resgen to output a C file.
-    if (WEBGL OR WIN32 OR ANDROID_ON_WINDOWS)
+    if (WEBGL OR MSVC OR ANDROID_ON_WINDOWS)
         set(RESGEN_OUTPUTS "\${OUTPUTS};\${ARCHIVE_DIR}/\${ARCHIVE_NAME}.c" PARENT_SCOPE)
EOF
# fix filament/CMakeLists.txt (version >= 1.9.0)
patch -ulbf filament/CMakeLists.txt << EOF
@@ -384,3 +384,3 @@
     set(FILAMENT_WARNINGS /W3)
-else()
+else(NOT MINGW)
     set(FILAMENT_WARNINGS
EOF
# fix filament/backend/CMakeLists.txt (version >= 1.9.0)
patch -ulbf filament/backend/CMakeLists.txt << EOF
@@ -256,3 +256,3 @@
     set(FILAMENT_WARNINGS /W3)
-else()
+else(NOT MINGW)
     set(FILAMENT_WARNINGS
EOF
# remove invalid compiler flags (version >= 1.9.6)
sed -i.bak -e "s/-Wnewline-eof\|-Wgnu-conditional-omitted-operand\|-Wweak-vtables\|-Wclass-varargs\|-Wover-aligned\|-fstrict-vtable-pointers//g" filament/CMakeLists.txt filament/backend/CMakeLists.txt
# don't abort on warnings (version >= 1.9.15)
sed -i.bak2 -e "s/-Wall -Wextra//" filament/CMakeLists.txt filament/backend/CMakeLists.txt
mkdir -p build_static build_shared &&
 wl-showstatus configure &&
 #cmake.exe -Wno-dev -GNinja -DCMAKE_INSTALL_PREFIX:PATH=$INSTALLPREFIX -DCMAKE_BUILD_TYPE:STRING=Release -DBUILD_SHARED_LIBS:BOOL=OFF -DFILAMENT_ENABLE_JAVA:BOOL=OFF -DFILAMENT_SKIP_SAMPLES:BOOL=ON -DPYTHON_EXECUTABLE:FILEPATH=$PYDIR/python.exe -DCMAKE_C_LINK_FLAGS:STRING="-DWIN32 -I$MINGWPREFIX/include/mman-win32" -DCMAKE_CXX_LINK_FLAGS:STRING="-DWIN32 -I$MINGWPREFIX/include/mman-win32" -S. -Bbuild_static &&
 #cmake.exe -Wno-dev -GNinja -DCMAKE_INSTALL_PREFIX:PATH=$INSTALLPREFIX -DCMAKE_BUILD_TYPE:STRING=Release -DBUILD_SHARED_LIBS:BOOL=OFF -DBUILD_SHARED_LIBS:BOOL=OFF -DFILAMENT_ENABLE_JAVA:BOOL=OFF -DFILAMENT_SKIP_SAMPLES:BOOL=ON -DPYTHON_EXECUTABLE:FILEPATH=$PYDIR/python.exe -DCMAKE_C_LINK_FLAGS:STRING="-DWIN32 -I$MINGWPREFIX/include/mman-win32" -DCMAKE_CXX_LINK_FLAGS:STRING="-DWIN32 -I$MINGWPREFIX/include/mman-win32" -S. -Bbuild_static &&
 cmake.exe -Wno-dev -GNinja -DCMAKE_INSTALL_PREFIX:PATH=$INSTALLPREFIX -DCMAKE_BUILD_TYPE:STRING=Release -DBUILD_SHARED_LIBS:BOOL=OFF -DBUILD_SHARED_LIBS:BOOL=OFF -DFILAMENT_ENABLE_JAVA:BOOL=OFF -DFILAMENT_SKIP_SAMPLES:BOOL=ON -DPYTHON_EXECUTABLE:FILEPATH=$PYDIR/python.exe -DCMAKE_C_FLAGS:STRING="-DWIN32 -I$MINGWPREFIX/include/mman-win32" -DCMAKE_CXX_FLAGS:STRING="-DWIN32 -I$MINGWPREFIX/include/mman-win32" -S. -Bbuild_static &&
 wl-showstatus configure &&
 #cmake.exe -Wno-dev -GNinja -DCMAKE_INSTALL_PREFIX:PATH=$INSTALLPREFIX -DCMAKE_BUILD_TYPE:STRING=Release -DBUILD_SHARED_LIBS:BOOL=ON -DFILAMENT_ENABLE_JAVA:BOOL=OFF -DFILAMENT_SKIP_SAMPLES:BOOL=ON -DPYTHON_EXECUTABLE:FILEPATH=$PYDIR/python.exe -DCMAKE_C_LINK_FLAGS:STRING="-DWIN32 -I$MINGWPREFIX/include/mman-win32" -DCMAKE_CXX_LINK_FLAGS:STRING="-DWIN32 -I$MINGWPREFIX/include/mman-win32" -S. -Bbuild_shared &&
 #cmake.exe -Wno-dev -GNinja -DCMAKE_INSTALL_PREFIX:PATH=$INSTALLPREFIX -DCMAKE_BUILD_TYPE:STRING=Release -DBUILD_SHARED_LIBS:BOOL=ON -DBUILD_SHARED_LIBS:BOOL=OFF -DFILAMENT_ENABLE_JAVA:BOOL=OFF -DFILAMENT_SKIP_SAMPLES:BOOL=ON -DPYTHON_EXECUTABLE:FILEPATH=$PYDIR/python.exe -DCMAKE_C_LINK_FLAGS:STRING="-DWIN32 -I$MINGWPREFIX/include/mman-win32" -DCMAKE_CXX_LINK_FLAGS:STRING="-DWIN32 -I$MINGWPREFIX/include/mman-win32" -S. -Bbuild_shared &&
 cmake.exe -Wno-dev -GNinja -DCMAKE_INSTALL_PREFIX:PATH=$INSTALLPREFIX -DCMAKE_BUILD_TYPE:STRING=Release -DBUILD_SHARED_LIBS:BOOL=ON -DBUILD_SHARED_LIBS:BOOL=OFF -DFILAMENT_ENABLE_JAVA:BOOL=OFF -DFILAMENT_SKIP_SAMPLES:BOOL=ON -DPYTHON_EXECUTABLE:FILEPATH=$PYDIR/python.exe -DCMAKE_C_FLAGS:STRING="-DWIN32 -I$MINGWPREFIX/include/mman-win32" -DCCMAKE_CXX_FLAGS:STRING="-DWIN32 -I$MINGWPREFIX/include/mman-win32" -S. -Bbuild_shared &&
 ## fix execution of Python scripts
 #sed -i.bak -e "s?\(COMMAND\|POST_BUILD\)\( *=.*\&\& *\)\([^ ]*\)\(\.py\|glib-mkenums\|g-ir-scanner\)\( \)?\1\2$(echo $PYDIR/python.exe|sed -e "s?^/\([a-zA-Z]\)/?\1:\\\\\\\\?; s?/?\\\\\\\\?g") \3\4\5?" build_*/build.ninja &&
 #wl-showstatus build &&
 #ninja -Cbuild_static &&
 #wl-showstatus build &&
 #ninja -Cbuild_shared &&
 wl-showstatus build-install &&
 ninja -Cbuild_static install/strip &&
 wl-showstatus build-install &&
 ninja -Cbuild_shared install/strip &&
    echo OK
# wl-makepackage -c -d && wl-install -d $BASENAME-$VERSION && cd .. && wl-showstatus cleanup && rm -rf $BASENAME-$VERSION



